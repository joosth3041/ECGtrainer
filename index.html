<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC ECG Trainer Pro v2.0</title>
    <style>
        /* ==================== RESET & BASE ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0f1a;
            --bg-card: #111827;
            --bg-elevated: #1a2332;
            --bg-hover: #1f2937;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #374151;
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --purple: #8b5cf6;
            --ecg-green: #22c55e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* ==================== SCROLLBAR ==================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* ==================== LAYOUT ==================== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1));
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--success), var(--primary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success);
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .sidebar-nav {
            flex: 1;
            padding: 0.75rem;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 1.25rem;
        }

        .nav-section-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            padding: 0.5rem 0.75rem;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.7rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: all 0.15s ease;
            margin-bottom: 2px;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            font-weight: 500;
        }

        .nav-item-icon {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .nav-item-badge {
            margin-left: auto;
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .nav-item-badge.red { background: var(--danger); color: white; }
        .nav-item-badge.green { background: var(--success); color: white; }
        .nav-item-badge.yellow { background: var(--warning); color: black; }
        .nav-item-badge.blue { background: var(--primary); color: white; }

        .sidebar-stats {
            padding: 1rem;
            border-top: 1px solid var(--border);
            background: var(--bg-elevated);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            font-size: 0.85rem;
        }

        .stat-label { color: var(--text-muted); }
        .stat-value { font-weight: 600; color: var(--success); }

        /* ==================== MAIN CONTENT ==================== */
        .main-content {
            flex: 1;
            margin-left: 260px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-bar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0.875rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .top-bar-title {
            font-size: 1.15rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .top-bar-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .content-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* ==================== SECTIONS ==================== */
        .section {
            display: none;
            animation: fadeIn 0.25s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== CARDS ==================== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1.25rem;
            overflow: hidden;
        }

        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-elevated);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.25rem;
        }

        .card-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            background: var(--bg-elevated);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.6rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #16a34a; }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        
        .btn-warning { background: var(--warning); color: black; }
        .btn-warning:hover { background: #d97706; }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-sm { padding: 0.4rem 0.875rem; font-size: 0.8rem; }
        .btn-lg { padding: 0.875rem 1.75rem; font-size: 1rem; }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* ==================== BADGES ==================== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-easy { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .badge-medium { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .badge-hard { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge-critical { background: var(--danger); color: white; }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--primary); }
        .badge-success { background: rgba(34, 197, 94, 0.15); color: var(--success); }

        /* ==================== GRIDS ==================== */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        @media (max-width: 1200px) {
            .grid-4 { grid-template-columns: repeat(3, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 900px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: 1fr; }
            .grid-2 { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }

        /* ==================== ECG MONITOR ==================== */
        .ecg-monitor {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #222;
        }

        .ecg-monitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 1rem;
            background: linear-gradient(180deg, #1a1a1a, #111);
            border-bottom: 1px solid #333;
        }

        .ecg-monitor-title {
            color: var(--success);
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ecg-monitor-vitals {
            display: flex;
            gap: 1.5rem;
        }

        .vital-display {
            text-align: right;
        }

        .vital-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .vital-value {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: 'SF Mono', 'Consolas', monospace;
            line-height: 1.2;
        }

        .vital-value.green { color: var(--success); }
        .vital-value.red { color: var(--danger); }
        .vital-value.blue { color: var(--info); }
        .vital-value.yellow { color: var(--warning); }
        .vital-value.critical { color: var(--danger); animation: blink 1s infinite; }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }

        .ecg-canvas-wrapper {
            position: relative;
            padding: 0.5rem;
        }

        .ecg-canvas {
            width: 100%;
            height: 200px;
            display: block;
        }

        .ecg-canvas.large {
            height: 280px;
        }

        .ecg-lead-label {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: var(--success);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .ecg-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #0a0a0a;
            border-top: 1px solid #222;
        }

        .ecg-setting {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .ecg-setting span {
            color: var(--text-secondary);
            margin-left: 0.25rem;
        }

        /* ==================== QUIZ OPTIONS ==================== */
        .quiz-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.875rem;
        }

        @media (max-width: 700px) {
            .quiz-options {
                grid-template-columns: 1fr;
            }
        }

        .quiz-option {
            display: flex;
            align-items: flex-start;
            gap: 0.875rem;
            padding: 1rem;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .quiz-option:hover:not(.disabled) {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.08);
            transform: translateY(-2px);
        }

        .quiz-option.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.12);
        }

        .quiz-option.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.12);
        }

        .quiz-option.incorrect {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.12);
        }

        .quiz-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .quiz-option-key {
            width: 28px;
            height: 28px;
            background: var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .quiz-option.selected .quiz-option-key {
            background: var(--primary);
            color: white;
        }

        .quiz-option.correct .quiz-option-key {
            background: var(--success);
            color: white;
        }

        .quiz-option.incorrect .quiz-option-key {
            background: var(--danger);
            color: white;
        }

        .quiz-option-content {
            flex: 1;
            min-width: 0;
        }

        .quiz-option-title {
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .quiz-option-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ==================== FEEDBACK PANELS ==================== */
        .feedback-panel {
            padding: 1.25rem;
            border-radius: 10px;
            margin-top: 1.25rem;
            display: none;
        }

        .feedback-panel.show {
            display: block;
            animation: slideIn 0.25s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feedback-panel.correct {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .feedback-panel.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .feedback-panel.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            margin-bottom: 0.875rem;
        }

        .feedback-icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .feedback-panel.correct .feedback-icon { background: var(--success); }
        .feedback-panel.incorrect .feedback-icon { background: var(--danger); }
        .feedback-panel.info .feedback-icon { background: var(--primary); }

        .feedback-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .feedback-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* ==================== PROGRESS BAR ==================== */
        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* ==================== TOPIC CARDS ==================== */
        .topic-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .topic-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .topic-card-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            margin-bottom: 0.875rem;
        }

        .topic-card-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
        }

        .topic-card-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .topic-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.875rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ==================== QUICK ACTIONS ==================== */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .quick-action {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-action:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .quick-action-icon {
            font-size: 2rem;
            margin-bottom: 0.625rem;
        }

        .quick-action-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .quick-action-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ==================== INFO BOXES ==================== */
        .info-box {
            display: flex;
            gap: 0.875rem;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .info-box.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.25);
        }

        .info-box.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.25);
        }

        .info-box.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.25);
        }

        .info-box.danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.25);
        }

        .info-box-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .info-box-content h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .info-box-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ==================== TABLES ==================== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-elevated);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .data-table tbody tr:hover {
            background: var(--bg-hover);
        }

        /* ==================== ACCORDION ==================== */
        .accordion {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .accordion-item {
            border-bottom: 1px solid var(--border);
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-header {
            padding: 1rem 1.25rem;
            background: var(--bg-elevated);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s ease;
        }

        .accordion-header:hover {
            background: var(--bg-hover);
        }

        .accordion-header h4 {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .accordion-icon {
            transition: transform 0.2s ease;
            color: var(--text-muted);
        }

        .accordion-item.open .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-item.open .accordion-body {
            max-height: 1000px;
        }

        .accordion-content {
            padding: 1rem 1.25rem;
        }

        /* ==================== TABS ==================== */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.25rem;
            overflow-x: auto;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ==================== VITALS GRID ==================== */
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
        }

        .vital-card {
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 0.875rem;
            text-align: center;
        }

        .vital-card-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .vital-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'SF Mono', 'Consolas', monospace;
        }

        .vital-card-unit {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* ==================== ALGORITHM BOX ==================== */
        .algorithm-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            margin: 1rem 0;
        }

        .algorithm-box.critical {
            border-left: 4px solid var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }

        .algorithm-box.warning {
            border-left: 4px solid var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }

        .algorithm-box.success {
            border-left: 4px solid var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .algorithm-box.info {
            border-left: 4px solid var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }

        .algorithm-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .algorithm-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .algorithm-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .algorithm-step-num {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .algorithm-step.critical {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .algorithm-step.critical .algorithm-step-num {
            background: var(--danger);
        }

        /* ==================== MODAL ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalIn 0.2s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-elevated);
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.15s ease;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: var(--bg-elevated);
        }

        /* ==================== CASE DISPLAY ==================== */
        .case-header {
            display: flex;
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .case-avatar {
            width: 70px;
            height: 70px;
            background: var(--bg-elevated);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            flex-shrink: 0;
        }

        .case-info h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .case-info p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* ==================== EMERGENCY BANNER ==================== */
        .emergency-banner {
            background: linear-gradient(90deg, var(--danger), #b91c1c);
            color: white;
            padding: 0.875rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            border-radius: 8px;
        }

        .emergency-banner .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ==================== RHYTHM SELECTOR ==================== */
        .rhythm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .rhythm-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-primary);
            text-align: left;
        }

        .rhythm-btn:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.08);
        }

        .rhythm-btn.active {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.15);
        }

        .rhythm-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .rhythm-indicator.green { background: var(--success); }
        .rhythm-indicator.yellow { background: var(--warning); }
        .rhythm-indicator.red { background: var(--danger); }
        .rhythm-indicator.gray { background: #666; }

        /* ==================== SPLIT VIEW ==================== */
        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .split-view {
                grid-template-columns: 1fr;
            }
        }

        /* ==================== LISTS ==================== */
        .styled-list {
            list-style: none;
            padding: 0;
        }

        .styled-list li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .styled-list li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }

        /* ==================== SCORE CIRCLE ==================== */
        .score-display {
            text-align: center;
            padding: 2rem;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(
                var(--success) calc(var(--score, 0) * 1%),
                var(--border) calc(var(--score, 0) * 1%)
            );
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .score-inner {
            width: 120px;
            height: 120px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .score-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .score-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* ==================== LOADING SPINNER ==================== */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== UTILITIES ==================== */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-primary { color: var(--primary); }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }

        .hidden { display: none !important; }
    </style>

    <!-- ==================== DEEL 6: COMPLETE CSS STYLING ==================== -->
<style>
/* ==================== CSS VARIABLES & RESET ==================== */
:root {
    /* Colors - Dark Medical Theme */
    --bg-primary: #0a0f1a;
    --bg-secondary: #111827;
    --bg-elevated: #1f2937;
    --bg-hover: #374151;
    
    --text-primary: #f9fafb;
    --text-secondary: #d1d5db;
    --text-muted: #9ca3af;
    
    --border: #374151;
    --border-light: #4b5563;
    
    /* Accent Colors */
    --primary: #3b82f6;
    --primary-hover: #2563eb;
    --primary-light: rgba(59, 130, 246, 0.1);
    
    --success: #22c55e;
    --success-hover: #16a34a;
    --success-light: rgba(34, 197, 94, 0.1);
    
    --danger: #ef4444;
    --danger-hover: #dc2626;
    --danger-light: rgba(239, 68, 68, 0.1);
    
    --warning: #f59e0b;
    --warning-hover: #d97706;
    --warning-light: rgba(245, 158, 11, 0.1);
    
    --info: #06b6d4;
    --info-light: rgba(6, 182, 212, 0.1);
    
    --purple: #8b5cf6;
    --purple-light: rgba(139, 92, 246, 0.1);
    
    /* ECG Colors */
    --ecg-green: #22c55e;
    --ecg-grid: #1a3d1a;
    --ecg-grid-minor: #0d1f0d;
    --ecg-bg: #000000;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
    --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.3);
    
    /* Spacing */
    --sidebar-width: 260px;
    --header-height: 60px;
    
    /* Transitions */
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 350ms ease;
    
    /* Border Radius */
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --radius-xl: 24px;
}

/* Reset */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    font-size: 16px;
    scroll-behavior: smooth;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
}

/* ==================== TYPOGRAPHY ==================== */
h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
    line-height: 1.3;
    color: var(--text-primary);
}

h1 { font-size: 2rem; }
h2 { font-size: 1.5rem; }
h3 { font-size: 1.25rem; }
h4 { font-size: 1.1rem; }

p { margin-bottom: 0.75rem; }

a {
    color: var(--primary);
    text-decoration: none;
    transition: color var(--transition-fast);
}

a:hover { color: var(--primary-hover); }

.text-primary { color: var(--primary) !important; }
.text-success { color: var(--success) !important; }
.text-danger { color: var(--danger) !important; }
.text-warning { color: var(--warning) !important; }
.text-info { color: var(--info) !important; }
.text-muted { color: var(--text-muted) !important; }
.text-center { text-align: center; }

/* ==================== LAYOUT ==================== */
.app-container {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: var(--sidebar-width);
    background: var(--bg-secondary);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 100;
    transition: transform var(--transition-normal);
}

.sidebar-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.sidebar-logo {
    font-size: 2rem;
    animation: pulse-heart 1.5s ease-in-out infinite;
}

@keyframes pulse-heart {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.sidebar-title h1 {
    font-size: 1.1rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary), var(--purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.sidebar-title span {
    font-size: 0.7rem;
    color: var(--text-muted);
}

/* Sidebar Stats */
.sidebar-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.stat-item {
    text-align: center;
    padding: 0.5rem;
    background: var(--bg-elevated);
    border-radius: var(--radius-sm);
}

.stat-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary);
}

.stat-label {
    font-size: 0.65rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Sidebar Navigation */
.sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
}

.nav-section {
    margin-bottom: 1.5rem;
}

.nav-section-title {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.25rem;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: 2px;
    font-size: 0.9rem;
}

.nav-item:hover {
    background: var(--bg-hover);
}

.nav-item.active {
    background: var(--primary-light);
    color: var(--primary);
    font-weight: 500;
}

.nav-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    width: 3px;
    height: 24px;
    background: var(--primary);
    border-radius: 0 3px 3px 0;
}

.nav-icon {
    font-size: 1.1rem;
    width: 24px;
    text-align: center;
}

/* Main Content */
.main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.content-header {
    padding: 1.25rem 2rem;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 50;
}

.content-header h2 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.content-area {
    flex: 1;
    padding: 1.5rem 2rem;
    max-width: 1600px;
}

/* ==================== CARDS ==================== */
.card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-normal);
}

.card:hover {
    border-color: var(--border-light);
}

.card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-body {
    padding: 1.25rem;
}

.card-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--border);
    background: var(--bg-elevated);
}

/* ==================== GRIDS ==================== */
.grid-2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

.grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.split-view {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 1200px) {
    .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .split-view { grid-template-columns: 1fr; }
}

@media (max-width: 900px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
}

/* ==================== BUTTONS ==================== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    font-size: 0.9rem;
    font-weight: 500;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
    white-space: nowrap;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover:not(:disabled) {
    background: var(--success-hover);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background: var(--danger-hover);
}

.btn-warning {
    background: var(--warning);
    color: #000;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-primary);
}

.btn-outline:hover:not(:disabled) {
    background: var(--bg-hover);
    border-color: var(--border-light);
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
}

.btn-lg {
    padding: 0.875rem 1.75rem;
    font-size: 1rem;
}

.btn-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

/* ==================== BADGES ==================== */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 100px;
    text-transform: capitalize;
}

.badge-easy {
    background: var(--success-light);
    color: var(--success);
}

.badge-medium {
    background: var(--warning-light);
    color: var(--warning);
}

.badge-hard {
    background: var(--danger-light);
    color: var(--danger);
}

.badge-info {
    background: var(--info-light);
    color: var(--info);
}

.badge-primary {
    background: var(--primary-light);
    color: var(--primary);
}

.badge-critical {
    background: var(--danger);
    color: white;
    animation: pulse-badge 1.5s ease-in-out infinite;
}

@keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* ==================== ECG MONITOR ==================== */
.ecg-monitor {
    background: var(--ecg-bg);
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 2px solid #1a1a1a;
}

.ecg-monitor-header {
    background: linear-gradient(180deg, #1a1a1a, #0d0d0d);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #333;
}

.ecg-monitor-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    color: #fff;
}

.ecg-monitor-vitals {
    display: flex;
    gap: 1.5rem;
}

.vital-display {
    text-align: center;
}

.vital-label {
    font-size: 0.65rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.vital-value {
    font-size: 1.5rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
}

.vital-value.green { color: var(--ecg-green); }
.vital-value.yellow { color: var(--warning); }
.vital-value.red, .vital-value.critical { color: var(--danger); }
.vital-value.blue { color: var(--info); }

.ecg-canvas-wrapper {
    position: relative;
    background: var(--ecg-bg);
}

.ecg-canvas {
    width: 100%;
    height: 200px;
    display: block;
}

.ecg-canvas.large {
    height: 280px;
}

.ecg-lead-label {
    position: absolute;
    top: 10px;
    left: 15px;
    background: rgba(0, 0, 0, 0.7);
    color: var(--ecg-green);
    padding: 4px 10px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    font-weight: bold;
}

.ecg-controls {
    background: #111;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #333;
}

.ecg-setting {
    font-size: 0.8rem;
    color: #888;
}

.ecg-setting span {
    color: var(--ecg-green);
    font-weight: 600;
}

/* Pulse Animation */
.pulse {
    display: inline-block;
    color: var(--danger);
    animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.95); }
}

/* ==================== VITALS GRID ==================== */
.vitals-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.vital-card {
    background: var(--bg-elevated);
    padding: 1rem;
    border-radius: var(--radius-md);
    text-align: center;
    border: 1px solid var(--border);
}

.vital-card-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.vital-card-value {
    font-size: 1.5rem;
    font-weight: 700;
}

@media (max-width: 768px) {
    .vitals-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* ==================== QUICK ACTIONS ==================== */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
}

.quick-action {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 1.25rem;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.quick-action:hover {
    background: var(--bg-hover);
    border-color: var(--primary);
    transform: translateY(-2px);
}

.quick-action-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.quick-action-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.quick-action-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* ==================== TOPIC/RHYTHM CARDS ==================== */
.topic-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.topic-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.topic-card-icon {
    font-size: 2rem;
    margin-bottom: 0.75rem;
}

.topic-card-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.topic-card-desc {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
}

.topic-card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* Rhythm Buttons Grid */
.rhythm-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.rhythm-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.875rem;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.rhythm-btn:hover {
    background: var(--bg-hover);
    border-color: var(--primary);
}

.rhythm-btn.active {
    background: var(--primary-light);
    border-color: var(--primary);
    color: var(--primary);
}

.rhythm-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.rhythm-indicator.green { background: var(--success); }
.rhythm-indicator.yellow { background: var(--warning); }
.rhythm-indicator.red { background: var(--danger); }

/* ==================== QUIZ COMPONENTS ==================== */
.quiz-options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.quiz-option {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: var(--bg-elevated);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.quiz-option:hover:not(.disabled) {
    border-color: var(--primary);
    background: var(--primary-light);
}

.quiz-option.selected {
    border-color: var(--primary);
    background: var(--primary-light);
}

.quiz-option.correct {
    border-color: var(--success);
    background: var(--success-light);
}

.quiz-option.incorrect {
    border-color: var(--danger);
    background: var(--danger-light);
}

.quiz-option.disabled {
    cursor: default;
    opacity: 0.8;
}

.quiz-option-key {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-hover);
    border-radius: var(--radius-sm);
    font-weight: 700;
    font-size: 0.9rem;
}

.quiz-option.correct .quiz-option-key {
    background: var(--success);
    color: white;
}

.quiz-option.incorrect .quiz-option-key {
    background: var(--danger);
    color: white;
}

.quiz-option-content {
    flex: 1;
}

.quiz-option-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.quiz-option-desc {
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* Feedback Panel */
.feedback-panel {
    display: none;
    margin-top: 1.5rem;
    padding: 1.25rem;
    border-radius: var(--radius-md);
    animation: slideIn 0.3s ease-out;
}

.feedback-panel.show {
    display: block;
}

.feedback-panel.correct {
    background: var(--success-light);
    border: 1px solid var(--success);
}

.feedback-panel.incorrect {
    background: var(--danger-light);
    border: 1px solid var(--danger);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.feedback-header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.feedback-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 1.5rem;
    font-weight: 700;
}

.feedback-panel.correct .feedback-icon {
    background: var(--success);
    color: white;
}

.feedback-panel.incorrect .feedback-icon {
    background: var(--danger);
    color: white;
}

.feedback-title {
    font-size: 1.1rem;
    font-weight: 700;
}

.feedback-subtitle {
    color: var(--text-muted);
    font-size: 0.9rem;
}

/* Score Display */
.score-display {
    text-align: center;
    padding: 2rem;
}

.score-circle {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: conic-gradient(var(--primary) calc(var(--score) * 1%), var(--bg-elevated) 0);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    position: relative;
}

.score-circle::before {
    content: '';
    position: absolute;
    width: 120px;
    height: 120px;
    background: var(--bg-secondary);
    border-radius: 50%;
}

.score-inner {
    position: relative;
    z-index: 1;
}

.score-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
}

.score-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
}

/* Progress Bar */
.progress-bar {
    height: 10px;
    background: var(--bg-elevated);
    border-radius: 100px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--purple));
    border-radius: 100px;
    transition: width var(--transition-normal);
}

.progress-fill.warning {
    background: linear-gradient(90deg, var(--warning), var(--danger));
}

.progress-fill.danger {
    background: var(--danger);
}

/* ==================== TABLES ==================== */
.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 0.875rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.data-table th {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--bg-elevated);
}

.data-table tbody tr:hover {
    background: var(--bg-elevated);
}

/* ==================== LISTS ==================== */
.styled-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.styled-list li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.5rem;
}

.styled-list li::before {
    content: '•';
    position: absolute;
    left: 0;
    color: var(--primary);
    font-weight: bold;
}

/* ==================== INFO BOXES ==================== */
.info-box {
    display: flex;
    gap: 1rem;
    padding: 1rem 1.25rem;
    border-radius: var(--radius-md);
    border: 1px solid;
}

.info-box.info {
    background: var(--info-light);
    border-color: var(--info);
}

.info-box.success {
    background: var(--success-light);
    border-color: var(--success);
}

.info-box.warning {
    background: var(--warning-light);
    border-color: var(--warning);
}

.info-box.danger {
    background: var(--danger-light);
    border-color: var(--danger);
}

.info-box-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.info-box-content h4 {
    margin-bottom: 0.25rem;
    font-size: 0.95rem;
}

.info-box-content p {
    font-size: 0.9rem;
    margin: 0;
}

/* ==================== ALGORITHM BOXES ==================== */
.algorithm-box {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 1.25rem;
    border-left: 4px solid var(--border);
}

.algorithm-box.info { border-left-color: var(--info); }
.algorithm-box.success { border-left-color: var(--success); }
.algorithm-box.warning { border-left-color: var(--warning); }
.algorithm-box.critical { border-left-color: var(--danger); background: var(--danger-light); }

.algorithm-title {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.algorithm-steps {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.algorithm-step {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
}

.algorithm-step.critical {
    background: var(--danger-light);
    border: 1px solid var(--danger);
}

.algorithm-step-num {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.85rem;
    flex-shrink: 0;
}

.algorithm-step.critical .algorithm-step-num {
    background: var(--danger);
}

/* ==================== ACCORDIONS ==================== */
.accordion-item {
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    background: var(--bg-elevated);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.accordion-header:hover {
    background: var(--bg-hover);
}

.accordion-header h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
}

.accordion-icon {
    transition: transform var(--transition-fast);
    font-size: 0.8rem;
}

.accordion-item.open .accordion-icon {
    transform: rotate(180deg);
}

.accordion-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height var(--transition-normal);
}

.accordion-item.open .accordion-body {
    max-height: 2000px;
}

.accordion-content {
    padding: 1.25rem;
    border-top: 1px solid var(--border);
}

/* ==================== TABS ==================== */
.tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.5rem;
    flex-wrap: wrap;
}

.tab {
    padding: 0.625rem 1rem;
    background: transparent;
    border: 1px solid transparent;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-muted);
    transition: all var(--transition-fast);
}

.tab:hover {
    color: var(--text-primary);
    background: var(--bg-elevated);
}

.tab.active {
    background: var(--primary-light);
    color: var(--primary);
    border-color: var(--primary);
    font-weight: 500;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* ==================== CLINICAL CASE ==================== */
.case-header {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.case-avatar {
    width: 64px;
    height: 64px;
    background: var(--bg-elevated);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    border: 2px solid var(--border);
}

.case-info h3 {
    margin-bottom: 0.25rem;
}

.case-info p {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin: 0;
}

/* ==================== EMERGENCY BANNER ==================== */
.emergency-banner {
    background: linear-gradient(90deg, var(--danger), var(--warning));
    color: white;
    padding: 0.875rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    border-radius: var(--radius-md);
}

/* ==================== SETTINGS ==================== */
.settings-group {
    background: var(--bg-elevated);
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--border);
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
}

.setting-item:last-child {
    border-bottom: none;
}

.setting-name {
    font-weight: 500;
    margin-bottom: 0.125rem;
}

.setting-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.setting-item select {
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    min-width: 120px;
}

/* ==================== ACHIEVEMENTS ==================== */
.achievement-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 1.25rem;
    text-align: center;
    transition: all var(--transition-normal);
}

.achievement-card.unlocked {
    border-color: var(--warning);
    background: var(--warning-light);
}

.achievement-card.locked {
    opacity: 0.6;
}

.achievement-card-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.achievement-card-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.achievement-card-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
}

.achievement-card-reward {
    font-size: 0.85rem;
    color: var(--primary);
    font-weight: 600;
}

/* Achievement Notification */
.achievement-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--bg-secondary);
    border: 2px solid var(--warning);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    display: flex;
    gap: 1rem;
    align-items: center;
    z-index: 9999;
    box-shadow: var(--shadow-lg);
    transform: translateX(120%);
    transition: transform var(--transition-normal);
    max-width: 350px;
}

.achievement-notification.show {
    transform: translateX(0);
}

.achievement-notification .achievement-icon {
    font-size: 2.5rem;
}

.achievement-notification .achievement-title {
    font-size: 0.75rem;
    color: var(--warning);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.achievement-notification .achievement-name {
    font-weight: 700;
    font-size: 1.1rem;
}

.achievement-notification .achievement-desc {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.achievement-notification .achievement-reward {
    font-size: 0.9rem;
    color: var(--primary);
    font-weight: 600;
    margin-top: 0.25rem;
}

/* ==================== MODAL ==================== */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
    padding: 1rem;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: scale(0.9);
    transition: transform var(--transition-normal);
}

.modal-overlay.show .modal {
    transform: scale(1);
}

.modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 1.2rem;
    font-weight: 600;
}

.modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-elevated);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    color: var(--text-muted);
    font-size: 1.25rem;
    transition: all var(--transition-fast);
}

.modal-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}

/* ==================== UTILITIES ==================== */
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }

.hidden { display: none !important; }

/* ==================== RESPONSIVE ==================== */
@media (max-width: 1024px) {
    .sidebar {
        transform: translateX(-100%);
    }
    
    .sidebar.open {
        transform: translateX(0);
    }
    
    .main-content {
        margin-left: 0;
    }
    
    .content-area {
        padding: 1rem;
    }
    
    .ecg-canvas.large {
        height: 200px;
    }
}

@media (max-width: 768px) {
    .content-header {
        padding: 1rem;
    }
    
    .vitals-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .quick-actions {
        grid-template-columns: 1fr 1fr;
    }
    
    .grid-3 {
        grid-template-columns: 1fr;
    }
    
    .modal {
        max-height: 100vh;
        border-radius: 0;
    }
    
    .achievement-notification {
        left: 10px;
        right: 10px;
        max-width: none;
    }
}

@media (max-width: 480px) {
    html {
        font-size: 14px;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
    }
}

/* ==================== PRINT STYLES ==================== */
@media print {
    .sidebar,
    .content-header,
    .btn,
    .modal-overlay {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0;
    }
    
    .card {
        break-inside: avoid;
        border: 1px solid #ccc;
    }
}

/* ==================== SCROLLBAR ==================== */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-primary);
}

::-webkit-scrollbar-thumb {
    background: var(--bg-hover);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--border-light);
}

/* ==================== SELECTION ==================== */
::selection {
    background: var(--primary);
    color: white;
}
</style>
</head>
<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">🫀</div>
                    <div>
                        <div class="logo-text">ECG Trainer Pro</div>
                        <div class="logo-subtitle">Intensive Care Editie v2.0</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Hoofdmenu</div>
                    <div class="nav-item active" data-section="dashboard">
                        <span class="nav-item-icon">🏠</span>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-section="monitor">
                        <span class="nav-item-icon">📺</span>
                        <span>Monitor Simulator</span>
                        <span class="nav-item-badge yellow">Live</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Leren</div>
                    <div class="nav-item" data-section="learningPath">
                        <span class="nav-item-icon">🧭</span>
                        <span>Leerpad</span>
                        <span class="nav-item-badge blue">Nieuw</span>
                    </div>
                    <div class="nav-item" data-section="library">
                        <span class="nav-item-icon">📚</span>
                        <span>ECG Bibliotheek</span>
                        <span class="nav-item-badge green">40+</span>
                    </div>
                    <div class="nav-item" data-section="systematic">
                        <span class="nav-item-icon">📋</span>
                        <span>Systematische Analyse</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Oefenen</div>
                    <div class="nav-item" data-section="quiz">
                        <span class="nav-item-icon">🎯</span>
                        <span>Quiz Modus</span>
                    </div>
                    <div class="nav-item" data-section="cases">
                        <span class="nav-item-icon">🏥</span>
                        <span>Klinische Cases</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Protocollen</div>
                    <div class="nav-item" data-section="acls">
                        <span class="nav-item-icon">🚨</span>
                        <span>ACLS Algoritmes</span>
                        <span class="nav-item-badge red">Spoed</span>
                    </div>
                    <div class="nav-item" data-section="drugs">
                        <span class="nav-item-icon">💊</span>
                        <span>Medicatie & ECG</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Referentie</div>
                    <div class="nav-item" data-section="criteria">
                        <span class="nav-item-icon">📏</span>
                        <span>Criteria & Waarden</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Profiel</div>
                    <div class="nav-item" data-section="progress">
                        <span class="nav-item-icon">📈</span>
                        <span>Voortgang</span>
                    </div>
                    <div class="nav-item" data-section="achievements">
                        <span class="nav-item-icon">🏆</span>
                        <span>Prestaties</span>
                    </div>
                    <div class="nav-item" data-section="settings">
                        <span class="nav-item-icon">⚙️</span>
                        <span>Instellingen</span>
                    </div>
                </div>
            </nav>

            <div class="sidebar-stats">
                <div class="stat-row">
                    <span class="stat-label">🔥 Reeks</span>
                    <span class="stat-value" id="sidebarStreak">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">⭐ XP</span>
                    <span class="stat-value" id="sidebarXP">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">📊 Nauwkeurigheid</span>
                    <span class="stat-value" id="sidebarAccuracy">0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">👤 Profiel</span>
                    <span class="stat-value" id="sidebarProfile">Standaard</span>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header class="top-bar">
                <h1 class="top-bar-title" id="pageTitle">📊 Dashboard</h1>
                <div class="top-bar-actions">
                    <button class="btn btn-primary btn-sm" onclick="ECGApp.startQuickQuiz()">
                        🎯 Snelle Quiz
                    </button>
                </div>
            </header>

            <div class="content-area" id="contentArea">
                <!-- Sections worden hier geladen -->
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Modal</h2>
                <button class="modal-close" onclick="ECGApp.closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-outline" onclick="ECGApp.closeModal()">Sluiten</button>
            </div>
        </div>
    </div>

    <script>
    // ==================== DEEL 2 START HIER ====================

    // ==================== STATE MANAGEMENT ====================
    const AppState = {
        currentSection: 'dashboard',
        profile: {
            id: 'default',
            name: 'Standaard'
        },
        user: {
            streak: 0,
            xp: 0,
            totalAnswered: 0,
            totalCorrect: 0,
            level: 1,
            achievements: [],
            quizHistory: [],
            lastActive: null,
            completedTopics: [],
            masteredRhythms: []
        },
        quiz: {
            active: false,
            mode: 'standard', // 'standard', 'timed', 'survival', 'clinical', 'exam'
            difficulty: 'all', // 'easy', 'medium', 'hard', 'all'
            category: 'all',
            moduleId: null,
            currentQuestion: 0,
            totalQuestions: 10,
            score: 0,
            answers: [],
            timeRemaining: 0,
            timerInterval: null,
            currentRhythm: null,
            selectedAnswer: null,
            showingFeedback: false
        },
        monitor: {
            currentRhythm: 'sinus_normal',
            speed: 25,
            amplitude: 1,
            heartRate: 72,
            isRunning: false,
            animationId: null
        },
        library: {
            selectedCategory: 'all',
            searchQuery: '',
            selectedRhythm: null
        },
        settings: {
            soundEnabled: true,
            animationsEnabled: true,
            showHints: true,
            darkMode: true,
            defaultQuizCount: 10,
            timerSeconds: 30,
            guidelineProfile: 'ERC/ESC'
        },
        learningPath: {
            currentModule: 'module_1',
            modules: ['module_1', 'module_2', 'module_3', 'module_4', 'module_5', 'module_6', 'module_7', 'module_8'],
            completedModules: [],
            weeklyFocus: [],
            completedCases: [],
            dailyRoundState: {
                date: '',
                caseIds: [],
                completedCaseIds: []
            },
            checklistTraining: {
                sessions: 0,
                activeSince: null,
                lastCompleted: null
            }
        }
    };

    const StateFactory = {
        userTemplate: null,
        settingsTemplate: null,
        learningPathTemplate: null,

        clone(value) {
            return JSON.parse(JSON.stringify(value));
        },

        createUser() {
            return this.clone(this.userTemplate);
        },

        createSettings() {
            return this.clone(this.settingsTemplate);
        },

        createLearningPath() {
            return this.clone(this.learningPathTemplate);
        }
    };

    StateFactory.userTemplate = StateFactory.clone(AppState.user);
    StateFactory.settingsTemplate = StateFactory.clone(AppState.settings);
    StateFactory.learningPathTemplate = StateFactory.clone(AppState.learningPath);

    // ==================== LOCAL STORAGE ====================
    const Storage = {
        KEY: 'ecg_trainer_v2_profiles',
        LEGACY_KEY: 'ecg_trainer_v2_data',
        ACTIVE_PROFILE_KEY: 'ecg_trainer_v2_active_profile',

        createDefaultProfile(name = 'Standaard') {
            return {
                name,
                user: StateFactory.createUser(),
                settings: StateFactory.createSettings(),
                learningPath: StateFactory.createLearningPath(),
                createdAt: new Date().toISOString(),
                savedAt: new Date().toISOString()
            };
        },

        createContainer() {
            return {
                version: 1,
                profiles: {
                    default: this.createDefaultProfile('Standaard')
                },
                updatedAt: new Date().toISOString()
            };
        },

        getContainer() {
            try {
                const raw = localStorage.getItem(this.KEY);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (parsed && parsed.profiles && Object.keys(parsed.profiles).length > 0) {
                        return parsed;
                    }
                }
            } catch (e) {
                console.warn('Profielcontainer kon niet worden gelezen, fallback naar nieuw:', e);
            }

            const migrated = this.migrateLegacyData();
            this.saveContainer(migrated);
            return migrated;
        },

        saveContainer(container) {
            container.updatedAt = new Date().toISOString();
            localStorage.setItem(this.KEY, JSON.stringify(container));
        },

        migrateLegacyData() {
            const container = this.createContainer();

            try {
                const legacyRaw = localStorage.getItem(this.LEGACY_KEY);
                if (!legacyRaw) return container;

                const legacy = JSON.parse(legacyRaw);
                const baseProfile = container.profiles.default;
                if (legacy.user) baseProfile.user = { ...baseProfile.user, ...legacy.user };
                if (legacy.settings) baseProfile.settings = { ...baseProfile.settings, ...legacy.settings };
                if (legacy.learningPath) {
                    baseProfile.learningPath = {
                        ...baseProfile.learningPath,
                        ...legacy.learningPath,
                        dailyRoundState: {
                            ...baseProfile.learningPath.dailyRoundState,
                            ...(legacy.learningPath.dailyRoundState || {})
                        },
                        checklistTraining: {
                            ...baseProfile.learningPath.checklistTraining,
                            ...(legacy.learningPath.checklistTraining || {})
                        }
                    };
                }
                baseProfile.savedAt = legacy.savedAt || new Date().toISOString();
            } catch (e) {
                console.warn('Legacy migratie mislukt, start met lege profielen:', e);
            }

            return container;
        },

        getActiveProfileId(container) {
            const selected = localStorage.getItem(this.ACTIVE_PROFILE_KEY) || 'default';
            if (container.profiles[selected]) return selected;
            const fallback = Object.keys(container.profiles)[0] || 'default';
            localStorage.setItem(this.ACTIVE_PROFILE_KEY, fallback);
            return fallback;
        },

        setActiveProfile(profileId) {
            const container = this.getContainer();
            if (!container.profiles[profileId]) return false;
            localStorage.setItem(this.ACTIVE_PROFILE_KEY, profileId);
            return true;
        },

        listProfiles() {
            const container = this.getContainer();
            return Object.entries(container.profiles).map(([id, profile]) => ({
                id,
                name: profile.name || id
            })).sort((a, b) => a.name.localeCompare(b.name, 'nl-NL'));
        },

        createProfile(name) {
            const safeName = (name || '').trim();
            if (!safeName) throw new Error('Profielnaam is verplicht.');

            const container = this.getContainer();
            const exists = Object.values(container.profiles).some(p => (p.name || '').toLowerCase() === safeName.toLowerCase());
            if (exists) throw new Error('Er bestaat al een profiel met deze naam.');

            const profileId = `profile_${Date.now()}`;
            container.profiles[profileId] = this.createDefaultProfile(safeName);
            this.saveContainer(container);
            localStorage.setItem(this.ACTIVE_PROFILE_KEY, profileId);
            return profileId;
        },

        renameActiveProfile(newName) {
            const safeName = (newName || '').trim();
            if (!safeName) throw new Error('Profielnaam is verplicht.');

            const container = this.getContainer();
            const activeId = this.getActiveProfileId(container);
            if (!container.profiles[activeId]) throw new Error('Actief profiel niet gevonden.');

            const duplicate = Object.entries(container.profiles).some(([id, p]) => id !== activeId && (p.name || '').toLowerCase() === safeName.toLowerCase());
            if (duplicate) throw new Error('Er bestaat al een profiel met deze naam.');

            container.profiles[activeId].name = safeName;
            this.saveContainer(container);
            AppState.profile.name = safeName;
        },

        deleteProfile(profileId) {
            const container = this.getContainer();
            if (!container.profiles[profileId]) throw new Error('Profiel niet gevonden.');
            const allIds = Object.keys(container.profiles);
            if (allIds.length <= 1) throw new Error('Je moet minimaal 1 profiel behouden.');

            delete container.profiles[profileId];
            this.saveContainer(container);

            const currentActive = localStorage.getItem(this.ACTIVE_PROFILE_KEY);
            if (currentActive === profileId) {
                const nextId = Object.keys(container.profiles)[0];
                localStorage.setItem(this.ACTIVE_PROFILE_KEY, nextId);
            }
        },

        resetActiveProfile() {
            const container = this.getContainer();
            const activeId = this.getActiveProfileId(container);
            const profileName = container.profiles[activeId]?.name || 'Standaard';
            container.profiles[activeId] = this.createDefaultProfile(profileName);
            this.saveContainer(container);
        },

        applyProfileToState(profileId, profileData) {
            AppState.profile.id = profileId;
            AppState.profile.name = profileData.name || 'Standaard';

            AppState.user = { ...StateFactory.createUser(), ...(profileData.user || {}) };
            AppState.settings = { ...StateFactory.createSettings(), ...(profileData.settings || {}) };

            const baseLearningPath = StateFactory.createLearningPath();
            AppState.learningPath = {
                ...baseLearningPath,
                ...(profileData.learningPath || {}),
                dailyRoundState: {
                    ...baseLearningPath.dailyRoundState,
                    ...(profileData.learningPath?.dailyRoundState || {})
                },
                checklistTraining: {
                    ...baseLearningPath.checklistTraining,
                    ...(profileData.learningPath?.checklistTraining || {})
                }
            };
        },

        save() {
            try {
                const container = this.getContainer();
                const activeId = this.getActiveProfileId(container);
                const existing = container.profiles[activeId] || this.createDefaultProfile('Standaard');

                container.profiles[activeId] = {
                    ...existing,
                    name: AppState.profile.name || existing.name || 'Standaard',
                    user: AppState.user,
                    settings: AppState.settings,
                    learningPath: AppState.learningPath,
                    savedAt: new Date().toISOString()
                };

                this.saveContainer(container);
            } catch (e) {
                console.error('Opslaan mislukt:', e);
            }
        },

        load() {
            try {
                const container = this.getContainer();
                const activeId = this.getActiveProfileId(container);
                const profileData = container.profiles[activeId] || this.createDefaultProfile('Standaard');

                this.applyProfileToState(activeId, profileData);

                // Check streak continuity per actief profiel
                if (profileData.savedAt) {
                    const lastDate = new Date(profileData.savedAt).toDateString();
                    const today = new Date().toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();

                    if (lastDate !== today && lastDate !== yesterday) {
                        AppState.user.streak = 0;
                    }
                }
            } catch (e) {
                console.error('Laden mislukt:', e);
            }
        },

        clear() {
            this.resetActiveProfile();
            location.reload();
        }
    };

    // ==================== ECG DATABASE - COMPLETE ====================
    const ECGDatabase = {
        
        // ========== CATEGORIEËN ==========
        categories: {
            normal: {
                name: 'Normaal Sinusritme',
                icon: '💚',
                color: 'green',
                description: 'Normale hartritmes'
            },
            bradycardia: {
                name: 'Bradycardieën',
                icon: '🐢',
                color: 'blue',
                description: 'Trage ritmes (< 60 bpm)'
            },
            tachycardia: {
                name: 'Tachycardieën',
                icon: '⚡',
                color: 'yellow',
                description: 'Snelle ritmes (> 100 bpm)'
            },
            atrial: {
                name: 'Atriale Aritmieën',
                icon: '〰️',
                color: 'purple',
                description: 'Stoornissen vanuit de atria'
            },
            ventricular: {
                name: 'Ventriculaire Aritmieën',
                icon: '💔',
                color: 'red',
                description: 'Stoornissen vanuit ventrikels'
            },
            blocks: {
                name: 'Geleidingsstoornissen',
                icon: '🚧',
                color: 'orange',
                description: 'AV-blokken en bundeltak blokken'
            },
            ischemia: {
                name: 'Ischemie & Infarcten',
                icon: '🔥',
                color: 'red',
                description: 'Coronaire problematiek'
            },
            pacemaker: {
                name: 'Pacemaker Ritmes',
                icon: '🔋',
                color: 'cyan',
                description: 'Gepacede ritmes'
            },
            other: {
                name: 'Overige',
                icon: '📋',
                color: 'gray',
                description: 'Overige ECG afwijkingen'
            }
        },

        // ========== COMPLETE RITME DATABASE ==========
        rhythms: {
            
            // ==================== NORMALE RITMES ====================
            sinus_normal: {
                id: 'sinus_normal',
                name: 'Normaal Sinusritme',
                shortName: 'NSR',
                category: 'normal',
                difficulty: 'easy',
                urgency: 'none',
                description: 'Normaal ritme met oorsprong in de sinusknoop',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 72 },
                    rhythm: 'Regelmatig',
                    pWave: 'Aanwezig, positief in II, negatief in aVR',
                    prInterval: { min: 120, max: 200, unit: 'ms' },
                    qrsComplex: { min: 60, max: 100, unit: 'ms' },
                    qtInterval: 'Normaal gecorrigeerd'
                },
                ecgFeatures: [
                    'P-golf voor elk QRS-complex',
                    'Constante PR-interval',
                    'Regelmatige R-R intervallen',
                    'Smalle QRS-complexen'
                ],
                clinicalSignificance: 'Normale elektrische hartactiviteit',
                commonCauses: ['Gezond hart', 'Goede fysieke conditie'],
                treatment: 'Geen behandeling nodig',
                waveformParams: {
                    pHeight: 0.15,
                    pWidth: 0.08,
                    qDepth: 0.05,
                    rHeight: 1.0,
                    sDepth: 0.15,
                    tHeight: 0.25,
                    tWidth: 0.16,
                    prInterval: 0.16,
                    qrsWidth: 0.08
                },
                quizHints: [
                    'Let op de regelmatige P-golven',
                    'PR-interval is constant',
                    'Frequentie tussen 60-100/min'
                ]
            },

            sinus_bradycardia: {
                id: 'sinus_bradycardia',
                name: 'Sinusbradycardie',
                shortName: 'SB',
                category: 'bradycardia',
                difficulty: 'easy',
                urgency: 'low',
                description: 'Sinusritme met frequentie < 60/min',
                characteristics: {
                    rate: { min: 30, max: 59, typical: 50 },
                    rhythm: 'Regelmatig',
                    pWave: 'Normaal aanwezig',
                    prInterval: { min: 120, max: 200, unit: 'ms' },
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'Normale P-golven met normaal QRS',
                    'Langere R-R intervallen',
                    'Frequentie < 60/min',
                    'Normale geleiding'
                ],
                clinicalSignificance: 'Kan fysiologisch zijn bij sporters of pathologisch',
                commonCauses: [
                    'Verhoogde vagale tonus',
                    'Atleten',
                    'Bètablokkers',
                    'Hypothyreoïdie',
                    'Sick sinus syndroom',
                    'Hypothermie'
                ],
                treatment: 'Atropine bij symptomen, pacemaker bij ernstige gevallen',
                waveformParams: {
                    pHeight: 0.15,
                    pWidth: 0.08,
                    rHeight: 1.0,
                    tHeight: 0.25,
                    prInterval: 0.16,
                    qrsWidth: 0.08
                },
                quizHints: [
                    'Normaal sinusritme maar traag',
                    'P-golven zijn normaal',
                    'Frequentie < 60/min'
                ]
            },

            sinus_tachycardia: {
                id: 'sinus_tachycardia',
                name: 'Sinustachycardie',
                shortName: 'ST',
                category: 'tachycardia',
                difficulty: 'easy',
                urgency: 'low',
                description: 'Sinusritme met frequentie > 100/min',
                characteristics: {
                    rate: { min: 101, max: 180, typical: 120 },
                    rhythm: 'Regelmatig',
                    pWave: 'Normaal aanwezig (kan moeilijk te onderscheiden zijn)',
                    prInterval: { min: 120, max: 200, unit: 'ms' },
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'Normale P-golven (soms verborgen in T-golf)',
                    'Kortere R-R intervallen',
                    'Frequentie > 100/min',
                    'Normale geleiding'
                ],
                clinicalSignificance: 'Meestal secundair aan onderliggende oorzaak',
                commonCauses: [
                    'Koorts',
                    'Pijn',
                    'Angst/stress',
                    'Hypovolemie',
                    'Anemie',
                    'Hyperthyreoïdie',
                    'Medicatie (salbutamol)',
                    'Sepsis'
                ],
                treatment: 'Behandel onderliggende oorzaak, bètablokkers indien geïndiceerd',
                waveformParams: {
                    pHeight: 0.12,
                    pWidth: 0.06,
                    rHeight: 0.95,
                    tHeight: 0.2,
                    prInterval: 0.12,
                    qrsWidth: 0.08
                },
                quizHints: [
                    'Normaal sinusritme maar snel',
                    'P-golven aanwezig',
                    'Frequentie > 100/min'
                ]
            },

            sinus_arrhythmia: {
                id: 'sinus_arrhythmia',
                name: 'Sinusaritmie',
                shortName: 'SA',
                category: 'normal',
                difficulty: 'easy',
                urgency: 'none',
                description: 'Variatie in sinusritme, vaak gerelateerd aan ademhaling',
                characteristics: {
                    rate: { min: 50, max: 100, typical: 70 },
                    rhythm: 'Onregelmatig (cyclisch met ademhaling)',
                    pWave: 'Normaal',
                    prInterval: { min: 120, max: 200, unit: 'ms' },
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'P-golven normaal vormgegeven',
                    'Variërende R-R intervallen',
                    'PR-interval constant',
                    'Variatie > 0.16 sec tussen langste en kortste R-R'
                ],
                clinicalSignificance: 'Fysiologisch, vooral bij jongeren',
                commonCauses: ['Respiratoire sinusaritmie', 'Normale variant'],
                treatment: 'Geen behandeling nodig',
                waveformParams: {
                    pHeight: 0.15,
                    pWidth: 0.08,
                    rHeight: 1.0,
                    tHeight: 0.25,
                    prInterval: 0.16,
                    qrsWidth: 0.08,
                    variability: 0.2
                },
                quizHints: [
                    'Onregelmatig maar met normale P-golven',
                    'Variatie met ademhaling',
                    'PR-interval blijft constant'
                ]
            },

            // ==================== ATRIALE ARITMIEËN ====================
            atrial_fibrillation: {
                id: 'atrial_fibrillation',
                name: 'Atriumfibrilleren',
                shortName: 'AF',
                category: 'atrial',
                difficulty: 'medium',
                urgency: 'medium',
                description: 'Chaotische elektrische activiteit in de atria',
                characteristics: {
                    rate: { min: 60, max: 180, typical: 110 },
                    rhythm: 'Onregelmatig onregelmatig',
                    pWave: 'Afwezig, fibrillatiegolven',
                    prInterval: 'Niet meetbaar',
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'Geen duidelijke P-golven',
                    'Fibrillatiegolven (f-golven)',
                    'Onregelmatige R-R intervallen',
                    'Normaal QRS (tenzij aberrante geleiding)'
                ],
                clinicalSignificance: 'Verhoogd risico op CVA, hartfalen',
                commonCauses: [
                    'Hypertensie',
                    'Hartfalen',
                    'Kleplijden',
                    'Hyperthyreoïdie',
                    'Alcohol',
                    'Longembolie',
                    'Post-cardiochirurgie'
                ],
                treatment: 'Rate control (eerste keus: bètablokker of diltiazem/verapamil; digoxine vooral bij sedentair of hartfalen), rhythm control, anticoagulantia (CHA₂DS₂-VASc)',
                medications: {
                    rateControl: ['Metoprolol', 'Diltiazem', 'Verapamil', 'Digoxine'],
                    rhythmControl: ['Flecaïnide', 'Amiodaron', 'Sotalol'],
                    anticoagulation: ['DOAC', 'VKA']
                },
                waveformParams: {
                    pHeight: 0,
                    fibrillation: true,
                    fibrillationAmplitude: 0.05,
                    rHeight: 1.0,
                    tHeight: 0.25,
                    qrsWidth: 0.08,
                    rrVariability: 0.4
                },
                quizHints: [
                    'Geen P-golven zichtbaar',
                    'Onregelmatige R-R intervallen',
                    'Fibrillatiegolven in baseline'
                ]
            },

            atrial_flutter: {
                id: 'atrial_flutter',
                name: 'Atriumflutter',
                shortName: 'AFL',
                category: 'atrial',
                difficulty: 'medium',
                urgency: 'medium',
                description: 'Georganiseerde re-entry in het atrium',
                characteristics: {
                    rate: { min: 60, max: 150, typical: 150 },
                    rhythm: 'Regelmatig of regelmatig onregelmatig',
                    pWave: 'Zaagtand fluttergolven (F-golven, 250-350/min)',
                    prInterval: 'Niet conventioneel meetbaar',
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'Zaagtand patroon (beste in II, III, aVF)',
                    'Fluttergolven ~300/min',
                    'Vaste of variabele AV-geleiding (2:1, 3:1, 4:1)',
                    'Bij 2:1 geleiding: ventrikelfrequentie ~150/min'
                ],
                clinicalSignificance: 'Vaak instabiel, kan overgaan in AF',
                commonCauses: [
                    'Structureel hartlijden',
                    'Post-cardiochirurgie',
                    'COPD',
                    'Pulmonale hypertensie'
                ],
                treatment: 'Rate control, ablatie effectiever dan bij AF',
                waveformParams: {
                    flutterWaves: true,
                    flutterRate: 300,
                    avConduction: 2,
                    rHeight: 1.0,
                    tHeight: 0.2,
                    qrsWidth: 0.08
                },
                quizHints: [
                    'Zaagtand patroon',
                    'Flutter frequentie ~300/min',
                    'Vaak 2:1 geleiding → HF ~150/min'
                ]
            },

            svt: {
                id: 'svt',
                name: 'Supraventriculaire Tachycardie',
                shortName: 'SVT',
                category: 'tachycardia',
                difficulty: 'medium',
                urgency: 'medium',
                description: 'Snelle tachycardie met oorsprong boven de bundel van His',
                characteristics: {
                    rate: { min: 150, max: 250, typical: 180 },
                    rhythm: 'Regelmatig',
                    pWave: 'Vaak niet zichtbaar of retrograad',
                    prInterval: 'Kort of niet meetbaar',
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'Regelmatig smal complex tachycardie',
                    'Abrupt begin en einde',
                    'P-golven vaak verborgen in QRS of T',
                    'Frequentie meestal 150-250/min'
                ],
                clinicalSignificance: 'Acuut symptomatisch, meestal niet levensbedreigend',
                commonCauses: [
                    'AVNRT (meest voorkomend)',
                    'AVRT (accessoire bundel)',
                    'Atriale tachycardie'
                ],
                treatment: 'Vagale manoeuvres, adenosine bij regelmatige smalcomplex tachycardie, cardioversie indien instabiel',
                medications: {
                    acute: ['Adenosine 6mg → 12mg → 12mg IV bolus (alleen bij regelmatig ritme)', 'Verapamil', 'Bètablokker'],
                    chronic: ['Bètablokker', 'Calciumantagonist', 'Ablatie']
                },
                waveformParams: {
                    pHeight: 0,
                    rHeight: 0.9,
                    tHeight: 0.15,
                    prInterval: 0,
                    qrsWidth: 0.08
                },
                quizHints: [
                    'Regelmatig smal complex',
                    'Frequentie 150-250/min',
                    'P-golven vaak niet zichtbaar'
                ]
            },

            atrial_tachycardia: {
                id: 'atrial_tachycardia',
                name: 'Atriale Tachycardie',
                shortName: 'AT',
                category: 'tachycardia',
                difficulty: 'medium',
                urgency: 'low',
                description: 'Tachycardie vanuit een ectopische focus in het atrium',
                characteristics: {
                    rate: { min: 100, max: 250, typical: 150 },
                    rhythm: 'Regelmatig',
                    pWave: 'Aanwezig maar afwijkende morfologie',
                    prInterval: 'Variabel',
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'P-golf morfologie verschilt van sinus P',
                    'PR-interval kan verkort of verlengd zijn',
                    'Isoelektrische lijn tussen P-golven',
                    'Warm-up en cool-down fenomeen mogelijk'
                ],
                clinicalSignificance: 'Kan leiden tot tachycardiomyopathie bij chronisch',
                commonCauses: ['Structureel hartlijden', 'Digoxine toxiciteit', 'COPD'],
                treatment: 'Bètablokker, calciumantagonist, ablatie',
                waveformParams: {
                    pHeight: 0.1,
                    pWidth: 0.06,
                    pMorphology: 'abnormal',
                    rHeight: 0.9,
                    tHeight: 0.2,
                    qrsWidth: 0.08
                },
                quizHints: [
                    'P-golven zichtbaar maar afwijkend',
                    'Isoelektrische lijn tussen P-golven',
                    'Verschillend van flutter (geen zaagtand)'
                ]
            },

            pac: {
                id: 'pac',
                name: 'Premature Atriale Contractie',
                shortName: 'PAC',
                category: 'atrial',
                difficulty: 'easy',
                urgency: 'none',
                description: 'Vroegtijdige slag vanuit het atrium',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 75 },
                    rhythm: 'Onregelmatig door extra slagen',
                    pWave: 'Premature P met afwijkende morfologie',
                    prInterval: 'Kan verschillen van normaal',
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'Vroegtijdige P-golf',
                    'P-golf morfologie anders dan sinus P',
                    'QRS meestal normaal',
                    'Incomplete compensatoire pauze'
                ],
                clinicalSignificance: 'Meestal benigne, kan voorloper zijn van AF',
                commonCauses: ['Cafeïne', 'Alcohol', 'Stress', 'Hypoxie'],
                treatment: 'Meestal geen, trigger vermijden',
                waveformParams: {
                    pHeight: 0.15,
                    rHeight: 1.0,
                    tHeight: 0.25,
                    prematurePHeight: 0.1,
                    prematurePMorphology: 'different'
                },
                quizHints: [
                    'Vroegtijdige slag met P-golf',
                    'P-golf morfologie afwijkend',
                    'Incomplete compensatoire pauze'
                ]
            },

            wandering_pacemaker: {
                id: 'wandering_pacemaker',
                name: 'Wandelende Pacemaker',
                shortName: 'WAP',
                category: 'atrial',
                difficulty: 'hard',
                urgency: 'none',
                description: 'Wisselende pacemaker locatie in atrium/AV-knoop',
                characteristics: {
                    rate: { min: 50, max: 100, typical: 70 },
                    rhythm: 'Licht onregelmatig',
                    pWave: 'Variërende morfologie (≥3 verschillende vormen)',
                    prInterval: 'Variabel',
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'Minimaal 3 verschillende P-golf morfologieën',
                    'Variërende PR-intervallen',
                    'Variërende R-R intervallen',
                    'Frequentie meestal < 100/min'
                ],
                clinicalSignificance: 'Kan normaal zijn, of wijzen op atriale afwijkingen',
                commonCauses: ['Verhoogde vagale tonus', 'Digoxine', 'Hartziekte'],
                treatment: 'Meestal geen behandeling nodig',
                waveformParams: {
                    variablePMorphology: true,
                    pMorphologies: 3,
                    variablePR: true
                },
                quizHints: [
                    '≥3 verschillende P-golf vormen',
                    'Wisselende PR-intervallen',
                    'Rustige frequentie'
                ]
            },

            mat: {
                id: 'mat',
                name: 'Multifocale Atriale Tachycardie',
                shortName: 'MAT',
                category: 'tachycardia',
                difficulty: 'hard',
                urgency: 'low',
                description: 'Snelle wandelende atriale pacemaker (>100/min)',
                characteristics: {
                    rate: { min: 100, max: 180, typical: 120 },
                    rhythm: 'Onregelmatig',
                    pWave: '≥3 verschillende morfologieën',
                    prInterval: 'Variabel',
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'Minimaal 3 verschillende P-golf morfologieën',
                    'Variërende PR-intervallen',
                    'Variërende P-P intervallen',
                    'Frequentie > 100/min'
                ],
                clinicalSignificance: 'Geassocieerd met ernstige pulmonale ziekte',
                commonCauses: ['COPD (meest voorkomend)', 'Hypoxie', 'Elektrolytstoornissen'],
                treatment: 'Onderliggende oorzaak behandelen, magnesium, calciumantagonist',
                waveformParams: {
                    variablePMorphology: true,
                    pMorphologies: 3,
                    variablePR: true,
                    variableRR: true
                },
                quizHints: [
                    'Lijkt op AF maar heeft P-golven',
                    '≥3 P-golf morfologieën',
                    'Vaak bij COPD patiënten'
                ]
            },

            // ==================== VENTRICULAIRE ARITMIEËN ====================
            pvc: {
                id: 'pvc',
                name: 'Premature Ventriculaire Contractie',
                shortName: 'PVC',
                category: 'ventricular',
                difficulty: 'easy',
                urgency: 'low',
                description: 'Vroegtijdige slag vanuit het ventrikel',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 75 },
                    rhythm: 'Onregelmatig door extra slagen',
                    pWave: 'Afwezig voor PVC',
                    prInterval: 'N.v.t. voor PVC',
                    qrsComplex: { duration: '>120ms', morphology: 'breed en bizar' }
                },
                ecgFeatures: [
                    'Breed QRS-complex (>120ms)',
                    'Geen voorafgaande P-golf',
                    'Compensatoire pauze (volledig)',
                    'T-golf tegengesteld aan QRS'
                ],
                clinicalSignificance: 'Meestal benigne, let op bij frequente/polymorfe PVCs',
                commonCauses: [
                    'Cafeïne',
                    'Hypokaliëmie',
                    'Hypomagnesiëmie',
                    'Myocardischemie',
                    'Hartfalen',
                    'Stress'
                ],
                treatment: 'Trigger vermijden, bètablokker bij klachten',
                patterns: {
                    unifocal: 'Alle PVCs zelfde morfologie',
                    multifocal: 'PVCs met verschillende morfologie',
                    bigeminy: 'Elke 2e slag is PVC',
                    trigeminy: 'Elke 3e slag is PVC',
                    couplet: 'Twee PVCs achter elkaar',
                    triplet: 'Drie PVCs achter elkaar (= NSVT)'
                },
                waveformParams: {
                    pvcWidth: 0.14,
                    pvcHeight: 1.3,
                    pvcTInverted: true,
                    compensatoryPause: true
                },
                quizHints: [
                    'Breed QRS zonder P-golf',
                    'Volledig compensatoire pauze',
                    'T-golf tegengesteld aan QRS'
                ]
            },

            pvc_bigeminy: {
                id: 'pvc_bigeminy',
                name: 'PVC Bigeminee',
                shortName: 'PVC Bige',
                category: 'ventricular',
                difficulty: 'medium',
                urgency: 'low',
                description: 'Patroon waarbij elke normale slag gevolgd wordt door een PVC',
                characteristics: {
                    rate: { min: 50, max: 80, typical: 70 },
                    rhythm: 'Regelmatig onregelmatig (patroon)',
                    pWave: 'Aanwezig voor normale slagen',
                    qrsComplex: 'Afwisselend smal en breed'
                },
                ecgFeatures: [
                    'Normale slag - PVC - normale slag - PVC patroon',
                    'Effectieve hartfrequentie kan laag zijn',
                    'Brede QRS-complexen afwisselend met smalle'
                ],
                clinicalSignificance: 'Kan symptomen geven door verlaagde output',
                commonCauses: ['Digoxine toxiciteit', 'Elektrolytstoornis', 'Structureel hartlijden'],
                treatment: 'Onderliggende oorzaak behandelen, bètablokker',
                waveformParams: {
                    pattern: 'bigeminy',
                    pvcWidth: 0.14,
                    pvcHeight: 1.3
                },
                quizHints: [
                    'Elke normale slag → PVC',
                    'Regelmatig patroon',
                    'Effectieve HF is lager'
                ]
            },

            vtach_monomorphic: {
                id: 'vtach_monomorphic',
                name: 'Ventriculaire Tachycardie (Monomorf)',
                shortName: 'VT',
                category: 'ventricular',
                difficulty: 'medium',
                urgency: 'high',
                description: '≥3 opeenvolgende ventriculaire slagen met uniforme morfologie',
                characteristics: {
                    rate: { min: 100, max: 250, typical: 180 },
                    rhythm: 'Regelmatig',
                    pWave: 'Vaak AV-dissociatie',
                    qrsComplex: { duration: '>120ms', morphology: 'breed, uniform' }
                },
                ecgFeatures: [
                    'Breed QRS-complex (>120ms)',
                    'Regelmatige R-R intervallen',
                    'AV-dissociatie (capture beats, fusion beats)',
                    'Extreme as (northwest axis)',
                    'Uniforme QRS morfologie'
                ],
                clinicalSignificance: 'LEVENSBEDREIGENDE ARITMIE',
                commonCauses: [
                    'Myocardinfarct (acuut/oud)',
                    'Cardiomyopathie',
                    'Elektrolytstoornissen',
                    'Lange QT syndroom',
                    'Aritmogene RV cardiomyopathie'
                ],
                treatment: 'Stabiel: Amiodaron IV, Instabiel: Cardioversie',
                medications: {
                    stable: ['Amiodaron 150mg IV over 10 min', 'Lidocaïne 1-1.5mg/kg IV'],
                    unstable: ['Gesynchroniseerde cardioversie 100-200J', 'Amiodaron']
                },
                waveformParams: {
                    qrsWidth: 0.16,
                    qrsHeight: 1.4,
                    uniform: true,
                    avDissociation: true
                },
                quizHints: [
                    'Breed complex, regelmatig, snel',
                    'Uniforme QRS morfologie',
                    'AV-dissociatie = diagnostisch'
                ]
            },

            vtach_polymorphic: {
                id: 'vtach_polymorphic',
                name: 'Polymorfe VT / Torsades de Pointes',
                shortName: 'TdP',
                category: 'ventricular',
                difficulty: 'hard',
                urgency: 'critical',
                description: 'VT met wisselende QRS-morfologie, draaiend om de basislijn',
                characteristics: {
                    rate: { min: 150, max: 300, typical: 200 },
                    rhythm: 'Onregelmatig',
                    pWave: 'Niet zichtbaar',
                    qrsComplex: 'Wisselende morfologie en amplitude'
                },
                ecgFeatures: [
                    'QRS-complexen draaien om basislijn',
                    '"Twisting of the points"',
                    'Geassocieerd met verlengd QT-interval',
                    'Kan degenereren naar VF'
                ],
                clinicalSignificance: 'ACUUT LEVENSBEDREIGENDE ARITMIE',
                commonCauses: [
                    'Verlengd QT (medicatie)',
                    'Hypokaliëmie',
                    'Hypomagnesiëmie',
                    'Bradycardie',
                    'Congenitaal lang QT'
                ],
                treatment: 'Magnesium 2g IV, stop QT-verlengende medicatie, pacing bij bradycardie',
                medications: {
                    immediate: ['Magnesiumsulfaat 2g IV push', 'Defibrillatie bij VF'],
                    supportive: ['Correctie elektrolyten', 'Isoproterenol of pacing bij bradycardie']
                },
                waveformParams: {
                    polymorphic: true,
                    twisting: true,
                    amplitudeVariation: true
                },
                quizHints: [
                    'QRS draait om basislijn',
                    'Vaak bij lang QT',
                    'Magnesium = eerste behandeling'
                ]
            },

            vfib: {
                id: 'vfib',
                name: 'Ventrikelfibrilleren',
                shortName: 'VF',
                category: 'ventricular',
                difficulty: 'easy',
                urgency: 'critical',
                description: 'Chaotische elektrische activiteit, geen effectieve output',
                characteristics: {
                    rate: { min: 150, max: 500, typical: 300 },
                    rhythm: 'Chaotisch',
                    pWave: 'Niet aanwezig',
                    qrsComplex: 'Niet herkenbaar'
                },
                ecgFeatures: [
                    'Grillig, onregelmatig patroon',
                    'Geen herkenbare QRS-complexen',
                    'Geen P-golven',
                    'Variërende amplitude (coarse vs fine VF)',
                    'GEEN POLS'
                ],
                clinicalSignificance: 'HARTSTILSTAND - ONMIDDELLIJK HANDELEN',
                commonCauses: [
                    'Myocardinfarct',
                    'Cardiomyopathie',
                    'Elektrolytstoornissen',
                    'Hypothermie',
                    'Verdrinking',
                    'Degeneratie vanuit VT'
                ],
                treatment: 'CPR + defibrillatie met fabrikant-adviesenergie (bij bifasisch vaak 120-200J), escaleren indien nodig',
                waveformParams: {
                    chaotic: true,
                    noQRS: true,
                    amplitudeRange: { min: 0.1, max: 0.6 }
                },
                quizHints: [
                    'Chaotisch patroon',
                    'Geen herkenbare complexen',
                    'DEFIBRILLATIE nodig'
                ]
            },

            idioventricular: {
                id: 'idioventricular',
                name: 'Idioventriculair Ritme',
                shortName: 'IVR',
                category: 'ventricular',
                difficulty: 'medium',
                urgency: 'medium',
                description: 'Escape ritme vanuit ventrikel (20-40/min)',
                characteristics: {
                    rate: { min: 20, max: 40, typical: 35 },
                    rhythm: 'Regelmatig',
                    pWave: 'Kan aanwezig zijn (AV-dissociatie)',
                    qrsComplex: { duration: '>120ms' }
                },
                ecgFeatures: [
                    'Breed QRS-complex',
                    'Traag (20-40/min)',
                    'Regelmatig',
                    'Kan laatste redmiddel zijn bij totaal AV-blok'
                ],
                clinicalSignificance: 'Teken van ernstige geleidingsstoornis',
                commonCauses: ['Compleet hartblok', 'Ernstige sinusbradycardie', 'Medicatie-toxiciteit'],
                treatment: 'Atropine, pacing, behandel oorzaak',
                waveformParams: {
                    qrsWidth: 0.16,
                    slow: true
                },
                quizHints: [
                    'Breed complex, zeer traag',
                    'Escape ritme',
                    '20-40/min'
                ]
            },

            aivr: {
                id: 'aivr',
                name: 'Accelerated Idioventriculair Ritme',
                shortName: 'AIVR',
                category: 'ventricular',
                difficulty: 'medium',
                urgency: 'low',
                description: 'Versneld ventriculair escape ritme (40-100/min)',
                characteristics: {
                    rate: { min: 40, max: 100, typical: 70 },
                    rhythm: 'Regelmatig',
                    pWave: 'AV-dissociatie of retrograad',
                    qrsComplex: { duration: '>120ms' }
                },
                ecgFeatures: [
                    'Breed QRS-complex',
                    'Frequentie 40-100/min',
                    'Regelmatig',
                    '"Slow VT" maar benigne'
                ],
                clinicalSignificance: 'Vaak reperfusie-aritmie na MI, meestal benigne',
                commonCauses: ['Reperfusie na STEMI', 'Digoxine toxiciteit', 'Cardiomyopathie'],
                treatment: 'Meestal geen behandeling, monitoring',
                waveformParams: {
                    qrsWidth: 0.14,
                    moderate: true
                },
                quizHints: [
                    'Breed complex, 40-100/min',
                    'Vaak na reperfusie',
                    'Benigne, geen behandeling'
                ]
            },

            // ==================== AV-BLOKKEN ====================
            avblock_1st: {
                id: 'avblock_1st',
                name: 'Eerstegraads AV-blok',
                shortName: 'AV-I',
                category: 'blocks',
                difficulty: 'easy',
                urgency: 'none',
                description: 'Vertraagde geleiding door AV-knoop (PR > 200ms)',
                characteristics: {
                    rate: { min: 50, max: 100, typical: 70 },
                    rhythm: 'Regelmatig',
                    pWave: 'Normaal',
                    prInterval: { min: 201, max: 400, unit: 'ms', abnormal: true },
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'PR-interval > 200ms (> 1 groot hokje)',
                    'Elke P-golf gevolgd door QRS',
                    'Constante PR-interval',
                    '1:1 geleiding behouden'
                ],
                clinicalSignificance: 'Meestal benigne, kan progressief zijn',
                commonCauses: [
                    'Verhoogde vagale tonus',
                    'Medicatie (bètablokkers, digoxine)',
                    'Myocarditis',
                    'Ischemie',
                    'Veroudering'
                ],
                treatment: 'Meestal geen, monitoring, evalueer medicatie',
                waveformParams: {
                    prInterval: 0.28,
                    pHeight: 0.15,
                    rHeight: 1.0
                },
                quizHints: [
                    'PR > 200ms maar constant',
                    '1:1 geleiding intact',
                    'Verlenging is consistent'
                ]
            },

            avblock_2nd_type1: {
                id: 'avblock_2nd_type1',
                name: 'Tweedegraads AV-blok Type I (Wenckebach)',
                shortName: 'AV-II-I',
                category: 'blocks',
                difficulty: 'medium',
                urgency: 'low',
                description: 'Progressieve PR-verlenging tot een P-golf niet geleidt',
                characteristics: {
                    rate: { min: 40, max: 80, typical: 60 },
                    rhythm: 'Groepsgewijs onregelmatig',
                    pWave: 'Meer P-golven dan QRS-complexen',
                    prInterval: 'Progressief verlengend',
                    qrsComplex: { min: 60, max: 100, unit: 'ms' }
                },
                ecgFeatures: [
                    'Progressieve PR-verlenging',
                    'Uitgevallen QRS (dropped beat)',
                    'Kortste PR direct na pauze',
                    'Groepsgewijs patroon'
                ],
                clinicalSignificance: 'Meestal benigne, zelden progressie naar hogergradig blok',
                commonCauses: [
                    'Medicatie (digoxine, bètablokkers)',
                    'Inferieur MI',
                    'Myocarditis',
                    'Verhoogde vagale tonus'
                ],
                treatment: 'Meestal observatie, stop uitlokkende medicatie',
                waveformParams: {
                    wenckebach: true,
                    initialPR: 0.18,
                    prIncrement: 0.04,
                    cycleLength: 4
                },
                quizHints: [
                    'PR wordt steeds langer',
                    'Dan dropped beat',
                    'Patroon herhaalt zich'
                ]
            },

            avblock_2nd_type2: {
                id: 'avblock_2nd_type2',
                name: 'Tweedegraads AV-blok Type II (Mobitz II)',
                shortName: 'AV-II-II',
                category: 'blocks',
                difficulty: 'hard',
                urgency: 'high',
                description: 'Intermitterende niet-geleiding zonder PR-verlenging',
                characteristics: {
                    rate: { min: 30, max: 70, typical: 50 },
                    rhythm: 'Regelmatig met dropped beats',
                    pWave: 'Meer P-golven dan QRS-complexen',
                    prInterval: 'Constant voor geleide slagen',
                    qrsComplex: 'Vaak breed (bundeltakblok)'
                },
                ecgFeatures: [
                    'Constant PR-interval voor geleide slagen',
                    'Plotselinge dropped beats',
                    'Vaak geassocieerd met breed QRS',
                    'Kan 2:1, 3:1 of onregelmatig zijn'
                ],
                clinicalSignificance: 'ERNSTIG - Hoog risico op compleet blok',
                commonCauses: [
                    'Anterieur MI',
                    'Fibrose geleidingssysteem',
                    'Cardiomyopathie',
                    'Na hartchirurgie'
                ],
                treatment: 'Pacemakerindicatie, transcutane pacing als bridge',
                waveformParams: {
                    mobitzII: true,
                    constantPR: 0.16,
                    qrsWidth: 0.14,
                    conductionRatio: '3:2'
                },
                quizHints: [
                    'PR constant, dan ineens dropped beat',
                    'Geen progressieve verlenging',
                    'Vaak breed QRS = infranodaal'
                ]
            },

            avblock_3rd: {
                id: 'avblock_3rd',
                name: 'Derdegraads AV-blok (Compleet Hartblok)',
                shortName: 'CHB',
                category: 'blocks',
                difficulty: 'medium',
                urgency: 'critical',
                description: 'Totale dissociatie tussen atria en ventrikels',
                characteristics: {
                    rate: { min: 20, max: 60, typical: 40 },
                    rhythm: 'Regelmatig P, regelmatig QRS, maar onafhankelijk',
                    pWave: 'Aanwezig, marcheren door QRS',
                    prInterval: 'Variabel (geen relatie)',
                    qrsComplex: 'Smal of breed afhankelijk van escape'
                },
                ecgFeatures: [
                    'Volledig onafhankelijke P en QRS',
                    'P-frequentie > QRS-frequentie',
                    'Escape ritme (junctioneel of ventriculair)',
                    'P-golven "marcheren door" QRS'
                ],
                clinicalSignificance: 'LEVENSBEDREIGENDE ARITMIE - URGENT',
                commonCauses: [
                    'Inferieur MI',
                    'Anterieur MI (ernstiger)',
                    'Medicatie toxiciteit',
                    'Lyme ziekte',
                    'Congenitaal',
                    'Na hartchirurgie'
                ],
                treatment: 'Pacemaker, overbrugging met atropine/transcutane pacing',
                medications: {
                    bridge: ['Atropine 0,5mg IV herhaald elke 3-5 min (max 3mg)', 'Transcutane pacing', 'Isoproterenol'],
                    definitive: ['Transveneuze pacing', 'Permanente pacemaker']
                },
                waveformParams: {
                    completeDissociation: true,
                    pRate: 80,
                    escapeRate: 35,
                    escapeWidth: 0.14
                },
                quizHints: [
                    'P en QRS volledig los van elkaar',
                    'Regelmatige P-golven, regelmatige QRS',
                    'Maar zonder relatie = AV-dissociatie'
                ]
            },

            // ==================== BUNDELTAK BLOKKEN ====================
            rbbb: {
                id: 'rbbb',
                name: 'Rechterbundeltakblok',
                shortName: 'RBBB',
                category: 'blocks',
                difficulty: 'medium',
                urgency: 'low',
                description: 'Vertraagde geleiding door rechter bundeltak',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 75 },
                    rhythm: 'Regelmatig',
                    pWave: 'Normaal',
                    prInterval: { min: 120, max: 200, unit: 'ms' },
                    qrsComplex: { duration: '>120ms' }
                },
                ecgFeatures: [
                    'QRS ≥ 120ms',
                    'rSR\' patroon V1-V2 ("M-patroon", "konijnenoren")',
                    'Brede S-golf in I, aVL, V5-V6',
                    'ST-depressie en T-inversie V1-V3 (secundair)'
                ],
                clinicalSignificance: 'Kan normaal zijn, of wijzen op rechtszijdige pathologie',
                commonCauses: [
                    'Normaal variant',
                    'Longembolie',
                    'Pulmonale hypertensie',
                    'Cor pulmonale',
                    'ASD'
                ],
                treatment: 'Geen specifieke behandeling, onderliggende oorzaak',
                waveformParams: {
                    rsrPattern: true,
                    qrsWidth: 0.14,
                    v1Morphology: 'rsR',
                    wideSinV6: true
                },
                quizHints: [
                    'Breed QRS met "M" in V1',
                    'William Morrow: WiLLiaM = LBBB, MaRRoW = RBBB',
                    'Brede S in I en V6'
                ]
            },

            lbbb: {
                id: 'lbbb',
                name: 'Linkerbundeltakblok',
                shortName: 'LBBB',
                category: 'blocks',
                difficulty: 'medium',
                urgency: 'medium',
                description: 'Vertraagde geleiding door linker bundeltak',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 75 },
                    rhythm: 'Regelmatig',
                    pWave: 'Normaal',
                    prInterval: { min: 120, max: 200, unit: 'ms' },
                    qrsComplex: { duration: '>120ms' }
                },
                ecgFeatures: [
                    'QRS ≥ 120ms',
                    'Breed, genoteerd R in I, aVL, V5-V6',
                    'rS of QS in V1-V3',
                    'Geen septale Q in I, V5-V6',
                    'Afwezige R-progressie V1-V3',
                    'Concordante of discordante ST-T veranderingen'
                ],
                clinicalSignificance: 'Vaak geassocieerd met structurele hartziekte, maskeert MI',
                commonCauses: [
                    'Hypertensie',
                    'Coronairlijden',
                    'Cardiomyopathie',
                    'Aortastenose',
                    'Na MI'
                ],
                treatment: 'Behandel onderliggende oorzaak; bij nieuw/vermoedelijk nieuw LBBB met ischemische klachten: behandel als hoog-risico ACS en beoordeel aanvullend (o.a. Sgarbossa/modified Sgarbossa, seriële ECG/troponine)',
                clinicalPearl: 'Nieuw LBBB alléén bewijst geen STEMI; combineer met kliniek en aanvullende ischemiecriteria.',
                waveformParams: {
                    broadR: true,
                    qrsWidth: 0.16,
                    v1Morphology: 'QS',
                    v6Morphology: 'broadR'
                },
                quizHints: [
                    'Breed QRS met brede R in V6, I',
                    'QS in V1',
                    'Nieuw LBBB + ischemische klachten = hoog-risico ACS'
                ]
            },

            lafb: {
                id: 'lafb',
                name: 'Linker Anterior Fasciculair Blok',
                shortName: 'LAFB',
                category: 'blocks',
                difficulty: 'hard',
                urgency: 'none',
                description: 'Blok van voorste tak van linker bundeltak',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 75 },
                    rhythm: 'Regelmatig',
                    pWave: 'Normaal',
                    qrsComplex: { duration: '100-120ms' }
                },
                ecgFeatures: [
                    'Linker asdeviatie (-45° tot -90°)',
                    'qR in I, aVL',
                    'rS in II, III, aVF',
                    'QRS < 120ms',
                    'Kleine q in I, aVL (septale activatie)'
                ],
                clinicalSignificance: 'Meestal benigne, kan wijzen op onderliggende hartziekte',
                commonCauses: ['Hypertensie', 'Coronairlijden', 'Cardiomyopathie', 'Fibrose'],
                treatment: 'Geen specifieke behandeling',
                waveformParams: {
                    leftAxisDeviation: true,
                    axis: -60
                },
                quizHints: [
                    'Extreme linker as (-45° tot -90°)',
                    'QRS normaal of licht verbreed',
                    'qR in I, rS in III'
                ]
            },

            lpfb: {
                id: 'lpfb',
                name: 'Linker Posterior Fasciculair Blok',
                shortName: 'LPFB',
                category: 'blocks',
                difficulty: 'hard',
                urgency: 'low',
                description: 'Blok van achterste tak van linker bundeltak',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 75 },
                    rhythm: 'Regelmatig',
                    pWave: 'Normaal',
                    qrsComplex: { duration: '100-120ms' }
                },
                ecgFeatures: [
                    'Rechter asdeviatie (+90° tot +180°)',
                    'rS in I, aVL',
                    'qR in II, III, aVF',
                    'QRS < 120ms',
                    'Exclusie andere oorzaken RAD'
                ],
                clinicalSignificance: 'Zeldzaam, vaker geassocieerd met significante hartziekte dan LAFB',
                commonCauses: ['Coronairlijden', 'Cardiomyopathie', 'Congenitaal'],
                treatment: 'Geen specifieke behandeling, evalueer voor hartziekte',
                waveformParams: {
                    rightAxisDeviation: true,
                    axis: 110
                },
                quizHints: [
                    'Rechter as (+90° tot +180°)',
                    'Zeldzamer dan LAFB',
                    'Sluit andere oorzaken RAD uit'
                ]
            },

            bifascicular: {
                id: 'bifascicular',
                name: 'Bifasciculair Blok',
                shortName: 'BFB',
                category: 'blocks',
                difficulty: 'hard',
                urgency: 'medium',
                description: 'Combinatie van RBBB + LAFB of RBBB + LPFB',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 70 },
                    rhythm: 'Regelmatig',
                    qrsComplex: { duration: '>120ms' }
                },
                ecgFeatures: [
                    'RBBB morfologie + linker of rechter asdeviatie',
                    'Meest voorkomend: RBBB + LAFB',
                    'Bij toevoegen 1e graads blok: trifasciculair'
                ],
                clinicalSignificance: 'Verhoogd risico op progressie naar compleet hartblok',
                commonCauses: ['Coronairlijden', 'Cardiomyopathie', 'Degeneratief'],
                treatment: 'Monitoring, mogelijk pacemaker bij symptomen',
                waveformParams: {
                    rbbb: true,
                    lafb: true
                },
                quizHints: [
                    'RBBB + extreme linker as = RBBB + LAFB',
                    'RBBB + extreme rechter as = RBBB + LPFB',
                    'Let op progressie'
                ]
            },

            // ==================== ISCHEMIE & INFARCTEN ====================
            stemi_anterior: {
                id: 'stemi_anterior',
                name: 'Anterieur STEMI',
                shortName: 'Ant STEMI',
                category: 'ischemia',
                difficulty: 'medium',
                urgency: 'critical',
                description: 'ST-elevatie infarct van voorwand door LAD occlusie',
                characteristics: {
                    territory: 'Anterior (V1-V4)',
                    artery: 'LAD',
                    reciprocal: 'Inferior afleidingen (II, III, aVF)'
                },
                ecgFeatures: [
                    'ST-elevatie V1-V4 (soms V5-V6)',
                    'Reciproke ST-depressie in II, III, aVF',
                    'Hyperacute T-golven vroeg',
                    'Kan evolueren naar Q-golven',
                    'Uitgebreid: ook ST↑ in I, aVL'
                ],
                clinicalSignificance: 'GROOT INFARCT - hoge mortaliteit zonder reperfusie',
                riskArea: 'Grote hoeveelheid myocard, risico op hartfalen',
                treatment: 'PRIMAIRE PCI < 90 min (of fibrinolyse als PCI niet beschikbaar)',
                timing: {
                    hyperacute: 'Hoge spitse T-golven',
                    acute: 'ST-elevatie, begin Q-vorming',
                    subacute: 'T-inversie, Q-golven',
                    old: 'Persisterende Q-golven'
                },
                waveformParams: {
                    stElevation: 0.3,
                    elevationLeads: ['V2', 'V3', 'V4'],
                    reciprocalDepression: ['III', 'aVF'],
                    hyperacuteT: true
                },
                quizHints: [
                    'ST↑ V1-V4 = anterieur (LAD)',
                    'Reciprook: inferior depressie',
                    'DIRECT cath lab!'
                ]
            },

            stemi_inferior: {
                id: 'stemi_inferior',
                name: 'Inferieur STEMI',
                shortName: 'Inf STEMI',
                category: 'ischemia',
                difficulty: 'medium',
                urgency: 'critical',
                description: 'ST-elevatie infarct van onderwand door RCA of LCx occlusie',
                characteristics: {
                    territory: 'Inferior (II, III, aVF)',
                    artery: 'RCA (80%) of LCx (20%)',
                    reciprocal: 'Anterior afleidingen (I, aVL)'
                },
                ecgFeatures: [
                    'ST-elevatie II, III, aVF',
                    'ST III > ST II suggereert RCA',
                    'Reciproke ST-depressie I, aVL',
                    'Check V4R voor rechterventrikel betrokkenheid',
                    'ST-depressie V1-V3 kan wijzen op posterieure extensie'
                ],
                clinicalSignificance: 'Risico op bradycardie/blok bij RCA, RV infarct',
                complications: ['AV-blok', 'RV infarct', 'Bradycardie'],
                treatment: 'Primaire PCI, voorzichtig met nitraten bij RV betrokkenheid',
                waveformParams: {
                    stElevation: 0.25,
                    elevationLeads: ['II', 'III', 'aVF'],
                    reciprocalDepression: ['I', 'aVL']
                },
                quizHints: [
                    'ST↑ II, III, aVF = inferior',
                    'Check V4R voor RV infarct',
                    'Let op bradycardie/blok'
                ]
            },

            stemi_lateral: {
                id: 'stemi_lateral',
                name: 'Lateraal STEMI',
                shortName: 'Lat STEMI',
                category: 'ischemia',
                difficulty: 'medium',
                urgency: 'critical',
                description: 'ST-elevatie infarct van laterale wand',
                characteristics: {
                    territory: 'Lateral (I, aVL, V5-V6)',
                    artery: 'LCx of diagonale tak LAD',
                    reciprocal: 'III, aVF'
                },
                ecgFeatures: [
                    'ST-elevatie I, aVL',
                    'ST-elevatie V5, V6 (laag lateraal)',
                    'Reciproke ST-depressie III, aVF',
                    'Kan geïsoleerd of met anterior/inferior'
                ],
                clinicalSignificance: 'Kan wijzen op LCx occlusie',
                treatment: 'Primaire PCI',
                waveformParams: {
                    stElevation: 0.2,
                    elevationLeads: ['I', 'aVL', 'V6'],
                    reciprocalDepression: ['III']
                },
                quizHints: [
                    'ST↑ I, aVL ± V5-V6',
                    'Hoog lateraal vs laag lateraal',
                    'LCx of diagonaal'
                ]
            },

            stemi_posterior: {
                id: 'stemi_posterior',
                name: 'Posterieur STEMI',
                shortName: 'Post STEMI',
                category: 'ischemia',
                difficulty: 'hard',
                urgency: 'critical',
                description: 'ST-elevatie infarct van achterwand (spiegelbeeld in V1-V3)',
                characteristics: {
                    territory: 'Posterior',
                    artery: 'LCx of RCA',
                    reciprocal: 'V1-V3 (eigenlijk directe tekenen gespiegeld)'
                },
                ecgFeatures: [
                    'ST-depressie V1-V3 (spiegelbeeld van elevatie)',
                    'Hoge R-golf V1 (spiegelbeeld van Q)',
                    'Positieve T-golf V1-V2 (spiegelbeeld inversie)',
                    'ST-elevatie in V7-V9 (posterior afleidingen)',
                    'Vaak samen met inferieur STEMI'
                ],
                clinicalSignificance: 'Vaak gemist! Zoek naar bij inferior STEMI',
                treatment: 'Primaire PCI',
                clinicalPearl: 'ST-depressie V1-V3 met hoge R = posterior STEMI!',
                waveformParams: {
                    stDepression: 0.2,
                    depressionLeads: ['V1', 'V2', 'V3'],
                    tallR: true
                },
                quizHints: [
                    'ST-depressie V1-V3 = denk posterior',
                    'Hoge R V1 = "Q-golf equivalent"',
                    'Maak V7-V9 voor bevestiging'
                ]
            },

            nstemi: {
                id: 'nstemi',
                name: 'NSTEMI / Instabiele Angina',
                shortName: 'NSTEMI',
                category: 'ischemia',
                difficulty: 'medium',
                urgency: 'high',
                description: 'Acuut coronair syndroom zonder ST-elevatie',
                characteristics: {
                    rate: { min: 60, max: 120, typical: 90 },
                    rhythm: 'Variabel',
                    ecgChanges: 'ST-depressie en/of T-golf veranderingen'
                },
                ecgFeatures: [
                    'ST-depressie (horizontaal of downsloping)',
                    'T-golf inversie (symmetrisch, diep)',
                    'Geen ST-elevatie (behalve aVR)',
                    'Dynamische veranderingen',
                    'ST-elevatie aVR kan wijzen op LM/3-vats'
                ],
                clinicalSignificance: 'ACS - urgent maar niet direct cath lab (binnen 24-72u)',
                treatment: 'Antitrombotische therapie, risicostratificatie, coronair angiografie',
                medications: {
                    immediate: ['Aspirine', 'Heparine', 'P2Y12 remmer'],
                    supportive: ['Bètablokker', 'Nitraat', 'Morfine indien pijn']
                },
                waveformParams: {
                    stDepression: 0.15,
                    tInversion: true
                },
                quizHints: [
                    'ST-depressie, geen elevatie',
                    'T-inversie (symmetrisch)',
                    'Troponine bepaalt NSTEMI vs UA'
                ]
            },

            wellens: {
                id: 'wellens',
                name: "Wellens' Syndroom",
                shortName: 'Wellens',
                category: 'ischemia',
                difficulty: 'hard',
                urgency: 'high',
                description: 'T-golf patroon voorspellend voor kritieke LAD stenose',
                characteristics: {
                    territory: 'Anterior',
                    artery: 'Proximale LAD'
                },
                ecgFeatures: [
                    'Type A (25%): Bifasische T-golf V2-V3 (positief-negatief)',
                    'Type B (75%): Diepe symmetrische T-inversie V2-V3',
                    'Minimale of geen ST-elevatie',
                    'Geen significant Q-verlies',
                    'Normale of minimaal verhoogde enzymen'
                ],
                clinicalSignificance: 'KRITIEKE LAD STENOSE - hoog risico op anterior MI',
                clinicalPearl: 'GEEN inspanningstest! Direct coronairangiografie',
                treatment: 'Coronairangiografie, waarschijnlijk revascularisatie',
                waveformParams: {
                    wellensTypeB: true,
                    deepTInversion: 0.5,
                    leads: ['V2', 'V3']
                },
                quizHints: [
                    'Diepe symmetrische T-inversie V2-V3',
                    'Pijnvrij moment',
                    'Kritieke LAD = direct angio'
                ]
            },

            deWinter: {
                id: 'deWinter',
                name: 'De Winter T-golven',
                shortName: 'De Winter',
                category: 'ischemia',
                difficulty: 'hard',
                urgency: 'critical',
                description: 'STEMI-equivalent met upsloping ST-depressie en hoge T-golven',
                characteristics: {
                    territory: 'Anterior',
                    artery: 'Proximale LAD'
                },
                ecgFeatures: [
                    'Upsloping ST-depressie > 1mm J-punt V1-V6',
                    'Hoge, symmetrische, spitse T-golven V1-V6',
                    'Geen ST-elevatie precordiaal',
                    'ST-elevatie 1-2mm in aVR',
                    'Kan persisteren tijdens occlusie'
                ],
                clinicalSignificance: 'STEMI-EQUIVALENT - direct naar cath lab!',
                clinicalPearl: 'Kan zonder klassiek STEMI-patroon persisteren; behandel als acute coronairocclusie (STEMI-equivalent).',
                treatment: 'Behandelen als STEMI - primaire PCI',
                waveformParams: {
                    upSlopingSTdep: true,
                    tallSymmetricT: true,
                    aVRelevation: true
                },
                quizHints: [
                    'Upsloping ST-depressie V1-V6',
                    'Hoge spitse T-golven',
                    'STEMI-equivalent!'
                ]
            },

            // ==================== PACEMAKER RITMES ====================
            paced_ventricular: {
                id: 'paced_ventricular',
                name: 'Ventriculair Gepaced Ritme',
                shortName: 'VVI',
                category: 'pacemaker',
                difficulty: 'medium',
                urgency: 'none',
                description: 'Ventriculaire pacing met breed QRS na pacemaker spike',
                characteristics: {
                    rate: { min: 60, max: 80, typical: 70 },
                    rhythm: 'Regelmatig',
                    pWave: 'Kan aanwezig zijn (niet gerelateerd)',
                    qrsComplex: 'Breed met LBBB morfologie'
                },
                ecgFeatures: [
                    'Pacemaker spike voor QRS',
                    'Breed QRS (LBBB-achtig)',
                    'Regelmatig interval',
                    'Geen relatie met P-golven (VVI)',
                    'ST-T afwijkingen secundair aan pacing'
                ],
                clinicalSignificance: 'Normale pacemaker functie',
                treatment: 'Pacemaker controle, batterij check',
                waveformParams: {
                    pacingSpike: true,
                    qrsWidth: 0.16,
                    lbbbMorphology: true
                },
                quizHints: [
                    'Spike → breed QRS',
                    'LBBB morfologie (RV apex pacing)',
                    'Regelmatig ritme'
                ]
            },

            paced_dual: {
                id: 'paced_dual',
                name: 'Dual Chamber Pacing (DDD)',
                shortName: 'DDD',
                category: 'pacemaker',
                difficulty: 'hard',
                urgency: 'none',
                description: 'Atriale en ventriculaire pacing met sensing in beide kamers',
                characteristics: {
                    rate: { min: 60, max: 130, typical: 70 },
                    rhythm: 'Regelmatig',
                    pWave: 'Gepaced of eigen P',
                    qrsComplex: 'Gepaced of eigen QRS'
                },
                ecgFeatures: [
                    'Atriale spike → P-golf',
                    'Ventriculaire spike → QRS',
                    'AV-interval geprogrammeerd',
                    'Kan 4 patronen tonen: AP-VP, AP-VS, AS-VP, AS-VS'
                ],
                clinicalSignificance: 'Meest fysiologische pacing mode',
                treatment: 'Reguliere pacemaker controle',
                waveformParams: {
                    atrialSpike: true,
                    ventricularSpike: true,
                    avDelay: 0.16
                },
                quizHints: [
                    'Twee spikes mogelijk (A en V)',
                    'AV-synchronie behouden',
                    'Meest voorkomende pacemaker'
                ]
            },

            pacemaker_malfunction: {
                id: 'pacemaker_malfunction',
                name: 'Pacemaker Dysfunctie',
                shortName: 'PM Dysfunctie',
                category: 'pacemaker',
                difficulty: 'hard',
                urgency: 'high',
                description: 'Failure to pace, capture, of sense',
                characteristics: {
                    rhythm: 'Onregelmatig of afwezig pacing'
                },
                ecgFeatures: [
                    'Failure to pace: geen spikes wanneer verwacht',
                    'Failure to capture: spike zonder QRS',
                    'Failure to sense (undersensing): spike op eigen slag',
                    'Oversensing: geen pacing door onterecht sensed signaal'
                ],
                clinicalSignificance: 'Kan levensbedreigend zijn afhankelijk van onderliggend ritme',
                commonCauses: [
                    'Batterij uitputting',
                    'Lead dislocatie',
                    'Lead fractuur',
                    'Verhoogde drempel',
                    'EMI interferentie'
                ],
                treatment: 'Magnet applicatie, transcutane pacing, urgente PM check',
                waveformParams: {
                    malfunction: true
                },
                quizHints: [
                    'Spike zonder QRS = failure to capture',
                    'Geen spike = failure to pace',
                    'Spike op eigen QRS = undersensing'
                ]
            },

            // ==================== ELEKTROLYTSTOORNISSEN ====================
            hyperkalemia: {
                id: 'hyperkalemia',
                name: 'Hyperkaliëmie',
                shortName: 'Hyper-K',
                category: 'other',
                difficulty: 'medium',
                urgency: 'high',
                description: 'ECG veranderingen door verhoogd kalium',
                characteristics: {
                    potassiumLevel: '> 5.5 mmol/L'
                },
                ecgFeatures: [
                    'Vroeg (5.5-6.5): Spitse, tenting T-golven',
                    'Matig (6.5-7.5): PR-verlenging, afvlakking P',
                    'Ernstig (7.5-8.5): Breed QRS, verlies P',
                    'Kritiek (>8.5): Sinusgolf patroon → VF/asystolie'
                ],
                progression: [
                    { level: '5.5-6.0', finding: 'Spitse T-golven' },
                    { level: '6.0-7.0', finding: 'PR verlenging' },
                    { level: '7.0-8.0', finding: 'P afvlakking, QRS verbreding' },
                    { level: '8.0+', finding: 'Sinusgolf, VF risico' }
                ],
                clinicalSignificance: 'LEVENSBEDREIGENDE elektrolytstoornis',
                treatment: 'Calcium IV (cardioprotectie), Insulin/glucose, Salbutamol, Dialyse',
                medications: {
                    immediate: ['Calciumgluconaat 10ml 10% IV', 'Calcium stabiliseert membraan'],
                    shift: ['Insuline 10E + Glucose 50ml 50%', 'Salbutamol 10-20mg neb'],
                    remove: ['Resonium', 'Dialyse']
                },
                waveformParams: {
                    tentedT: true,
                    wideQRS: true,
                    flatP: true
                },
                quizHints: [
                    'Spitse T-golven = eerste teken',
                    'Progressie: T → P → QRS → sinusgolf',
                    'Calcium IV = eerste actie'
                ]
            },

            hypokalemia: {
                id: 'hypokalemia',
                name: 'Hypokaliëmie',
                shortName: 'Hypo-K',
                category: 'other',
                difficulty: 'medium',
                urgency: 'medium',
                description: 'ECG veranderingen door verlaagd kalium',
                characteristics: {
                    potassiumLevel: '< 3.5 mmol/L'
                },
                ecgFeatures: [
                    'Afvlakking T-golven',
                    'U-golven (na T-golf)',
                    'ST-depressie',
                    'Verlengd QT (QU) interval',
                    'Verhoogd aritmie risico (PAC, PVC, VT)'
                ],
                clinicalSignificance: 'Verhoogd risico op aritmieën, vooral bij digoxine gebruik',
                commonCauses: ['Diuretica', 'Braken/diarree', 'Insuline therapie'],
                treatment: 'Kalium suppletie PO of IV',
                waveformParams: {
                    flatT: true,
                    prominentU: true,
                    stDepression: true
                },
                quizHints: [
                    'U-golf = kenmerkend',
                    'T afvlakking, ST depressie',
                    'QT lijkt verlengd (eigenlijk QU)'
                ]
            },

            hypercalcemia: {
                id: 'hypercalcemia',
                name: 'Hypercalciëmie',
                shortName: 'Hyper-Ca',
                category: 'other',
                difficulty: 'hard',
                urgency: 'medium',
                description: 'ECG veranderingen door verhoogd calcium',
                characteristics: {
                    calciumLevel: '> 2.6 mmol/L'
                },
                ecgFeatures: [
                    'Verkort QT-interval',
                    'Verkorte ST-segment (bijna afwezig)',
                    'Osborn golven bij ernstige gevallen'
                ],
                clinicalSignificance: 'Kan wijzen op maligniteit, hyperparathyreoïdie',
                treatment: 'Hydratie, bisfosfonaten, behandel oorzaak',
                waveformParams: {
                    shortQT: true,
                    shortST: true
                },
                quizHints: [
                    'Kort QT-interval',
                    'ST-segment bijna afwezig',
                    '"Short QT = high calcium"'
                ]
            },

            hypocalcemia: {
                id: 'hypocalcemia',
                name: 'Hypocalciëmie',
                shortName: 'Hypo-Ca',
                category: 'other',
                difficulty: 'hard',
                urgency: 'medium',
                description: 'ECG veranderingen door verlaagd calcium',
                characteristics: {
                    calciumLevel: '< 2.1 mmol/L'
                },
                ecgFeatures: [
                    'Verlengd QT-interval',
                    'Verlengd ST-segment',
                    'T-golf kan normaal zijn'
                ],
                clinicalSignificance: 'Risico op aritmieën bij ernstige hypocalciëmie',
                treatment: 'Calcium suppletie IV bij symptomen',
                waveformParams: {
                    longQT: true,
                    longST: true
                },
                quizHints: [
                    'Lang QT door lang ST-segment',
                    'T-golf zelf vaak normaal',
                    '"Long QT = low calcium"'
                ]
            },

            // ==================== OVERIGE ====================
            asystole: {
                id: 'asystole',
                name: 'Asystolie',
                shortName: 'Asystole',
                category: 'ventricular',
                difficulty: 'easy',
                urgency: 'critical',
                description: 'Afwezigheid van ventriculaire elektrische activiteit',
                characteristics: {
                    rate: 0,
                    rhythm: 'Geen'
                },
                ecgFeatures: [
                    'Vlakke lijn of minimale artefacten',
                    'Geen QRS-complexen',
                    'Soms nog P-golven zichtbaar (P-golf asystolie)',
                    'Bevestig in meerdere afleidingen'
                ],
                clinicalSignificance: 'HARTSTILSTAND',
                treatment: 'CPR, adrenaline, reversibele oorzaken behandelen (4H/4T)',
                waveformParams: {
                    flatline: true,
                    possiblePwaves: true
                },
                quizHints: [
                    'Vlakke lijn',
                    'Check kabels/afleidingen',
                    'Geen schokbaar ritme'
                ]
            },

            pea: {
                id: 'pea',
                name: 'Polsloze Elektrische Activiteit',
                shortName: 'PEA',
                category: 'other',
                difficulty: 'medium',
                urgency: 'critical',
                description: 'Georganiseerd ECG ritme zonder tastbare pols',
                characteristics: {
                    rate: 'Variabel',
                    rhythm: 'Kan georganiseerd zijn',
                    pulse: 'AFWEZIG'
                },
                ecgFeatures: [
                    'Elke georganiseerd ritme mogelijk',
                    'Vaak sinus of traag ritme',
                    'Kan QRS-complexen tonen',
                    'GEEN palpabele pols'
                ],
                clinicalSignificance: 'HARTSTILSTAND - zoek reversibele oorzaken',
                reversibleCauses: {
                    '4H': ['Hypoxie', 'Hypovolemie', 'Hypo/hyperkaliëmie', 'Hypothermie'],
                    '4T': ['Tensie pneumothorax', 'Tamponade', 'Toxines', 'Trombose (coronair/pulmonaal)']
                },
                treatment: 'CPR, adrenaline, behandel oorzaak',
                waveformParams: {
                    organizedRhythm: true,
                    noPulse: true
                },
                quizHints: [
                    'Ritme op monitor, geen pols',
                    'Behandel als hartstilstand',
                    'Zoek 4H en 4T'
                ]
            },

            wpw: {
                id: 'wpw',
                name: 'Wolff-Parkinson-White Syndroom',
                shortName: 'WPW',
                category: 'other',
                difficulty: 'hard',
                urgency: 'medium',
                description: 'Pre-excitatie door accessoire bundel',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 75 },
                    rhythm: 'Regelmatig (sinusritme)'
                },
                ecgFeatures: [
                    'Kort PR-interval (< 120ms)',
                    'Delta golf (slurring upstroke QRS)',
                    'Breed QRS (> 100ms)',
                    'Secundaire ST-T veranderingen'
                ],
                clinicalSignificance: 'Risico op AVRT en snel AF met brede complexen',
                treatment: 'Ablatie, vermijd AV-knoop blokkers bij AF',
                warning: 'GEEN digoxine/verapamil bij AF - kan VF veroorzaken!',
                waveformParams: {
                    shortPR: true,
                    deltaWave: true,
                    wideQRS: true
                },
                quizHints: [
                    'Kort PR + delta golf + breed QRS',
                    'Let op bij AF!',
                    'Geen AV-knoop blokkers bij breed complex AF'
                ]
            },

            brugada: {
                id: 'brugada',
                name: 'Brugada Syndroom',
                shortName: 'Brugada',
                category: 'other',
                difficulty: 'hard',
                urgency: 'high',
                description: 'Genetische ionkanaal aandoening met VF risico',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 70 },
                    rhythm: 'Sinusritme (maar risico op VF)'
                },
                ecgFeatures: [
                    'Type 1: Coved ST-elevatie ≥ 2mm V1-V2 met negatieve T',
                    'Type 2: Saddleback ST-elevatie',
                    'RBBB of RBBB-achtig patroon',
                    'Kan dynamisch zijn of uitgelokt door koorts'
                ],
                clinicalSignificance: 'Hoog risico op plotse hartdood',
                treatment: 'ICD bij hoog-risico patiënten',
                waveformParams: {
                    covedST: true,
                    rbbbPattern: true
                },
                quizHints: [
                    'Coved ST-elevatie V1-V2',
                    'Kan uitgelokt door koorts',
                    'Jonge mannen, Aziatische afkomst'
                ]
            },

            long_qt: {
                id: 'long_qt',
                name: 'Lang QT Syndroom',
                shortName: 'LQTS',
                category: 'other',
                difficulty: 'medium',
                urgency: 'medium',
                description: 'Verlengd QT-interval met risico op TdP',
                characteristics: {
                    qtc: '> 460ms vrouwen, > 440ms mannen'
                },
                ecgFeatures: [
                    'QTc verlengd (Bazett formule)',
                    'Abnormale T-golf morfologie',
                    'Kan T-wave alternans tonen',
                    'Risico op TdP'
                ],
                clinicalSignificance: 'Risico op Torsades de Pointes en plotse dood',
                commonCauses: [
                    'Congenitaal (LQTS1, 2, 3)',
                    'Medicatie (antiarrhythmica, antibiotica, antipsychotica)',
                    'Elektrolytstoornissen (K, Mg, Ca)'
                ],
                treatment: 'Stop uitlokkende medicatie, correctie elektrolyten, bètablokker, ICD',
                waveformParams: {
                    longQT: true,
                    abnormalT: true
                },
                quizHints: [
                    'QTc > 450-460ms',
                    'Bereken QTc = QT / √RR',
                    'Check medicatie en elektrolyten'
                ]
            },

            hypothermia: {
                id: 'hypothermia',
                name: 'Hypothermie ECG',
                shortName: 'Hypothermie',
                category: 'other',
                difficulty: 'hard',
                urgency: 'high',
                description: 'ECG veranderingen bij onderkoeling',
                characteristics: {
                    temperature: '< 35°C'
                },
                ecgFeatures: [
                    'Osborn golven (J-golven) - positieve deflectie na QRS',
                    'Bradycardie',
                    'Verlengd PR, QRS, QT',
                    'Atriumfibrilleren',
                    'Bewegingsartefacten (rillen)'
                ],
                clinicalSignificance: 'Zoek naar onderkoeling, verdringingsrisico',
                treatment: 'Langzame opwarming, let op aritmieën bij opwarmen',
                waveformParams: {
                    osbornWave: true,
                    bradycardia: true,
                    prolongedIntervals: true
                },
                quizHints: [
                    'Osborn/J-golf = kenmerkend',
                    'Bradycardie, lange intervallen',
                    'Spier artefacten door rillen'
                ]
            },

            digoxin_toxicity: {
                id: 'digoxin_toxicity',
                name: 'Digoxine Effect/Toxiciteit',
                shortName: 'Dig Effect',
                category: 'other',
                difficulty: 'hard',
                urgency: 'medium',
                description: 'ECG veranderingen door digoxine',
                characteristics: {
                    therapeutic: 'Digoxine effect',
                    toxic: 'Digoxine toxiciteit'
                },
                ecgFeatures: [
                    'Therapeutisch: ST "scooping" (omgekeerde Nike swoosh)',
                    'Therapeutisch: QT verkorting',
                    'Toxisch: Elke aritmie mogelijk',
                    'Toxisch: Bidirectionele VT pathognomonisch',
                    'Toxisch: AF met regelmatig ventrikel respons',
                    'Toxisch: Versneld junctioneel ritme'
                ],
                clinicalSignificance: 'Digoxine toxiciteit kan fataal zijn',
                treatment: 'Stop digoxine, correctie K/Mg, Digibind bij ernstige toxiciteit',
                waveformParams: {
                    scoopedST: true,
                    shortQT: true
                },
                quizHints: [
                    'Salvador Dalí snor ST-segment',
                    'Bidirectionele VT = toxiciteit',
                    'AF + regelmatig = junctioneel (toxisch)'
                ]
            },

            pe_ecg: {
                id: 'pe_ecg',
                name: 'Longembolie ECG',
                shortName: 'PE ECG',
                category: 'other',
                difficulty: 'hard',
                urgency: 'high',
                description: 'ECG kenmerken bij longembolie',
                characteristics: {
                    sensitivity: 'Laag - ECG kan normaal zijn'
                },
                ecgFeatures: [
                    'Sinustachycardie (meest voorkomend)',
                    'S1Q3T3 patroon (klassiek maar zeldzaam)',
                    'RBBB (nieuw)',
                    'T-inversie V1-V4 (anterieur)',
                    'Rechter asdeviatie',
                    'Atriumfibrilleren'
                ],
                clinicalSignificance: 'ECG onvoldoende sensitief - kliniek + D-dimeer + CT-angio',
                treatment: 'Anticoagulatie, trombolyse bij massale PE',
                waveformParams: {
                    s1q3t3: true,
                    tachycardia: true,
                    tInversionV1V4: true
                },
                quizHints: [
                    'Sinustachycardie meest voorkomend',
                    'S1Q3T3 = klassiek maar zeldzaam',
                    'ECG vaak normaal bij PE'
                ]
            },

            pericarditis: {
                id: 'pericarditis',
                name: 'Pericarditis',
                shortName: 'Pericarditis',
                category: 'other',
                difficulty: 'medium',
                urgency: 'medium',
                description: 'Ontsteking van het hartzakje',
                characteristics: {
                    evolution: 'Verandert over dagen'
                },
                ecgFeatures: [
                    'Stadium 1: Diffuse ST-elevatie (concaaf/saddle-shaped)',
                    'Stadium 1: PR-depressie (behalve aVR)',
                    'Stadium 1: ST-elevatie in aVR afwezig',
                    'Stadium 2: Normalisatie ST',
                    'Stadium 3: Diffuse T-inversie',
                    'Stadium 4: Normalisatie'
                ],
                differentiatingFromSTEMI: [
                    'Diffuus (niet territoriaal)',
                    'Concave ST-elevatie',
                    'PR-depressie',
                    'Geen reciproke depressie (behalve aVR)'
                ],
                treatment: 'NSAIDs, colchicine',
                waveformParams: {
                    diffuseSTElevation: true,
                    prDepression: true,
                    concaveST: true
                },
                quizHints: [
                    'Diffuse ST↑ + PR↓',
                    'Concave ("smiley") ST-elevatie',
                    'Geen reciproke veranderingen'
                ]
            },

            junctional_rhythm: {
                id: 'junctional_rhythm',
                name: 'Junctioneel Ritme',
                shortName: 'JR',
                category: 'bradycardia',
                difficulty: 'medium',
                urgency: 'low',
                description: 'Escape ritme vanuit AV-junctie',
                characteristics: {
                    rate: { min: 40, max: 60, typical: 50 },
                    rhythm: 'Regelmatig',
                    pWave: 'Afwezig, retrograad, of na QRS',
                    qrsComplex: 'Smal'
                },
                ecgFeatures: [
                    'Smalle QRS-complexen',
                    'P-golf absent, retrograad (negatief in II), of na QRS',
                    'Regelmatig ritme 40-60/min',
                    'Geen relatie P met QRS indien AV-dissociatie'
                ],
                clinicalSignificance: 'Escape ritme - zoek naar oorzaak sinusknoop/AV falen',
                commonCauses: ['Sick sinus', 'Digoxine', 'Bètablokkers', 'Post-cardiochirurgie'],
                treatment: 'Behandel oorzaak, pacing indien symptomatisch',
                waveformParams: {
                    narrowQRS: true,
                    retrogradeP: true,
                    absentP: true
                },
                quizHints: [
                    'Smalle QRS zonder normale P',
                    'Escape ritme (40-60/min)',
                    'P kan afwezig, retrograad, of na QRS'
                ]
            },

            accelerated_junctional: {
                id: 'accelerated_junctional',
                name: 'Versneld Junctioneel Ritme',
                shortName: 'AJR',
                category: 'tachycardia',
                difficulty: 'medium',
                urgency: 'low',
                description: 'Junctioneel ritme met verhoogde frequentie',
                characteristics: {
                    rate: { min: 60, max: 100, typical: 80 },
                    rhythm: 'Regelmatig',
                    pWave: 'Afwezig of retrograad'
                },
                ecgFeatures: [
                    'Smal QRS',
                    'Frequentie 60-100/min',
                    'P-golven afwezig of retrograad'
                ],
                clinicalSignificance: 'Kan wijzen op digoxine toxiciteit of ischemie',
                commonCauses: ['Digoxine toxiciteit', 'Inferior MI', 'Post-cardiochirurgie'],
                treatment: 'Behandel oorzaak',
                waveformParams: {
                    narrowQRS: true,
                    moderateRate: true
                },
                quizHints: [
                    'Junctioneel maar 60-100/min',
                    'Denk aan digoxine toxiciteit',
                    'Vaak na inferior MI'
                ]
            }
        },

        // ========== HELPER FUNCTIES ==========
        getAllRhythms() {
            return Object.values(this.rhythms);
        },

        getRhythmById(id) {
            return this.rhythms[id] || null;
        },

        getRhythmsByCategory(category) {
            if (category === 'all') return this.getAllRhythms();
            return this.getAllRhythms().filter(r => r.category === category);
        },

        getRhythmsByDifficulty(difficulty) {
            if (difficulty === 'all') return this.getAllRhythms();
            return this.getAllRhythms().filter(r => r.difficulty === difficulty);
        },

        getRhythmsByUrgency(urgency) {
            return this.getAllRhythms().filter(r => r.urgency === urgency);
        },

        getCriticalRhythms() {
            return this.getAllRhythms().filter(r => 
                r.urgency === 'critical' || r.urgency === 'high'
            );
        },

        getRandomRhythm(options = {}) {
            let pool = this.getAllRhythms();
            
            if (options.category && options.category !== 'all') {
                pool = pool.filter(r => r.category === options.category);
            }
            if (options.difficulty && options.difficulty !== 'all') {
                pool = pool.filter(r => r.difficulty === options.difficulty);
            }
            if (options.exclude) {
                pool = pool.filter(r => !options.exclude.includes(r.id));
            }
            
            if (pool.length === 0) return null;
            return pool[Math.floor(Math.random() * pool.length)];
        },

        searchRhythms(query) {
            if (!query) return this.getAllRhythms();
            query = query.toLowerCase();
            return this.getAllRhythms().filter(r => 
                r.name.toLowerCase().includes(query) ||
                r.shortName.toLowerCase().includes(query) ||
                r.description.toLowerCase().includes(query) ||
                (r.ecgFeatures && r.ecgFeatures.some(f => f.toLowerCase().includes(query)))
            );
        },

        getDistractors(correctRhythm, count = 3) {
            const correct = this.getRhythmById(correctRhythm);
            if (!correct) return [];

            let pool = this.getAllRhythms().filter(r => r.id !== correctRhythm);
            
            // Prioriteer zelfde categorie en moeilijkheid
            const sameCat = pool.filter(r => r.category === correct.category);
            const sameDiff = pool.filter(r => r.difficulty === correct.difficulty);
            
            let prioritized = [...new Set([...sameCat, ...sameDiff])];
            if (prioritized.length < count) {
                prioritized = [...prioritized, ...pool.filter(r => !prioritized.includes(r))];
            }

            // Shuffle en selecteer
            const shuffled = prioritized.sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        },

        getCategoryStats() {
            const stats = {};
            for (const [catId, cat] of Object.entries(this.categories)) {
                stats[catId] = {
                    ...cat,
                    count: this.getRhythmsByCategory(catId).length
                };
            }
            return stats;
        }
    };

    // ==================== UTILITIES ====================
    const Utils = {
        // DOM helpers
        $(selector) {
            return document.querySelector(selector);
        },
        
        $$(selector) {
            return document.querySelectorAll(selector);
        },

        // Element creation
        createElement(tag, className, innerHTML) {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (innerHTML) el.innerHTML = innerHTML;
            return el;
        },

        // Time formatting
        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        },

        // Shuffle array
        shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        },

        // Random integer
        randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        },

        // Debounce
        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },

        // Calculate accuracy
        calcAccuracy(correct, total) {
            if (total === 0) return 0;
            return Math.round((correct / total) * 100);
        },

        // Get badge class for difficulty
        getDifficultyBadge(difficulty) {
            const badges = {
                easy: 'badge-easy',
                medium: 'badge-medium',
                hard: 'badge-hard'
            };
            return badges[difficulty] || 'badge-info';
        },

        // Get urgency label
        getUrgencyLabel(urgency) {
            const labels = {
                none: { text: 'Geen urgentie', class: 'text-muted' },
                low: { text: 'Laag', class: 'text-success' },
                medium: { text: 'Medium', class: 'text-warning' },
                high: { text: 'Hoog', class: 'text-danger' },
                critical: { text: 'KRITIEK', class: 'text-danger' }
            };
            return labels[urgency] || labels.none;
        },

        // Get category icon
        getCategoryIcon(category) {
            const cat = ECGDatabase.categories[category];
            return cat ? cat.icon : '📋';
        },

        // Animate element
        animateElement(element, animation) {
            element.style.animation = 'none';
            element.offsetHeight; // Trigger reflow
            element.style.animation = animation;
        },

        // Play sound (placeholder - would need audio files)
        playSound(type) {
            if (!AppState.settings.soundEnabled) return;
            // Sound implementation would go here
        },

        // Format date
        formatDate(date) {
            return new Date(date).toLocaleDateString('nl-NL', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        // XP calculation
        calculateXP(correct, difficulty, timeBonus = 0) {
            const baseXP = { easy: 10, medium: 20, hard: 35 };
            let xp = baseXP[difficulty] || 15;
            if (correct) {
                xp += timeBonus;
            } else {
                xp = Math.floor(xp * 0.25); // Kleine XP voor poging
            }
            return xp;
        },

        // Level calculation
        calculateLevel(xp) {
            // XP needed: Level 1 = 0, Level 2 = 100, Level 3 = 250, etc.
            const xpNeeded = (level) => (level - 1) * 100 + (level - 1) * 25 * (level - 1);
            let level = 1;
            while (xpNeeded(level + 1) <= xp) level++;
            return {
                level,
                currentXP: xp - xpNeeded(level),
                nextLevelXP: xpNeeded(level + 1) - xpNeeded(level)
            };
        }
    };

    // ==================== NAVIGATION ====================
    const Navigation = {
        sections: {
            dashboard: { title: '📊 Dashboard', icon: '🏠' },
            monitor: { title: '📺 Monitor Simulator', icon: '📺' },
            learningPath: { title: '🧭 Leerpad', icon: '🧭' },
            library: { title: '📚 ECG Bibliotheek', icon: '📚' },
            systematic: { title: '📋 Systematische Analyse', icon: '📋' },
            quiz: { title: '🎯 Quiz Modus', icon: '🎯' },
            cases: { title: '🏥 Klinische Cases', icon: '🏥' },
            acls: { title: '🚨 ACLS Algoritmes', icon: '🚨' },
            drugs: { title: '💊 Medicatie & ECG', icon: '💊' },
            criteria: { title: '📏 Criteria & Waarden', icon: '📏' }
        },

        init() {
            // Setup nav item clicks
            Utils.$$('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    if (section) this.navigateTo(section);
                });
            });

            // Load initial section
            this.navigateTo('dashboard');
        },

        navigateTo(sectionId) {
            if (!this.sections[sectionId]) {
                console.warn(`Section ${sectionId} not found`);
                return;
            }

            // Update state
            AppState.currentSection = sectionId;

            // Update nav items
            Utils.$$('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.section === sectionId);
            });

            // Update title
            Utils.$('#pageTitle').textContent = this.sections[sectionId].title;

            // Render section content
            this.renderSection(sectionId);
        },

        renderSection(sectionId) {
            const content = Utils.$('#contentArea');
            const section = this.sections[sectionId];
            if (section && typeof section.render === 'function') {
                section.render(content);
                return;
            }
            
            switch(sectionId) {
                case 'dashboard':
                    Sections.renderDashboard(content);
                    break;
                case 'monitor':
                    Sections.renderMonitor(content);
                    break;
                case 'learningPath':
                    Sections.renderLearningPath(content);
                    break;
                case 'library':
                    Sections.renderLibrary(content);
                    break;
                case 'systematic':
                    Sections.renderSystematic(content);
                    break;
                case 'quiz':
                    Sections.renderQuiz(content);
                    break;
                case 'cases':
                    Sections.renderCases(content);
                    break;
                case 'acls':
                    Sections.renderACLS(content);
                    break;
                case 'drugs':
                    Sections.renderDrugs(content);
                    break;
                case 'criteria':
                    Sections.renderCriteria(content);
                    break;
                default:
                    content.innerHTML = '<p>Sectie wordt geladen...</p>';
            }
        }
    };

    // ==================== DEEL 3 GAAT HIER VERDER ====================

    // ==================== ECG WAVEFORM RENDERER ====================
    const ECGRenderer = {
        // Canvas settings
        settings: {
            backgroundColor: '#000000',
            gridColor: '#1a3d1a',
            gridColorMinor: '#0d1f0d',
            waveColor: '#22c55e',
            speed: 25, // mm/s
            amplitude: 10, // mm/mV
            pixelsPerMM: 4
        },

        // Active canvases
        activeCanvases: new Map(),

        // Initialize canvas
        initCanvas(canvasId, options = {}) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;

            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            // Set actual size
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            const config = {
                canvas,
                ctx,
                width: rect.width,
                height: rect.height,
                x: 0,
                rhythm: options.rhythm || 'sinus_normal',
                heartRate: options.heartRate || 72,
                speed: options.speed || this.settings.speed,
                amplitude: options.amplitude || 1,
                isRunning: false,
                animationId: null,
                lastTime: 0,
                buffer: [],
                ...options
            };

            this.activeCanvases.set(canvasId, config);
            return config;
        },

        // Draw ECG grid
        drawGrid(ctx, width, height) {
            const ppm = this.settings.pixelsPerMM;
            
            // Clear
            ctx.fillStyle = this.settings.backgroundColor;
            ctx.fillRect(0, 0, width, height);

            // Minor grid (1mm)
            ctx.strokeStyle = this.settings.gridColorMinor;
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            for (let x = 0; x < width; x += ppm) {
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
            }
            for (let y = 0; y < height; y += ppm) {
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
            }
            ctx.stroke();

            // Major grid (5mm)
            ctx.strokeStyle = this.settings.gridColor;
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let x = 0; x < width; x += ppm * 5) {
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
            }
            for (let y = 0; y < height; y += ppm * 5) {
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
            }
            ctx.stroke();
        },

        // Generate waveform point for a specific rhythm
        generateWaveformPoint(rhythm, phase, params = {}) {
            const rhythmData = ECGDatabase.getRhythmById(rhythm);
            if (!rhythmData) return 0;

            const wp = rhythmData.waveformParams || {};
            const amplitude = params.amplitude || 1;
            
            // Normalize phase to 0-1
            phase = phase % 1;
            if (phase < 0) phase += 1;

            let value = 0;

            // Different waveform generation based on rhythm type
            switch(rhythm) {
                case 'vfib':
                    // Chaotic VF pattern
                    value = (Math.random() - 0.5) * 0.8 * amplitude;
                    value += Math.sin(phase * Math.PI * 20) * 0.2;
                    value += Math.sin(phase * Math.PI * 7.3) * 0.15;
                    break;

                case 'asystole':
                    // Flat line with minimal noise
                    value = (Math.random() - 0.5) * 0.02;
                    break;

                case 'atrial_fibrillation':
                    // AF - irregular with fibrillation baseline
                    value = this.generateNormalQRS(phase, wp, amplitude);
                    // Add fibrillation waves
                    value += Math.sin(phase * Math.PI * 15) * 0.03;
                    value += Math.sin(phase * Math.PI * 23) * 0.02;
                    break;

                case 'atrial_flutter':
                    // Flutter waves (sawtooth)
                    value = this.generateFlutterWaveform(phase, wp, amplitude);
                    break;

                case 'vtach_monomorphic':
                    // Wide complex VT
                    value = this.generateVTWaveform(phase, wp, amplitude);
                    break;

                case 'vtach_polymorphic':
                    // Torsades - twisting pattern
                    value = this.generateTorsadesWaveform(phase, wp, amplitude, params.time || 0);
                    break;

                case 'avblock_3rd':
                    // Complete heart block - dissociated P and QRS
                    value = this.generateCHBWaveform(phase, wp, amplitude, params);
                    break;

                case 'paced_ventricular':
                case 'paced_dual':
                    // Paced rhythm with spike
                    value = this.generatePacedWaveform(phase, wp, amplitude, rhythm);
                    break;

                default:
                    // Standard waveform (sinus-like)
                    value = this.generateNormalQRS(phase, wp, amplitude);
            }

            return value;
        },

        // Generate normal sinus-like QRS
        generateNormalQRS(phase, wp, amplitude) {
            const pHeight = (wp.pHeight || 0.15) * amplitude;
            const pWidth = wp.pWidth || 0.08;
            const qDepth = (wp.qDepth || 0.05) * amplitude;
            const rHeight = (wp.rHeight || 1.0) * amplitude;
            const sDepth = (wp.sDepth || 0.15) * amplitude;
            const tHeight = (wp.tHeight || 0.25) * amplitude;
            const tWidth = wp.tWidth || 0.16;
            const prInterval = wp.prInterval || 0.16;
            const qrsWidth = wp.qrsWidth || 0.08;

            let value = 0;

            // P wave (0.0 - 0.12)
            if (phase < 0.12) {
                const pPhase = phase / 0.12;
                value = pHeight * Math.sin(pPhase * Math.PI);
            }
            // PR segment (0.12 - 0.20)
            else if (phase < 0.20) {
                value = 0;
            }
            // Q wave (0.20 - 0.22)
            else if (phase < 0.22) {
                const qPhase = (phase - 0.20) / 0.02;
                value = -qDepth * Math.sin(qPhase * Math.PI);
            }
            // R wave (0.22 - 0.26)
            else if (phase < 0.26) {
                const rPhase = (phase - 0.22) / 0.04;
                value = rHeight * Math.sin(rPhase * Math.PI);
            }
            // S wave (0.26 - 0.30)
            else if (phase < 0.30) {
                const sPhase = (phase - 0.26) / 0.04;
                value = -sDepth * Math.sin(sPhase * Math.PI);
            }
            // ST segment (0.30 - 0.45)
            else if (phase < 0.45) {
                value = 0;
            }
            // T wave (0.45 - 0.65)
            else if (phase < 0.65) {
                const tPhase = (phase - 0.45) / 0.20;
                value = tHeight * Math.sin(tPhase * Math.PI);
            }
            // Baseline (0.65 - 1.0)
            else {
                value = 0;
            }

            return value;
        },

        // Generate VT waveform
        generateVTWaveform(phase, wp, amplitude) {
            const qrsWidth = wp.qrsWidth || 0.16;
            const rHeight = (wp.qrsHeight || 1.4) * amplitude;

            let value = 0;

            // Wide QRS complex takes most of the cycle
            if (phase < 0.45) {
                // Broad R wave
                const rPhase = phase / 0.45;
                value = rHeight * Math.sin(rPhase * Math.PI);
                // Add some notching
                value += Math.sin(rPhase * Math.PI * 3) * 0.1 * amplitude;
            }
            else if (phase < 0.55) {
                // Deep S
                const sPhase = (phase - 0.45) / 0.10;
                value = -0.3 * amplitude * Math.sin(sPhase * Math.PI);
            }
            else if (phase < 0.85) {
                // Inverted T
                const tPhase = (phase - 0.55) / 0.30;
                value = -0.25 * amplitude * Math.sin(tPhase * Math.PI);
            }

            return value;
        },

        // Generate flutter waveform
        generateFlutterWaveform(phase, wp, amplitude) {
            let value = 0;
            const avConduction = wp.avConduction || 2;

            // Flutter waves (sawtooth pattern)
            const flutterPhase = (phase * avConduction) % 1;
            const flutterWave = (1 - flutterPhase * 2);
            value = flutterWave * 0.15 * amplitude;

            // QRS complex (every avConduction flutter waves)
            const qrsPhase = phase;
            if (qrsPhase > 0.15 && qrsPhase < 0.35) {
                const localPhase = (qrsPhase - 0.15) / 0.20;
                if (localPhase < 0.3) {
                    value += amplitude * Math.sin(localPhase / 0.3 * Math.PI);
                } else if (localPhase < 0.5) {
                    value -= 0.2 * amplitude * Math.sin((localPhase - 0.3) / 0.2 * Math.PI);
                }
            }

            return value;
        },

        // Generate Torsades waveform
        generateTorsadesWaveform(phase, wp, amplitude, time) {
            // Twisting amplitude modulation
            const twistFreq = 0.5; // Hz
            const twistAmp = Math.sin(time * twistFreq * Math.PI * 2);
            
            let value = 0;
            const baseAmp = amplitude * (0.5 + 0.5 * Math.abs(twistAmp));
            
            // Wide complex
            if (phase < 0.5) {
                const rPhase = phase / 0.5;
                value = baseAmp * Math.sin(rPhase * Math.PI) * (twistAmp > 0 ? 1 : -1);
            } else {
                const tPhase = (phase - 0.5) / 0.5;
                value = -baseAmp * 0.3 * Math.sin(tPhase * Math.PI) * (twistAmp > 0 ? 1 : -1);
            }

            return value;
        },

        // Generate complete heart block waveform
        generateCHBWaveform(phase, wp, amplitude, params) {
            let value = 0;
            
            // P waves at atrial rate
            const pRate = wp.pRate || 80;
            const escapeRate = wp.escapeRate || 35;
            const ratio = pRate / escapeRate;

            // P wave
            const pPhase = (phase * ratio) % 1;
            if (pPhase < 0.15) {
                value += 0.15 * amplitude * Math.sin(pPhase / 0.15 * Math.PI);
            }

            // Escape QRS (wide)
            if (phase > 0.20 && phase < 0.50) {
                const qrsPhase = (phase - 0.20) / 0.30;
                if (qrsPhase < 0.4) {
                    value += amplitude * Math.sin(qrsPhase / 0.4 * Math.PI);
                } else if (qrsPhase < 0.6) {
                    value -= 0.3 * amplitude * Math.sin((qrsPhase - 0.4) / 0.2 * Math.PI);
                }
            }

            // T wave
            if (phase > 0.55 && phase < 0.80) {
                const tPhase = (phase - 0.55) / 0.25;
                value -= 0.2 * amplitude * Math.sin(tPhase * Math.PI);
            }

            return value;
        },

        // Generate paced waveform
        generatePacedWaveform(phase, wp, amplitude, rhythm) {
            let value = 0;

            // Atrial spike (for DDD)
            if (rhythm === 'paced_dual' && phase < 0.02) {
                value = 0.4 * amplitude;
            }
            // Atrial contraction
            else if (rhythm === 'paced_dual' && phase >= 0.02 && phase < 0.12) {
                const pPhase = (phase - 0.02) / 0.10;
                value = 0.12 * amplitude * Math.sin(pPhase * Math.PI);
            }
            // Ventricular spike
            else if (phase >= 0.18 && phase < 0.20) {
                value = 0.5 * amplitude;
            }
            // Wide paced QRS (LBBB morphology)
            else if (phase >= 0.20 && phase < 0.42) {
                const qrsPhase = (phase - 0.20) / 0.22;
                if (qrsPhase < 0.5) {
                    value = amplitude * Math.sin(qrsPhase / 0.5 * Math.PI);
                } else {
                    value = -0.15 * amplitude * Math.sin((qrsPhase - 0.5) / 0.5 * Math.PI);
                }
            }
            // T wave (discordant)
            else if (phase >= 0.50 && phase < 0.75) {
                const tPhase = (phase - 0.50) / 0.25;
                value = -0.25 * amplitude * Math.sin(tPhase * Math.PI);
            }

            return value;
        },

        // Start animation
        start(canvasId) {
            const config = this.activeCanvases.get(canvasId);
            if (!config || config.isRunning) return;

            config.isRunning = true;
            config.lastTime = performance.now();
            config.x = 0;
            config.buffer = [];

            // Pre-fill buffer
            this.drawGrid(config.ctx, config.width, config.height);

            const animate = (currentTime) => {
                if (!config.isRunning) return;

                const deltaTime = (currentTime - config.lastTime) / 1000;
                config.lastTime = currentTime;

                this.updateWaveform(config, deltaTime);
                config.animationId = requestAnimationFrame(animate);
            };

            config.animationId = requestAnimationFrame(animate);
        },

        // Stop animation
        stop(canvasId) {
            const config = this.activeCanvases.get(canvasId);
            if (!config) return;

            config.isRunning = false;
            if (config.animationId) {
                cancelAnimationFrame(config.animationId);
                config.animationId = null;
            }
        },

        // Update waveform
        updateWaveform(config, deltaTime) {
            const { ctx, width, height, speed, amplitude, heartRate, rhythm } = config;
            const ppm = this.settings.pixelsPerMM;
            
            // Calculate pixels to draw
            const pixelsPerSecond = speed * ppm;
            const pixelsToDraw = pixelsPerSecond * deltaTime;

            // Calculate phase increment per pixel
            const beatsPerSecond = heartRate / 60;
            const pixelsPerBeat = pixelsPerSecond / beatsPerSecond;
            const phasePerPixel = 1 / pixelsPerBeat;

            // Generate new points
            const baseline = height / 2;
            const scale = height * 0.35;

            for (let i = 0; i < pixelsToDraw; i++) {
                const x = config.x;
                const phase = (x * phasePerPixel) % 1;
                
                // Add R-R variability for certain rhythms
                let adjustedPhase = phase;
                if (rhythm === 'atrial_fibrillation' || rhythm === 'sinus_arrhythmia') {
                    adjustedPhase += Math.sin(x * 0.01) * 0.1;
                }

                const value = this.generateWaveformPoint(rhythm, adjustedPhase, {
                    amplitude,
                    time: x / pixelsPerSecond
                });

                config.buffer.push({
                    x: x % width,
                    y: baseline - value * scale
                });

                config.x++;
            }

            // Redraw
            this.drawGrid(ctx, width, height);

            // Draw waveform
            ctx.strokeStyle = this.settings.waveColor;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowColor = this.settings.waveColor;
            ctx.shadowBlur = 4;

            // Only keep recent points
            const maxPoints = width * 2;
            if (config.buffer.length > maxPoints) {
                config.buffer = config.buffer.slice(-maxPoints);
            }

            // Draw with wrap-around handling
            ctx.beginPath();
            let drawing = false;
            let lastX = -1;

            for (const point of config.buffer) {
                const drawX = point.x;
                
                // Detect wrap-around
                if (lastX > drawX + 10) {
                    ctx.stroke();
                    ctx.beginPath();
                    drawing = false;
                }

                if (!drawing) {
                    ctx.moveTo(drawX, point.y);
                    drawing = true;
                } else {
                    ctx.lineTo(drawX, point.y);
                }
                
                lastX = drawX;
            }
            ctx.stroke();
            ctx.shadowBlur = 0;

            // Draw sweep line
            const sweepX = config.x % width;
            ctx.strokeStyle = 'rgba(34, 197, 94, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(sweepX, 0);
            ctx.lineTo(sweepX, height);
            ctx.stroke();

            // Clear ahead of sweep
            ctx.fillStyle = this.settings.backgroundColor;
            ctx.fillRect(sweepX + 2, 0, 50, height);
        },

        // Draw static ECG strip
        drawStaticStrip(canvasId, rhythm, options = {}) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            const width = rect.width;
            const height = rect.height;
            const heartRate = options.heartRate || 72;
            const amplitude = options.amplitude || 1;

            // Draw grid
            this.drawGrid(ctx, width, height);

            // Calculate parameters
            const ppm = this.settings.pixelsPerMM;
            const speed = options.speed || 25;
            const pixelsPerSecond = speed * ppm;
            const beatsPerSecond = heartRate / 60;
            const pixelsPerBeat = pixelsPerSecond / beatsPerSecond;
            const phasePerPixel = 1 / pixelsPerBeat;

            const baseline = height / 2;
            const scale = height * 0.35;

            // Draw waveform
            ctx.strokeStyle = this.settings.waveColor;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowColor = this.settings.waveColor;
            ctx.shadowBlur = 3;

            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                let phase = (x * phasePerPixel) % 1;
                
                // Add variability for AF
                if (rhythm === 'atrial_fibrillation') {
                    phase += Math.sin(x * 0.02 + Math.random() * 0.5) * 0.15;
                }

                const value = this.generateWaveformPoint(rhythm, phase, {
                    amplitude,
                    time: x / pixelsPerSecond
                });
                const y = baseline - value * scale;

                if (x === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
        },

        // Change rhythm on running canvas
        setRhythm(canvasId, rhythm, heartRate) {
            const config = this.activeCanvases.get(canvasId);
            if (!config) return;

            config.rhythm = rhythm;
            if (heartRate) config.heartRate = heartRate;
            config.buffer = []; // Clear buffer for clean transition
        },

        // Cleanup
        destroy(canvasId) {
            this.stop(canvasId);
            this.activeCanvases.delete(canvasId);
        },

        // Destroy all
        destroyAll() {
            for (const [id] of this.activeCanvases) {
                this.destroy(id);
            }
        }
    };

    // ==================== SECTION RENDERERS ====================
    const Sections = {
        
        // ========== DASHBOARD ==========
        renderDashboard(container) {
            const user = AppState.user;
            const levelInfo = Utils.calculateLevel(user.xp);
            const accuracy = Utils.calcAccuracy(user.totalCorrect, user.totalAnswered);
            const weeklyFocus = LearningPathEngine.getWeeklyFocus();
            const dailyRound = LearningPathEngine.getDailyRound();
            const dailyDone = dailyRound.completedCaseIds.length;

            container.innerHTML = `
                <div class="grid-2">
                    <!-- Welcome Card -->
                    <div class="card">
                        <div class="card-body">
                            <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">
                                👋 Welkom bij ECG Trainer Pro
                            </h2>
                            <p class="text-muted" style="margin-bottom: 1.5rem;">
                                Master ECG interpretatie met interactieve oefeningen
                            </p>
                            
                            <div class="vitals-grid" style="margin-bottom: 1.5rem;">
                                <div class="vital-card">
                                    <div class="vital-card-label">Niveau</div>
                                    <div class="vital-card-value text-primary">${levelInfo.level}</div>
                                </div>
                                <div class="vital-card">
                                    <div class="vital-card-label">XP</div>
                                    <div class="vital-card-value text-success">${user.xp}</div>
                                </div>
                                <div class="vital-card">
                                    <div class="vital-card-label">Reeks</div>
                                    <div class="vital-card-value text-warning">${user.streak}🔥</div>
                                </div>
                                <div class="vital-card">
                                    <div class="vital-card-label">Nauwkeurig</div>
                                    <div class="vital-card-value text-info">${accuracy}%</div>
                                </div>
                            </div>

                            <div class="progress-bar" style="margin-bottom: 0.5rem;">
                                <div class="progress-fill" style="width: ${(levelInfo.currentXP / levelInfo.nextLevelXP) * 100}%"></div>
                            </div>
                            <p class="text-muted" style="font-size: 0.8rem;">
                                ${levelInfo.currentXP} / ${levelInfo.nextLevelXP} XP naar niveau ${levelInfo.level + 1}
                            </p>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📊 Statistieken</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; gap: 1rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px;">
                                    <span>Vragen beantwoord</span>
                                    <strong>${user.totalAnswered}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px;">
                                    <span>Correct</span>
                                    <strong class="text-success">${user.totalCorrect}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px;">
                                    <span>Ritmes beheerst</span>
                                    <strong class="text-primary">${user.masteredRhythms.length}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-elevated); border-radius: 8px;">
                                    <span>Topics voltooid</span>
                                    <strong class="text-info">${user.completedTopics.length}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">⚡ Snel Starten</h3>
                    </div>
                    <div class="card-body">
                        <div class="quick-actions">
                            <div class="quick-action" onclick="ECGApp.startQuickQuiz()">
                                <div class="quick-action-icon">🎯</div>
                                <div class="quick-action-title">Snelle Quiz</div>
                                <div class="quick-action-desc">10 willekeurige vragen</div>
                            </div>
                            <div class="quick-action" onclick="Navigation.navigateTo('monitor')">
                                <div class="quick-action-icon">📺</div>
                                <div class="quick-action-title">Monitor Simulator</div>
                                <div class="quick-action-desc">Live ECG ritmes bekijken</div>
                            </div>
                            <div class="quick-action" onclick="Navigation.navigateTo('library')">
                                <div class="quick-action-icon">📚</div>
                                <div class="quick-action-title">ECG Bibliotheek</div>
                                <div class="quick-action-desc">45+ ritmes bestuderen</div>
                            </div>
                            <div class="quick-action" onclick="Navigation.navigateTo('acls')">
                                <div class="quick-action-icon">🚨</div>
                                <div class="quick-action-title">ACLS Protocollen</div>
                                <div class="quick-action-desc">Spoed algoritmes</div>
                            </div>
                            <div class="quick-action" onclick="ECGApp.startCriticalQuiz()">
                                <div class="quick-action-icon">💔</div>
                                <div class="quick-action-title">Kritieke Ritmes</div>
                                <div class="quick-action-desc">Focus op levensbedreigende aritmieën</div>
                            </div>
                            <div class="quick-action" onclick="Navigation.navigateTo('cases')">
                                <div class="quick-action-icon">🏥</div>
                                <div class="quick-action-title">Klinische Cases</div>
                                <div class="quick-action-desc">Praktijkscenario's</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🧭 Leerpad Focus</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-2">Aanbevolen volgende stap: <strong>${LearningPathEngine.getCurrentModule()?.title || 'Module 1'}</strong></p>
                            <ul class="styled-list">
                                ${weeklyFocus.map(item => `<li>${item.name} (${item.accuracy}%)</li>`).join('')}
                            </ul>
                            <button class="btn btn-primary btn-sm mt-2" onclick="Navigation.navigateTo('learningPath')">Naar Leerpad</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🏥 Dagelijkse Klinische Ronde</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-2">Voortgang vandaag: <strong>${dailyDone}/${dailyRound.caseIds.length}</strong></p>
                            <div class="btn-group">
                                ${dailyRound.caseIds.map(caseId => {
                                    const caseData = ClinicalCases.getCaseById(caseId);
                                    if (!caseData) return '';
                                    const done = dailyRound.completedCaseIds.includes(caseId);
                                    return `<button class="btn btn-sm ${done ? 'btn-success' : 'btn-outline'}" onclick="ECGApp.startDailyCase('${caseId}')">${done ? '✓' : '•'} ${caseData.title}</button>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category Overview -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📂 Categorieën</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-4">
                            ${Object.entries(ECGDatabase.categories).map(([id, cat]) => {
                                const count = ECGDatabase.getRhythmsByCategory(id).length;
                                return `
                                    <div class="topic-card" onclick="ECGApp.openCategoryQuiz('${id}')">
                                        <div class="topic-card-icon">${cat.icon}</div>
                                        <div class="topic-card-title">${cat.name}</div>
                                        <div class="topic-card-desc">${cat.description}</div>
                                        <div class="topic-card-meta">
                                            <span>${count} ritmes</span>
                                            <span class="badge badge-info">Oefen →</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <!-- Recent Critical Rhythms -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🚨 Kritieke Ritmes - Ken Deze!</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-box danger">
                            <div class="info-box-icon">⚠️</div>
                            <div class="info-box-content">
                                <h4>Levensbedreigende Aritmieën</h4>
                                <p>Deze ritmes vereisen onmiddellijke actie. Zorg dat je ze direct herkent!</p>
                            </div>
                        </div>
                        <div class="rhythm-grid" style="margin-top: 1rem;">
                            ${ECGDatabase.getCriticalRhythms().slice(0, 6).map(rhythm => `
                                <button class="rhythm-btn" onclick="ECGApp.showRhythmDetail('${rhythm.id}')">
                                    <span class="rhythm-indicator red"></span>
                                    <span>${rhythm.name}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        },

        // ========== MONITOR SIMULATOR ==========
        renderMonitor(container) {
            const rhythms = ECGDatabase.getAllRhythms();
            const currentRhythm = ECGDatabase.getRhythmById(AppState.monitor.currentRhythm);

            container.innerHTML = `
                <div class="split-view">
                    <!-- Main Monitor -->
                    <div>
                        <div class="ecg-monitor">
                            <div class="ecg-monitor-header">
                                <div class="ecg-monitor-title">
                                    <span class="pulse">●</span>
                                    IC Monitor - Afleiding II
                                </div>
                                <div class="ecg-monitor-vitals">
                                    <div class="vital-display">
                                        <div class="vital-label">HR</div>
                                        <div class="vital-value green" id="monitorHR">${AppState.monitor.heartRate}</div>
                                    </div>
                                    <div class="vital-display">
                                        <div class="vital-label">SpO2</div>
                                        <div class="vital-value blue">98</div>
                                    </div>
                                    <div class="vital-display">
                                        <div class="vital-label">RR</div>
                                        <div class="vital-value yellow">16</div>
                                    </div>
                                </div>
                            </div>
                            <div class="ecg-canvas-wrapper">
                                <canvas id="monitorCanvas" class="ecg-canvas large"></canvas>
                                <div class="ecg-lead-label">II</div>
                            </div>
                            <div class="ecg-controls">
                                <div class="ecg-setting">Snelheid: <span>${AppState.monitor.speed} mm/s</span></div>
                                <div class="ecg-setting">Amplitude: <span>${AppState.monitor.amplitude}x</span></div>
                                <div class="btn-group">
                                    <button class="btn btn-sm ${AppState.monitor.isRunning ? 'btn-danger' : 'btn-success'}" 
                                            id="monitorToggle" onclick="ECGApp.toggleMonitor()">
                                        ${AppState.monitor.isRunning ? '⏸ Pauze' : '▶ Start'}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Current Rhythm Info -->
                        <div class="card mt-2">
                            <div class="card-header">
                                <h3 class="card-title">
                                    ${Utils.getCategoryIcon(currentRhythm?.category)} 
                                    ${currentRhythm?.name || 'Selecteer een ritme'}
                                </h3>
                                <span class="badge ${Utils.getDifficultyBadge(currentRhythm?.difficulty)}">
                                    ${currentRhythm?.difficulty || ''}
                                </span>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-2">${currentRhythm?.description || ''}</p>
                                
                                ${currentRhythm ? `
                                    <div class="info-box info">
                                        <div class="info-box-icon">💡</div>
                                        <div class="info-box-content">
                                            <h4>ECG Kenmerken</h4>
                                            <ul class="styled-list">
                                                ${currentRhythm.ecgFeatures.slice(0, 4).map(f => `<li>${f}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Rhythm Selector -->
                    <div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">🎛️ Ritme Selectie</h3>
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                <!-- Heart Rate Control -->
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">
                                        Hartfrequentie: <span id="hrValue">${AppState.monitor.heartRate}</span> bpm
                                    </label>
                                    <input type="range" min="30" max="200" value="${AppState.monitor.heartRate}" 
                                           style="width: 100%;" 
                                           oninput="ECGApp.setMonitorHR(this.value)">
                                </div>

                                <!-- Rhythm Categories -->
                                ${Object.entries(ECGDatabase.categories).map(([catId, cat]) => {
                                    const catRhythms = ECGDatabase.getRhythmsByCategory(catId);
                                    return `
                                        <div class="accordion-item open" style="margin-bottom: 0.5rem; border: 1px solid var(--border); border-radius: 8px;">
                                            <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
                                                <h4>${cat.icon} ${cat.name} (${catRhythms.length})</h4>
                                                <span class="accordion-icon">▼</span>
                                            </div>
                                            <div class="accordion-body">
                                                <div style="padding: 0.5rem;">
                                                    ${catRhythms.map(r => `
                                                        <button class="rhythm-btn ${AppState.monitor.currentRhythm === r.id ? 'active' : ''}" 
                                                                onclick="ECGApp.setMonitorRhythm('${r.id}')"
                                                                style="width: 100%; margin-bottom: 0.25rem;">
                                                            <span class="rhythm-indicator ${r.urgency === 'critical' ? 'red' : r.urgency === 'high' ? 'yellow' : 'green'}"></span>
                                                            <span style="flex: 1; text-align: left;">${r.name}</span>
                                                            <span class="badge ${Utils.getDifficultyBadge(r.difficulty)}" style="font-size: 0.6rem;">${r.difficulty}</span>
                                                        </button>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initialize monitor
            setTimeout(() => {
                ECGRenderer.initCanvas('monitorCanvas', {
                    rhythm: AppState.monitor.currentRhythm,
                    heartRate: AppState.monitor.heartRate
                });
                if (AppState.monitor.isRunning) {
                    ECGRenderer.start('monitorCanvas');
                }
            }, 100);
        },

        // ========== ECG LIBRARY ==========
        renderLibrary(container) {
            const categories = ECGDatabase.categories;
            const selectedCat = AppState.library.selectedCategory;
            const searchQuery = AppState.library.searchQuery;

            let rhythms = selectedCat === 'all' 
                ? ECGDatabase.getAllRhythms() 
                : ECGDatabase.getRhythmsByCategory(selectedCat);

            if (searchQuery) {
                rhythms = ECGDatabase.searchRhythms(searchQuery);
            }

            container.innerHTML = `
                <div class="card mb-2">
                    <div class="card-body">
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <!-- Search -->
                            <div style="flex: 1; min-width: 200px;">
                                <input type="text" 
                                       placeholder="🔍 Zoek ritme..." 
                                       value="${searchQuery}"
                                       oninput="ECGApp.searchLibrary(this.value)"
                                       style="width: 100%; padding: 0.75rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem;">
                            </div>
                            
                            <!-- Category Filter -->
                            <select onchange="ECGApp.filterLibrary(this.value)"
                                    style="padding: 0.75rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem; min-width: 180px;">
                                <option value="all" ${selectedCat === 'all' ? 'selected' : ''}>Alle categorieën</option>
                                ${Object.entries(categories).map(([id, cat]) => `
                                    <option value="${id}" ${selectedCat === id ? 'selected' : ''}>
                                        ${cat.icon} ${cat.name}
                                    </option>
                                `).join('')}
                            </select>

                            <!-- Count -->
                            <span class="text-muted">${rhythms.length} ritmes</span>
                        </div>
                    </div>
                </div>

                <!-- Rhythm Grid -->
                <div class="grid-3">
                    ${rhythms.map(rhythm => `
                        <div class="card" style="cursor: pointer;" onclick="ECGApp.showRhythmDetail('${rhythm.id}')">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                    <div>
                                        <h3 style="font-size: 1rem; margin-bottom: 0.25rem;">${rhythm.name}</h3>
                                        <span class="text-muted" style="font-size: 0.8rem;">${rhythm.shortName}</span>
                                    </div>
                                    <span class="badge ${Utils.getDifficultyBadge(rhythm.difficulty)}">${rhythm.difficulty}</span>
                                </div>

                                <!-- Mini ECG Preview -->
                                <div class="ecg-monitor" style="margin-bottom: 0.75rem;">
                                    <canvas id="preview_${rhythm.id}" class="ecg-canvas" style="height: 80px;"></canvas>
                                </div>

                                <p class="text-muted" style="font-size: 0.8rem; margin-bottom: 0.75rem; line-height: 1.5;">
                                    ${rhythm.description}
                                </p>

                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.75rem;">
                                        ${Utils.getCategoryIcon(rhythm.category)} ${categories[rhythm.category]?.name || ''}
                                    </span>
                                    ${rhythm.urgency === 'critical' ? '<span class="badge badge-critical">KRITIEK</span>' : ''}
                                    ${rhythm.urgency === 'high' ? '<span class="badge badge-hard">URGENT</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Draw preview strips
            setTimeout(() => {
                rhythms.forEach(rhythm => {
                    const rate = rhythm.characteristics?.rate?.typical || 72;
                    ECGRenderer.drawStaticStrip(`preview_${rhythm.id}`, rhythm.id, { heartRate: rate });
                });
            }, 100);
        },

        // ========== SYSTEMATIC ANALYSIS ==========
        renderSystematic(container) {
            const checklist = AppState.learningPath?.checklistTraining || { sessions: 0, activeSince: null, lastCompleted: null };
            const elapsed = LearningPathEngine.getChecklistElapsedMinutes();

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📋 Systematische ECG Analyse</h3>
                    </div>
                    <div class="card-body">
                        <div class="info-box info mb-3">
                            <div class="info-box-icon">💡</div>
                            <div class="info-box-content">
                                <h4>Gebruik altijd een systematische aanpak!</h4>
                                <p>Een gestructureerde benadering voorkomt dat je belangrijke bevindingen mist.</p>
                            </div>
                        </div>

                        <div class="algorithm-box warning mb-3">
                            <div class="algorithm-title">🧠 Mentale Checklist Training</div>
                            <p class="text-muted" style="margin-top: 0.5rem;">
                                Sessies voltooid: <strong>${checklist.sessions || 0}</strong>
                                ${checklist.activeSince ? `• Timer actief: <strong>${elapsed} min</strong>` : ''}
                            </p>
                            <div class="grid-2" style="margin-top: 0.75rem;">
                                <label><input type="checkbox" class="sys-checklist-step"> Frequentie bepaald</label>
                                <label><input type="checkbox" class="sys-checklist-step"> Ritme geclassificeerd</label>
                                <label><input type="checkbox" class="sys-checklist-step"> Geleiding (PR/QRS) beoordeeld</label>
                                <label><input type="checkbox" class="sys-checklist-step"> ST-T/QTc beoordeeld</label>
                            </div>
                            <div class="btn-group mt-2">
                                <button class="btn btn-outline btn-sm" onclick="ECGApp.startChecklistTraining()">⏱️ Start Timer</button>
                                <button class="btn btn-primary btn-sm" onclick="ECGApp.completeChecklistTraining()">✅ Sessie afronden</button>
                            </div>
                        </div>

                        <div class="algorithm-box info">
                            <div class="algorithm-title">📝 10-Stappen ECG Analyse</div>
                            <div class="algorithm-steps">
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">1</span>
                                    <div>
                                        <strong>Kalibratie & Kwaliteit</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">10mm/mV, 25mm/s, basislijn stabiel, artefacten?</p>
                                    </div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">2</span>
                                    <div>
                                        <strong>Hartfrequentie</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">300/grote hokjes of 6-sec methode. Normaal: 60-100 bpm</p>
                                    </div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">3</span>
                                    <div>
                                        <strong>Ritme</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">Regelmatig? Sinusritme? P-golf voor elk QRS?</p>
                                    </div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">4</span>
                                    <div>
                                        <strong>Hartas</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">Normaal -30° tot +90°. Check I en aVF</p>
                                    </div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">5</span>
                                    <div>
                                        <strong>P-golf</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">Aanwezig? Morfologie? Duur < 120ms, hoogte < 2.5mm</p>
                                    </div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">6</span>
                                    <div>
                                        <strong>PR-interval</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">120-200ms (3-5 kleine hokjes). Constant?</p>
                                    </div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">7</span>
                                    <div>
                                        <strong>QRS-complex</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">Duur < 120ms. Morfologie? Q-golven? R-progressie?</p>
                                    </div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">8</span>
                                    <div>
                                        <strong>ST-segment</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">Iso-elektrisch? Elevatie/depressie? > 1mm significant</p>
                                    </div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">9</span>
                                    <div>
                                        <strong>T-golf</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">Concordant met QRS? Inversie? Hyperacuut?</p>
                                    </div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">10</span>
                                    <div>
                                        <strong>QT-interval</strong>
                                        <p class="text-muted" style="font-size: 0.85rem;">QTc < 450ms (♂) / < 460ms (♀). Bazett: QTc = QT/√RR</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reference Values -->
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📏 Normale Waarden</h3>
                        </div>
                        <div class="card-body">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Parameter</th>
                                        <th>Normaal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>Hartfrequentie</td><td>60-100 bpm</td></tr>
                                    <tr><td>PR-interval</td><td>120-200 ms</td></tr>
                                    <tr><td>QRS-duur</td><td>< 120 ms</td></tr>
                                    <tr><td>QT-interval</td><td>< 440 ms (♂), < 460 ms (♀)</td></tr>
                                    <tr><td>P-golf duur</td><td>< 120 ms</td></tr>
                                    <tr><td>P-golf hoogte</td><td>< 2.5 mm</td></tr>
                                    <tr><td>Hartas</td><td>-30° tot +90°</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🧮 Hartfrequentie Berekening</h3>
                        </div>
                        <div class="card-body">
                            <div class="algorithm-box success">
                                <div class="algorithm-title">Regelmatig Ritme</div>
                                <p style="margin-top: 0.5rem;">
                                    <strong>HR = 300 / aantal grote hokjes tussen R-toppen</strong>
                                </p>
                                <p class="text-muted" style="font-size: 0.85rem; margin-top: 0.5rem;">
                                    Of memoriseer: 300-150-100-75-60-50
                                </p>
                            </div>
                            
                            <div class="algorithm-box warning mt-2">
                                <div class="algorithm-title">Onregelmatig Ritme</div>
                                <p style="margin-top: 0.5rem;">
                                    <strong>HR = aantal R-toppen in 6 sec × 10</strong>
                                </p>
                                <p class="text-muted" style="font-size: 0.85rem; margin-top: 0.5rem;">
                                    6 seconden = 30 grote hokjes
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Axis Determination -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🧭 As Bepaling (Snel)</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            <div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Lead I</th>
                                            <th>aVF</th>
                                            <th>As</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-success">+ (positief)</td>
                                            <td class="text-success">+ (positief)</td>
                                            <td><strong>Normaal</strong> (0° tot +90°)</td>
                                        </tr>
                                        <tr>
                                            <td class="text-success">+ (positief)</td>
                                            <td class="text-danger">- (negatief)</td>
                                            <td><strong>Linker as</strong> (-30° tot -90°)</td>
                                        </tr>
                                        <tr>
                                            <td class="text-danger">- (negatief)</td>
                                            <td class="text-success">+ (positief)</td>
                                            <td><strong>Rechter as</strong> (+90° tot +180°)</td>
                                        </tr>
                                        <tr>
                                            <td class="text-danger">- (negatief)</td>
                                            <td class="text-danger">- (negatief)</td>
                                            <td><strong>Extreme as</strong> ("no man's land")</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div>
                                <div class="info-box warning">
                                    <div class="info-box-icon">💡</div>
                                    <div class="info-box-content">
                                        <h4>Ezelsbruggetje</h4>
                                        <p><strong>"Duim omhoog"</strong> - Als Lead I positief is, wijst de as naar links (normaal of LAD)</p>
                                    </div>
                                </div>
                                <div class="info-box info mt-2">
                                    <div class="info-box-icon">📍</div>
                                    <div class="info-box-content">
                                        <h4>Oorzaken Asdeviatie</h4>
                                        <p><strong>LAD:</strong> LAFB, LVH, inferior MI</p>
                                        <p><strong>RAD:</strong> LPFB, RVH, lateraal MI, PE</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        // ========== QUIZ MODE ==========
        renderQuiz(container) {
            if (AppState.quiz.active) {
                this.renderActiveQuiz(container);
            } else {
                this.renderQuizSetup(container);
            }
        },

        renderQuizSetup(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🎯 Quiz Configuratie</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            <!-- Quiz Mode Selection -->
                            <div>
                                <h4 style="margin-bottom: 1rem;">Kies Quiz Modus</h4>
                                <div class="quick-actions" style="grid-template-columns: 1fr;">
                                    <div class="quick-action" onclick="ECGApp.startQuiz('standard')">
                                        <div class="quick-action-icon">📝</div>
                                        <div class="quick-action-title">Standaard Quiz</div>
                                        <div class="quick-action-desc">10 vragen, geen tijdslimiet</div>
                                    </div>
                                    <div class="quick-action" onclick="ECGApp.startQuiz('timed')">
                                        <div class="quick-action-icon">⏱️</div>
                                        <div class="quick-action-title">Tijdsdruk</div>
                                        <div class="quick-action-desc">30 seconden per vraag</div>
                                    </div>
                                    <div class="quick-action" onclick="ECGApp.startQuiz('survival')">
                                        <div class="quick-action-icon">💀</div>
                                        <div class="quick-action-title">Survivalmodus</div>
                                        <div class="quick-action-desc">Ga door tot je een fout maakt</div>
                                    </div>
                                    <div class="quick-action" onclick="ECGApp.startQuiz('clinical')">
                                        <div class="quick-action-icon">🏥</div>
                                        <div class="quick-action-title">Klinische Scenario's</div>
                                        <div class="quick-action-desc">ECG + patiënt context</div>
                                    </div>
                                    <div class="quick-action" onclick="ECGApp.startQuiz('exam')">
                                        <div class="quick-action-icon">🧪</div>
                                        <div class="quick-action-title">Examenmodus</div>
                                        <div class="quick-action-desc">20 vragen, zonder hints, domeinrapport</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Difficulty & Category -->
                            <div>
                                <h4 style="margin-bottom: 1rem;">Instellingen</h4>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Moeilijkheid</label>
                                    <select id="quizDifficulty" style="width: 100%; padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        <option value="all">Alle niveaus</option>
                                        <option value="easy">Makkelijk</option>
                                        <option value="medium">Gemiddeld</option>
                                        <option value="hard">Moeilijk</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Categorie</label>
                                    <select id="quizCategory" style="width: 100%; padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        <option value="all">Alle categorieën</option>
                                        ${Object.entries(ECGDatabase.categories).map(([id, cat]) => `
                                            <option value="${id}">${cat.icon} ${cat.name}</option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Aantal vragen</label>
                                    <select id="quizCount" style="width: 100%; padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        <option value="5" ${AppState.settings?.defaultQuizCount === 5 ? 'selected' : ''}>5 vragen</option>
                                        <option value="10" ${AppState.settings?.defaultQuizCount === 10 || !AppState.settings?.defaultQuizCount ? 'selected' : ''}>10 vragen</option>
                                        <option value="20" ${AppState.settings?.defaultQuizCount === 20 ? 'selected' : ''}>20 vragen</option>
                                        <option value="50" ${AppState.settings?.defaultQuizCount === 50 ? 'selected' : ''}>50 vragen</option>
                                    </select>
                                </div>

                                <button class="btn btn-primary btn-lg" style="width: 100%;" onclick="ECGApp.startQuiz('standard')">
                                    ▶️ Start Quiz
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Results -->
                ${AppState.user.quizHistory.length > 0 ? `
                    <div class="card mt-2">
                        <div class="card-header">
                            <h3 class="card-title">📊 Recente Resultaten</h3>
                        </div>
                        <div class="card-body">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Datum</th>
                                        <th>Modus</th>
                                        <th>Score</th>
                                        <th>Nauwkeurigheid</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${AppState.user.quizHistory.slice(-5).reverse().map(result => `
                                        <tr>
                                            <td>${Utils.formatDate(result.date)}</td>
                                            <td>${result.mode}</td>
                                            <td>${result.correct}/${result.total}</td>
                                            <td class="${result.accuracy >= 80 ? 'text-success' : result.accuracy >= 60 ? 'text-warning' : 'text-danger'}">
                                                ${result.accuracy}%
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
            `;
        },

        renderActiveQuiz(container) {
            const quiz = AppState.quiz;
            const rhythm = quiz.currentRhythm;
            const progress = ((quiz.currentQuestion) / quiz.totalQuestions) * 100;

            if (!rhythm) {
                container.innerHTML = '<p>Laden...</p>';
                return;
            }

            // Generate options
            const distractors = ECGDatabase.getDistractors(rhythm.id, 3);
            const options = Utils.shuffle([rhythm, ...distractors]);

            container.innerHTML = `
                <!-- Progress Bar -->
                <div class="card mb-2">
                    <div class="card-body" style="padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Vraag ${quiz.currentQuestion + 1} van ${quiz.totalQuestions}</span>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                ${quiz.mode === 'exam' ? '<span class="badge badge-hard">Examenmodus</span>' : ''}
                                <span class="text-success">✓ ${quiz.score}</span>
                                ${quiz.mode === 'timed' ? `
                                    <span class="text-warning" id="quizTimer">⏱️ ${quiz.timeRemaining}s</span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>

                <!-- ECG Display -->
                <div class="ecg-monitor mb-2">
                    <div class="ecg-monitor-header">
                        <div class="ecg-monitor-title">
                            <span>🎯</span>
                            Welk ritme zie je?
                        </div>
                        <div class="ecg-monitor-vitals">
                            <div class="vital-display">
                                <div class="vital-label">HR</div>
                                <div class="vital-value green">${rhythm.characteristics?.rate?.typical || '??'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="ecg-canvas-wrapper">
                        <canvas id="quizECG" class="ecg-canvas large"></canvas>
                        <div class="ecg-lead-label">II</div>
                    </div>
                </div>

                <!-- Answer Options -->
                <div class="card">
                    <div class="card-body">
                        <div class="quiz-options" id="quizOptions">
                            ${options.map((opt, index) => `
                                <div class="quiz-option" data-rhythm="${opt.id}" onclick="ECGApp.selectAnswer('${opt.id}')">
                                    <span class="quiz-option-key">${String.fromCharCode(65 + index)}</span>
                                    <div class="quiz-option-content">
                                        <div class="quiz-option-title">${opt.name}</div>
                                        <div class="quiz-option-desc">${opt.shortName} - ${opt.description.substring(0, 50)}...</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Feedback Panel -->
                        <div class="feedback-panel" id="feedbackPanel"></div>

                        <!-- Action Buttons -->
                        <div class="btn-group mt-3" style="justify-content: space-between;">
                            ${quiz.mode !== 'exam' && AppState.settings?.showHints !== false ? `
                                <button class="btn btn-outline" onclick="ECGApp.showHint()">
                                    💡 Hint
                                </button>
                            ` : '<span class="text-muted" style="font-size:0.85rem;">Hints staan uit</span>'}
                            <button class="btn btn-primary hidden" id="nextBtn" onclick="ECGApp.nextQuestion()">
                                Volgende →
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Draw ECG
            setTimeout(() => {
                const rate = rhythm.characteristics?.rate?.typical || 72;
                ECGRenderer.drawStaticStrip('quizECG', rhythm.id, { heartRate: rate });
            }, 100);

            // Start timer if timed mode
            if (quiz.mode === 'timed') {
                ECGApp.startQuizTimer();
            }
        },

        // ========== CLINICAL CASES ==========
        renderCases(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🏥 Klinische Cases</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Oefen met realistische IC scenario's waar je ECG interpretatie combineert met klinische context.</p>

                        <div class="grid-2">
                            ${ClinicalCases.getAllCases().map(caseData => `
                                <div class="card" style="cursor: pointer;" onclick="ECGApp.startCase('${caseData.id}')">
                                    <div class="card-body">
                                        <div class="case-header">
                                            <div class="case-avatar">${caseData.patientIcon}</div>
                                            <div class="case-info">
                                                <h3>${caseData.title}</h3>
                                                <p>${caseData.patientInfo}</p>
                                            </div>
                                        </div>
                                        <p class="text-muted" style="font-size: 0.9rem;">${caseData.presentation}</p>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                                            <span class="badge ${Utils.getDifficultyBadge(caseData.difficulty)}">${caseData.difficulty}</span>
                                            <span class="text-muted" style="font-size: 0.8rem;">${caseData.duration} min</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        },

        // ========== ACLS ALGORITHMS ==========
        renderACLS(container) {
            container.innerHTML = `
                <div class="emergency-banner">
                    <span class="pulse">🚨</span>
                    <span>ACLS Protocollen - Spoedsituaties</span>
                </div>

                <!-- Cardiac Arrest Algorithm -->
                <div class="card mb-2">
                    <div class="card-header">
                        <h3 class="card-title">💔 Hartstilstand Algoritme</h3>
                    </div>
                    <div class="card-body">
                        <div class="tabs">
                            <div class="tab active" onclick="ECGApp.switchACLSTab('shockable')">Schokbaar (VF/pVT)</div>
                            <div class="tab" onclick="ECGApp.switchACLSTab('nonshockable')">Niet-schokbaar (Asystolie/PEA)</div>
                        </div>

                        <div class="tab-content active" id="tab-shockable">
                            <div class="algorithm-box critical">
                                <div class="algorithm-title">⚡ VF / Polsloze VT</div>
                                <div class="algorithm-steps">
                                    <div class="algorithm-step critical">
                                        <span class="algorithm-step-num">1</span>
                                        <div><strong>DEFIBRILLATIE</strong> - gebruik fabrikantadviesenergie; bij onbekende instelling kies de hoogste aanbevolen energie en escaleer indien nodig</div>
                                    </div>
                                    <div class="algorithm-step">
                                        <span class="algorithm-step-num">2</span>
                                        <div><strong>CPR</strong> - 2 minuten, minimaliseer onderbrekingen (volg lokaal ALS-protocol)</div>
                                    </div>
                                    <div class="algorithm-step">
                                        <span class="algorithm-step-num">3</span>
                                        <div><strong>Ritmecheck</strong> - Nog VF/pVT?</div>
                                    </div>
                                    <div class="algorithm-step critical">
                                        <span class="algorithm-step-num">4</span>
                                        <div><strong>DEFIBRILLATIE</strong> - ga direct door met CPR; geef <strong>Adrenaline 1mg IV</strong> na de 3e schok, daarna elke 3-5 min</div>
                                    </div>
                                    <div class="algorithm-step">
                                        <span class="algorithm-step-num">5</span>
                                        <div><strong>CPR</strong> - 2 minuten</div>
                                    </div>
                                    <div class="algorithm-step critical">
                                        <span class="algorithm-step-num">6</span>
                                        <div><strong>Na 3e schok:</strong> <strong>Amiodaron 300mg IV</strong> (overweeg 150mg na 5e schok)</div>
                                    </div>
                                    <div class="algorithm-step">
                                        <span class="algorithm-step-num">7</span>
                                        <div>Herhaal cyclus. Overweeg <strong>Amiodaron 150mg</strong> bij 5e schok</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="tab-nonshockable">
                            <div class="algorithm-box warning">
                                <div class="algorithm-title">📉 Asystolie / PEA</div>
                                <div class="algorithm-steps">
                                    <div class="algorithm-step">
                                        <span class="algorithm-step-num">1</span>
                                        <div><strong>CPR</strong> starten - Goede kwaliteit!</div>
                                    </div>
                                    <div class="algorithm-step critical">
                                        <span class="algorithm-step-num">2</span>
                                        <div><strong>Adrenaline 1mg IV</strong> - Zo snel mogelijk</div>
                                    </div>
                                    <div class="algorithm-step">
                                        <span class="algorithm-step-num">3</span>
                                        <div><strong>CPR</strong> - 2 minuten</div>
                                    </div>
                                    <div class="algorithm-step">
                                        <span class="algorithm-step-num">4</span>
                                        <div><strong>Ritmecheck</strong> - Schokbaar geworden?</div>
                                    </div>
                                    <div class="algorithm-step">
                                        <span class="algorithm-step-num">5</span>
                                        <div><strong>Adrenaline 1mg IV</strong> elke 3-5 minuten</div>
                                    </div>
                                    <div class="algorithm-step">
                                        <span class="algorithm-step-num">6</span>
                                        <div><strong>Behandel reversibele oorzaken (4H/4T)</strong></div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid-2 mt-3">
                                <div class="algorithm-box info">
                                    <div class="algorithm-title">4 H's</div>
                                    <ul class="styled-list">
                                        <li><strong>H</strong>ypoxie</li>
                                        <li><strong>H</strong>ypovolemie</li>
                                        <li><strong>H</strong>ypo/hyperkaliëmie</li>
                                        <li><strong>H</strong>ypothermie</li>
                                    </ul>
                                </div>
                                <div class="algorithm-box info">
                                    <div class="algorithm-title">4 T's</div>
                                    <ul class="styled-list">
                                        <li><strong>T</strong>ensie pneumothorax</li>
                                        <li><strong>T</strong>amponade (harttamponade)</li>
                                        <li><strong>T</strong>oxines</li>
                                        <li><strong>T</strong>rombose (coronair/pulmonaal)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tachycardia Algorithm -->
                <div class="card mb-2">
                    <div class="card-header">
                        <h3 class="card-title">⚡ Tachycardie met Pols</h3>
                    </div>
                    <div class="card-body">
                        <div class="algorithm-box">
                            <div class="algorithm-title">🔍 Eerste Beoordeling</div>
                            <p style="margin: 0.5rem 0;">Is de patiënt <strong>hemodynamisch instabiel</strong>?</p>
                            <ul class="styled-list">
                                <li>Hypotensie (SBP < 90)</li>
                                <li>Bewustzijnsdaling</li>
                                <li>Pijn op de borst</li>
                                <li>Acuut hartfalen</li>
                            </ul>
                        </div>

                        <div class="grid-2 mt-2">
                            <div class="algorithm-box critical">
                                <div class="algorithm-title">❌ INSTABIEL</div>
                                <p style="margin: 0.5rem 0;"><strong>Gesynchroniseerde cardioversie!</strong></p>
                                <ul class="styled-list">
                                    <li>Smal complex: 50-100J</li>
                                    <li>Breed complex: 100-200J</li>
                                    <li>Sedatie indien tijd</li>
                                </ul>
                            </div>
                            <div class="algorithm-box success">
                                <div class="algorithm-title">✓ STABIEL</div>
                                <p style="margin: 0.5rem 0;">Beoordeel QRS breedte:</p>
                                <ul class="styled-list">
                                    <li><strong>Smal (< 120ms):</strong> Vagale manoeuvres → Adenosine</li>
                                    <li><strong>Breed (≥ 120ms):</strong> beoordeel regelmaat; monomorf regelmatig → anti-aritmicum mogelijk, onregelmatig/instabiel → (gesynchroniseerde) cardioversie en specialistische beoordeling</li>
                                </ul>
                            </div>
                        </div>

                        <div class="info-box warning mt-2">
                            <div class="info-box-icon">⚠️</div>
                            <div class="info-box-content">
                                <h4>Adenosine Dosering</h4>
                                <p><strong>6mg</strong> snelle IV push → <strong>12mg</strong> → <strong>12mg</strong><br>
                                Geef via grote perifere lijn, gevolgd door 20ml NaCl flush</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bradycardia Algorithm -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🐢 Bradycardie</h3>
                    </div>
                    <div class="card-body">
                        <div class="algorithm-box">
                            <div class="algorithm-title">🔍 Beoordeling</div>
                            <p style="margin: 0.5rem 0;">HF < 60 en symptomen of hemodynamische instabiliteit?</p>
                        </div>

                        <div class="algorithm-box warning mt-2">
                            <div class="algorithm-title">💊 Behandeling Symptomatische Bradycardie</div>
                            <div class="algorithm-steps">
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">1</span>
                                    <div><strong>Atropine 0,5mg (500 μg) IV</strong> - Herhaal elke 3-5 min (max 3mg)</div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">2</span>
                                    <div><strong>Transcutane pacing</strong> - Bij onvoldoende respons</div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">3</span>
                                    <div><strong>Adrenaline infusie</strong> 2-10 μg/min of <strong>Dopamine</strong> 5-20 μg/kg/min</div>
                                </div>
                                <div class="algorithm-step">
                                    <span class="algorithm-step-num">4</span>
                                    <div><strong>Transveneuze pacing</strong> - Definitief</div>
                                </div>
                            </div>
                        </div>

                        <div class="info-box danger mt-2">
                            <div class="info-box-icon">🚫</div>
                            <div class="info-box-content">
                                <h4>Atropine NIET effectief bij:</h4>
                                <p>AV-blok type II (Mobitz II) en derdegraads AV-blok met breed QRS escape.<br>
                                Start direct met pacing!</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        // ========== MEDICATIONS ==========
        renderDrugs(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">💊 Medicatie & ECG Effecten</h3>
                    </div>
                    <div class="card-body">
                        <div class="tabs">
                            <div class="tab active" onclick="ECGApp.switchDrugTab('antiarrhythmic')">Anti-aritmica</div>
                            <div class="tab" onclick="ECGApp.switchDrugTab('emergency')">Spoed Medicatie</div>
                            <div class="tab" onclick="ECGApp.switchDrugTab('qtprolonging')">QT-verlenging</div>
                        </div>

                        <div class="tab-content active" id="tab-antiarrhythmic">
                            <div class="accordion">
                                <!-- Amiodaron -->
                                <div class="accordion-item open">
                                    <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
                                        <h4>💜 Amiodaron (Klasse III)</h4>
                                        <span class="accordion-icon">▼</span>
                                    </div>
                                    <div class="accordion-body">
                                        <div class="accordion-content">
                                            <p><strong>Indicaties:</strong> VT, VF, AF rate/rhythm control, SVT</p>
                                            <p><strong>Dosering:</strong></p>
                                            <ul class="styled-list">
                                                <li>VF/pVT: 300mg IV bolus, dan 150mg</li>
                                                <li>Stabiele VT: 150mg IV over 10 min</li>
                                                <li>AF: 300mg IV over 1u, dan 900mg/24u</li>
                                            </ul>
                                            <p><strong>ECG effecten:</strong></p>
                                            <ul class="styled-list">
                                                <li>QT-verlenging</li>
                                                <li>Bradycardie</li>
                                                <li>PR-verlenging</li>
                                            </ul>
                                            <div class="info-box warning mt-2">
                                                <div class="info-box-icon">⚠️</div>
                                                <div class="info-box-content">
                                                    <p><strong>Let op:</strong> Torsades de Pointes risico, hypotensie bij snelle infusie</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Adenosine -->
                                <div class="accordion-item">
                                    <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
                                        <h4>💚 Adenosine</h4>
                                        <span class="accordion-icon">▼</span>
                                    </div>
                                    <div class="accordion-body">
                                        <div class="accordion-content">
                                            <p><strong>Indicaties:</strong> Regelmatige smalcomplex SVT (diagnostisch & therapeutisch); alleen selectief bij regelmatige monomorfe breedcomplex tachycardie</p>
                                            <p><strong>Dosering:</strong> 6mg → 12mg → 12mg snelle IV push + flush</p>
                                            <p><strong>ECG effecten:</strong></p>
                                            <ul class="styled-list">
                                                <li>Transiënte asystolie (normaal!)</li>
                                                <li>Onthult onderliggend ritme (flutter, atriale tachycardie)</li>
                                                <li>Beëindigt AVNRT/AVRT</li>
                                            </ul>
                                            <div class="info-box danger mt-2">
                                                <div class="info-box-icon">🚫</div>
                                                <div class="info-box-content">
                                                    <p><strong>Vermijd/let op:</strong> WPW + AF (kan VF induceren), 2e/3e graads AV-blok zonder pacemaker; wees voorzichtig bij ernstige astma/COPD. Gebruik adenosine vooral bij regelmatige monomorfe ritmes.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bètablokkers -->
                                <div class="accordion-item">
                                    <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
                                        <h4>💙 Bètablokkers (Klasse II)</h4>
                                        <span class="accordion-icon">▼</span>
                                    </div>
                                    <div class="accordion-body">
                                        <div class="accordion-content">
                                            <p><strong>Voorbeelden:</strong> Metoprolol, Esmolol, Bisoprolol</p>
                                            <p><strong>Indicaties:</strong> Rate control AF/flutter, SVT, sinustachycardie, ACS</p>
                                            <p><strong>Dosering (Metoprolol):</strong> 2.5-5mg IV langzaam, herhaal elke 5 min (max 15mg)</p>
                                            <p><strong>ECG effecten:</strong></p>
                                            <ul class="styled-list">
                                                <li>Hartfrequentie verlaging</li>
                                                <li>PR-verlenging</li>
                                                <li>Geen significante QRS/QT verandering</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Digoxine -->
                                <div class="accordion-item">
                                    <div class="accordion-header" onclick="this.parentElement.classList.toggle('open')">
                                        <h4>💛 Digoxine</h4>
                                        <span class="accordion-icon">▼</span>
                                    </div>
                                    <div class="accordion-body">
                                        <div class="accordion-content">
                                            <p><strong>Indicaties:</strong> AF rate control (vooral + hartfalen)</p>
                                            <p><strong>Dosering:</strong> 0.5mg IV, dan 0.25mg elke 6u (max 1mg/24u)</p>
                                            <p><strong>ECG effect (therapeutisch):</strong></p>
                                            <ul class="styled-list">
                                                <li>ST "scooping" (Salvador Dalí snor)</li>
                                                <li>QT verkorting</li>
                                                <li>T afvlakking/inversie</li>
                                            </ul>
                                            <p><strong>ECG toxiciteit:</strong></p>
                                            <ul class="styled-list">
                                                <li>Elke aritmie mogelijk!</li>
                                                <li>Bidirectionele VT (pathognomonisch)</li>
                                                <li>Versneld junctioneel ritme</li>
                                                <li>AF met regelmatige ventrikelrespons</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="tab-emergency">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Medicatie</th>
                                        <th>Indicatie</th>
                                        <th>Dosering</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Adrenaline</strong></td>
                                        <td>Hartstilstand, anafylaxie, ernstige bradycardie</td>
                                        <td>1mg IV elke 3-5 min (hartstilstand)<br>2-10 μg/min infusie (bradycardie)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Atropine</strong></td>
                                        <td>Symptomatische bradycardie</td>
                                        <td>0,5mg (500 μg) IV elke 3-5 min (max 3mg)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Magnesium</strong></td>
                                        <td>Torsades de Pointes, hypomagnesiëmie</td>
                                        <td>2g IV over 10-15 min (TdP: bolus)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Calcium</strong></td>
                                        <td>Hyperkaliëmie, hypocalciëmie, Ca-blokker overdosis</td>
                                        <td>10ml CaCl 10% of 30ml Ca-gluconaat 10%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>NaHCO3</strong></td>
                                        <td>Hyperkaliëmie, TCA overdosis, ernstige acidose</td>
                                        <td>50-100 mEq IV</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-content" id="tab-qtprolonging">
                            <div class="info-box danger mb-2">
                                <div class="info-box-icon">⚠️</div>
                                <div class="info-box-content">
                                    <h4>Risico op Torsades de Pointes!</h4>
                                    <p>Combinaties van QT-verlengende medicatie vermijden. Monitor QTc.</p>
                                </div>
                            </div>

                            <div class="grid-2">
                                <div>
                                    <h4 style="margin-bottom: 0.75rem;">Anti-aritmica</h4>
                                    <ul class="styled-list">
                                        <li>Amiodaron</li>
                                        <li>Sotalol</li>
                                        <li>Flecaïnide</li>
                                        <li>Procaïnamide</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: 0.75rem;">Antibiotica</h4>
                                    <ul class="styled-list">
                                        <li>Macroliden (azitromycine, erytromycine)</li>
                                        <li>Fluoroquinolonen (ciprofloxacine, moxifloxacine)</li>
                                        <li>Cotrimoxazol</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: 0.75rem;">Psychiatrie</h4>
                                    <ul class="styled-list">
                                        <li>Haloperidol</li>
                                        <li>Antidepressiva (TCA's, SSRI's)</li>
                                        <li>Antipsychotica (quetiapine, risperidon)</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: 0.75rem;">Overig</h4>
                                    <ul class="styled-list">
                                        <li>Methadon</li>
                                        <li>Ondansetron</li>
                                        <li>Domperidon</li>
                                        <li>Antihistaminica</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        // ========== CRITERIA & REFERENCE ==========
        renderCriteria(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📏 ECG Criteria & Referentiewaarden</h3>
                    </div>
                    <div class="card-body">
                        <div class="tabs">
                            <div class="tab active" onclick="ECGApp.switchCriteriaTab('intervals')">Intervallen</div>
                            <div class="tab" onclick="ECGApp.switchCriteriaTab('hypertrophy')">Hypertrofie</div>
                            <div class="tab" onclick="ECGApp.switchCriteriaTab('ischemia')">Ischemie</div>
                            <div class="tab" onclick="ECGApp.switchCriteriaTab('blocks')">Blokken</div>
                        </div>

                        <div class="tab-content active" id="tab-intervals">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Parameter</th>
                                        <th>Normaal</th>
                                        <th>Afwijkend</th>
                                        <th>Klinische betekenis</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Hartfrequentie</strong></td>
                                        <td>60-100 bpm</td>
                                        <td>< 60: bradycardie<br>> 100: tachycardie</td>
                                        <td>Beoordeel in klinische context</td>
                                    </tr>
                                    <tr>
                                        <td><strong>PR-interval</strong></td>
                                        <td>120-200 ms<br>(3-5 kleine hokjes)</td>
                                        <td>< 120: pre-excitatie (WPW)<br>> 200: 1e graads AV-blok</td>
                                        <td>Geleidingstijd atrium → ventrikel</td>
                                    </tr>
                                    <tr>
                                        <td><strong>QRS-duur</strong></td>
                                        <td>< 120 ms<br>(< 3 kleine hokjes)</td>
                                        <td>120-150: incompleet BBB<br>> 150: compleet BBB</td>
                                        <td>Intraventriculaire geleiding</td>
                                    </tr>
                                    <tr>
                                        <td><strong>QTc-interval</strong></td>
                                        <td>♂ < 440 ms<br>♀ < 460 ms</td>
                                        <td>> 500 ms: hoog TdP risico<br>< 340 ms: kort QT syndroom</td>
                                        <td>QTc = QT / √RR (Bazett)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>P-golf duur</strong></td>
                                        <td>< 120 ms</td>
                                        <td>> 120 ms: P-mitrale (LAE)</td>
                                        <td>Atriale depolarisatietijd</td>
                                    </tr>
                                    <tr>
                                        <td><strong>P-golf hoogte</strong></td>
                                        <td>< 2.5 mm</td>
                                        <td>> 2.5 mm: P-pulmonale (RAE)</td>
                                        <td>Atriale amplitude in II</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-content" id="tab-hypertrophy">
                            <h4 style="margin-bottom: 1rem;">Linkerventrikel Hypertrofie (LVH)</h4>
                            <div class="algorithm-box info">
                                <div class="algorithm-title">Sokolow-Lyon Criteria</div>
                                <p style="margin: 0.5rem 0;"><strong>S V1 + R V5/V6 ≥ 35 mm</strong></p>
                                <p class="text-muted">Specificiteit ~95%, sensitiviteit ~20%</p>
                            </div>
                            <div class="algorithm-box info mt-2">
                                <div class="algorithm-title">Cornell Criteria</div>
                                <p style="margin: 0.5rem 0;">
                                    <strong>♂: R aVL + S V3 > 28 mm</strong><br>
                                    <strong>♀: R aVL + S V3 > 20 mm</strong>
                                </p>
                            </div>

                            <h4 style="margin: 1.5rem 0 1rem;">Rechterventrikel Hypertrofie (RVH)</h4>
                            <div class="algorithm-box warning">
                                <div class="algorithm-title">RVH Criteria</div>
                                <ul class="styled-list" style="margin-top: 0.5rem;">
                                    <li>R V1 > 7 mm</li>
                                    <li>R/S ratio V1 > 1</li>
                                    <li>Rechter asdeviatie (> 90°)</li>
                                    <li>S V5/V6 > 7 mm</li>
                                    <li>qR patroon V1</li>
                                </ul>
                            </div>
                        </div>

                        <div class="tab-content" id="tab-ischemia">
                            <h4 style="margin-bottom: 1rem;">STEMI Criteria</h4>
                            <div class="algorithm-box critical">
                                <div class="algorithm-title">ST-elevatie Significantie</div>
                                <ul class="styled-list" style="margin-top: 0.5rem;">
                                    <li><strong>V2-V3:</strong> ≥ 2 mm (♂ > 40j), ≥ 2.5 mm (♂ < 40j), ≥ 1.5 mm (♀)</li>
                                    <li><strong>Overige afleidingen:</strong> ≥ 1 mm in 2 aangrenzende afleidingen</li>
                                    <li><strong>Posterior:</strong> ST-depressie V1-V3 + hoge R</li>
                                </ul>
                            </div>

                            <h4 style="margin: 1.5rem 0 1rem;">Coronaire Territoria</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Locatie</th>
                                        <th>Afleidingen</th>
                                        <th>Arterie</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>Septaal</td><td>V1-V2</td><td>LAD (septale tak)</td></tr>
                                    <tr><td>Anterior</td><td>V3-V4</td><td>LAD</td></tr>
                                    <tr><td>Lateraal</td><td>I, aVL, V5-V6</td><td>LCx of LAD</td></tr>
                                    <tr><td>Inferior</td><td>II, III, aVF</td><td>RCA (80%) of LCx</td></tr>
                                    <tr><td>Posterior</td><td>V7-V9 (of reciprook V1-V3)</td><td>RCA of LCx</td></tr>
                                    <tr><td>Rechter ventrikel</td><td>V4R</td><td>RCA (proximaal)</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-content" id="tab-blocks">
                            <h4 style="margin-bottom: 1rem;">Bundeltakblok Criteria</h4>
                            <div class="grid-2">
                                <div class="algorithm-box info">
                                    <div class="algorithm-title">RBBB</div>
                                    <ul class="styled-list" style="margin-top: 0.5rem;">
                                        <li>QRS ≥ 120 ms</li>
                                        <li>rSR' in V1-V2 (M-patroon)</li>
                                        <li>Brede S in I, V6</li>
                                        <li>Ezelsbruggetje: <strong>MaRRoW</strong></li>
                                    </ul>
                                </div>
                                <div class="algorithm-box warning">
                                    <div class="algorithm-title">LBBB</div>
                                    <ul class="styled-list" style="margin-top: 0.5rem;">
                                        <li>QRS ≥ 120 ms</li>
                                        <li>Brede R in I, aVL, V5-V6</li>
                                        <li>QS of rS in V1</li>
                                        <li>Afwezig septale q in I, V5-V6</li>
                                        <li>Ezelsbruggetje: <strong>WiLLiaM</strong></li>
                                    </ul>
                                </div>
                            </div>

                            <h4 style="margin: 1.5rem 0 1rem;">AV-blok Classificatie</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Kenmerken</th>
                                        <th>Urgentie</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1e graads</td>
                                        <td>PR > 200ms, elke P geleidt</td>
                                        <td class="text-success">Laag</td>
                                    </tr>
                                    <tr>
                                        <td>2e graads type I<br>(Wenckebach)</td>
                                        <td>Progressieve PR-verlenging → dropped beat</td>
                                        <td class="text-warning">Medium</td>
                                    </tr>
                                    <tr>
                                        <td>2e graads type II<br>(Mobitz II)</td>
                                        <td>Constante PR → plotse dropped beat</td>
                                        <td class="text-danger">Hoog</td>
                                    </tr>
                                    <tr>
                                        <td>3e graads<br>(Compleet)</td>
                                        <td>Geen relatie P-QRS, escape ritme</td>
                                        <td class="text-danger">KRITIEK</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
    };

    // ==================== CLINICAL CASES DATA ====================
    const ClinicalCases = {
        cases: [
            {
                id: 'case_chest_pain',
                title: 'Pijn op de borst op de SEH',
                patientIcon: '👨',
                patientInfo: 'Man, 58 jaar',
                presentation: 'Plotselinge pijn op de borst sinds 2 uur, uitstralend naar linkerarm, misselijk.',
                vitals: { hr: 95, bp: '150/95', spo2: 96, rr: 20 },
                rhythm: 'stemi_anterior',
                difficulty: 'medium',
                duration: 10,
                questions: [
                    {
                        question: 'Wat is je eerste diagnose op basis van dit ECG?',
                        options: ['Normaal sinusritme', 'Anterieur STEMI', 'NSTEMI', 'Pericarditis'],
                        correct: 1,
                        explanation: 'ST-elevatie in V1-V4 met reciproke depressie in II, III, aVF wijst op een anterieur STEMI door LAD occlusie.'
                    },
                    {
                        question: 'Wat is de eerste actie?',
                        options: ['Troponine afwachten', 'CT-thorax', 'Cath lab activeren', 'Stress ECG'],
                        correct: 2,
                        explanation: 'Bij STEMI geldt "tijd = hartspier". Direct cath lab activeren voor primaire PCI binnen 90 minuten.'
                    }
                ]
            },
            {
                id: 'case_syncope',
                title: 'Syncope bij oudere patiënt',
                patientIcon: '👴',
                patientInfo: 'Man, 78 jaar',
                presentation: 'Collaps thuis, geen pijn, eerder ook "wegrakingen". Digoxine en metoprolol gebruik.',
                vitals: { hr: 35, bp: '90/60', spo2: 94, rr: 14 },
                rhythm: 'avblock_3rd',
                difficulty: 'hard',
                duration: 12,
                questions: [
                    {
                        question: 'Welk ritme zie je?',
                        options: ['Sinusbradycardie', 'Tweedegraads AV-blok', 'Derdegraads AV-blok', 'Junctioneel ritme'],
                        correct: 2,
                        explanation: 'P-golven en QRS-complexen zijn volledig onafhankelijk van elkaar. Dit is compleet hartblok.'
                    },
                    {
                        question: 'Welke behandeling is nodig?',
                        options: ['Afwachten', 'Alleen atropine', 'Transcutane pacing', 'Adenosine'],
                        correct: 2,
                        explanation: 'Bij compleet hartblok met hemodynamische instabiliteit is transcutane pacing geïndiceerd als bridge naar transveneuze pacing/permanente pacemaker.'
                    }
                ]
            },
            {
                id: 'case_palpitations',
                title: 'Hartkloppingen op de IC',
                patientIcon: '👩',
                patientInfo: 'Vrouw, 34 jaar',
                presentation: 'Plotselinge hartkloppingen, licht duizelig, postoperatief dag 2 na appendectomie.',
                vitals: { hr: 185, bp: '105/70', spo2: 98, rr: 18 },
                rhythm: 'svt',
                difficulty: 'easy',
                duration: 8,
                questions: [
                    {
                        question: 'Wat is de meest waarschijnlijke diagnose?',
                        options: ['Sinustachycardie', 'Atriumfibrilleren', 'SVT', 'Ventriculaire tachycardie'],
                        correct: 2,
                        explanation: 'Regelmatige smalle complex tachycardie met een frequentie van 185/min zonder duidelijke P-golven wijst op SVT.'
                    },
                    {
                        question: 'Wat is de eerste behandelstap?',
                        options: ['Cardioversie', 'Vagale manoeuvres', 'Amiodaron', 'Defibrillatie'],
                        correct: 1,
                        explanation: 'Bij stabiele SVT beginnen we met vagale manoeuvres (bij voorkeur gemodificeerde Valsalva). Als dit faalt, adenosine.'
                    }
                ]
            },
            {
                id: 'case_resuscitation',
                title: 'Reanimatie op de IC',
                patientIcon: '🏥',
                patientInfo: 'Man, 65 jaar',
                presentation: 'Post-CABG dag 1, plotseling niet reagerend, geen pols voelbaar.',
                vitals: { hr: 0, bp: '-', spo2: '-', rr: 0 },
                rhythm: 'vfib',
                difficulty: 'medium',
                duration: 10,
                questions: [
                    {
                        question: 'Welk ritme zie je?',
                        options: ['Asystolie', 'PEA', 'Ventrikelfibrilleren', 'Fijne VF'],
                        correct: 2,
                        explanation: 'Chaotisch ritme zonder herkenbare QRS-complexen met variërende amplitude = ventrikelfibrilleren.'
                    },
                    {
                        question: 'Wat is de eerste actie?',
                        options: ['Adrenaline toedienen', 'Defibrilleren (fabrikantadviesenergie)', 'Intuberen', 'Echocardiogram'],
                        correct: 1,
                        explanation: 'VF is een schokbaar ritme. Start CPR en defibrilleer zo snel mogelijk met fabrikantadviesenergie (bij bifasisch vaak 120-200J), met energie-escalatie volgens lokaal protocol.'
                    }
                ]
            },
            {
                id: 'case_potassium',
                title: 'Spierzwakte en ECG veranderingen',
                patientIcon: '👨‍🦳',
                patientInfo: 'Man, 72 jaar',
                presentation: 'Chronische nierinsufficiëntie, gemiste dialyse, spierzwakte, bradycard op monitor.',
                vitals: { hr: 45, bp: '100/70', spo2: 95, rr: 16 },
                rhythm: 'hyperkalemia',
                difficulty: 'hard',
                duration: 12,
                questions: [
                    {
                        question: 'Wat valt op aan dit ECG?',
                        options: ['ST-elevatie', 'Spitse T-golven en breed QRS', 'Diepe Q-golven', 'Delta golven'],
                        correct: 1,
                        explanation: 'Spitse "tenting" T-golven, verbrede QRS-complexen en afgevlakte P-golven zijn klassieke tekenen van hyperkaliëmie.'
                    },
                    {
                        question: 'Wat is de eerste behandeling?',
                        options: ['Insuline/glucose', 'Calcium IV', 'Dialyse', 'Natriumbicarbonaat'],
                        correct: 1,
                        explanation: 'Calcium IV is de eerste stap - het stabiliseert de hartspiercel membraan. Daarna K+ verlagen met insuline/glucose en elimineren via dialyse.'
                    }
                ]
            },
            {
                id: 'case_af_rvr',
                title: 'Snelle AF op de IC',
                patientIcon: '👵',
                patientInfo: 'Vrouw, 68 jaar',
                presentation: 'Opgenomen voor pneumonie, nu kortademig, onregelmatige pols.',
                vitals: { hr: 142, bp: '130/85', spo2: 92, rr: 24 },
                rhythm: 'atrial_fibrillation',
                difficulty: 'medium',
                duration: 10,
                questions: [
                    {
                        question: 'Wat is het ritme?',
                        options: ['Atriumflutter', 'Atriumfibrilleren', 'MAT', 'Sinustachycardie'],
                        correct: 1,
                        explanation: 'Onregelmatig onregelmatig ritme zonder duidelijke P-golven, met fibrillatiegolven in de baseline = atriumfibrilleren.'
                    },
                    {
                        question: 'Welke behandeling is eerste keus voor rate control?',
                        options: ['Flecaïnide', 'Metoprolol', 'Amiodaron', 'Adenosine'],
                        correct: 1,
                        explanation: 'Bij stabiele AF is rate control meestal met bètablokker (metoprolol) of non-DHP calciumantagonist; digoxine vooral bij specifieke situaties (bijv. hartfalen/sedentair). Flecaïnide is voor rhythm control.'
                    }
                ]
            }
        ],

        getAllCases() {
            return this.cases;
        },

        getCaseById(id) {
            return this.cases.find(c => c.id === id);
        }
    };

    // ==================== DEEL 4 GAAT HIER VERDER ====================

    // ==================== QUIZ LOGIC ====================
    const QuizEngine = {
        getTimedSeconds() {
            return parseInt(AppState.settings?.timerSeconds, 10) || 30;
        },
        
        // Initialize a new quiz
        init(options = {}) {
            const quiz = AppState.quiz;
            
            // Reset quiz state
            quiz.active = true;
            quiz.mode = options.mode || 'standard';
            quiz.difficulty = options.difficulty || 'all';
            quiz.category = options.category || 'all';
            quiz.moduleId = options.moduleId || null;
            quiz.currentQuestion = 0;
            quiz.totalQuestions = options.totalQuestions || 10;
            quiz.score = 0;
            quiz.answers = [];
            quiz.selectedAnswer = null;
            quiz.showingFeedback = false;
            quiz.timeRemaining = quiz.mode === 'timed' ? this.getTimedSeconds() : 0;
            
            // For survival mode, unlimited questions
            if (quiz.mode === 'survival') {
                quiz.totalQuestions = 999;
            }
            if (quiz.mode === 'exam') {
                quiz.totalQuestions = 20;
                quiz.difficulty = 'all';
                quiz.category = 'all';
            }
            
            // Generate first question
            this.generateQuestion();
            
            return quiz;
        },

        // Generate a new question
        generateQuestion() {
            const quiz = AppState.quiz;
            
            // Get rhythm based on settings
            const options = {
                difficulty: quiz.difficulty,
                category: quiz.category,
                exclude: quiz.answers.map(a => a.rhythmId) // Don't repeat rhythms
            };
            if (quiz.moduleId) {
                options.moduleId = quiz.moduleId;
            }

            const getPool = () => {
                let pool = quiz.moduleId
                    ? LearningPathEngine.getModuleRhythms(quiz.moduleId)
                    : ECGDatabase.getAllRhythms();

                if (quiz.category && quiz.category !== 'all') {
                    pool = pool.filter(r => r.category === quiz.category);
                }
                if (quiz.difficulty && quiz.difficulty !== 'all') {
                    pool = pool.filter(r => r.difficulty === quiz.difficulty);
                }
                return pool;
            };
            
            // For category-specific quiz
            const pool = getPool();
            if (pool.length > 0) {
                const available = pool.filter(r => !options.exclude.includes(r.id));
                const source = available.length > 0 ? available : pool;
                quiz.currentRhythm = source[Math.floor(Math.random() * source.length)];
            } else {
                quiz.currentRhythm = ECGDatabase.getRandomRhythm(options);
            }
            
            // Reset question state
            quiz.selectedAnswer = null;
            quiz.showingFeedback = false;
            
            // Reset timer for timed mode
            if (quiz.mode === 'timed') {
                quiz.timeRemaining = this.getTimedSeconds();
            }
            
            return quiz.currentRhythm;
        },

        // Check answer
        checkAnswer(selectedRhythmId) {
            const quiz = AppState.quiz;
            
            if (quiz.showingFeedback) return null;
            
            quiz.selectedAnswer = selectedRhythmId;
            quiz.showingFeedback = true;
            
            const isCorrect = selectedRhythmId === quiz.currentRhythm.id;
            
            // Update score
            if (isCorrect) {
                quiz.score++;
                AppState.user.totalCorrect++;
            }
            AppState.user.totalAnswered++;
            
            // Calculate XP
            const timeBonus = quiz.mode === 'timed' ? Math.floor(quiz.timeRemaining / 3) : 0;
            const xpEarned = Utils.calculateXP(isCorrect, quiz.currentRhythm.difficulty, timeBonus);
            AppState.user.xp += xpEarned;
            
            // Update streak
            if (isCorrect) {
                AppState.user.streak++;
            } else if (quiz.mode === 'survival') {
                // End survival mode on wrong answer
                this.endQuiz();
            }
            
            // Record answer
            quiz.answers.push({
                rhythmId: quiz.currentRhythm.id,
                rhythmName: quiz.currentRhythm.name,
                selectedId: selectedRhythmId,
                correct: isCorrect,
                xpEarned,
                timeSpent: quiz.mode === 'timed' ? (this.getTimedSeconds() - quiz.timeRemaining) : 0
            });
            
            // Stop timer
            if (quiz.timerInterval) {
                clearInterval(quiz.timerInterval);
                quiz.timerInterval = null;
            }
            
            // Save progress
            Storage.save();
            
            return {
                isCorrect,
                correctRhythm: quiz.currentRhythm,
                xpEarned
            };
        },

        // Move to next question
        nextQuestion() {
            const quiz = AppState.quiz;
            
            quiz.currentQuestion++;
            
            // Check if quiz is complete
            if (quiz.currentQuestion >= quiz.totalQuestions) {
                this.endQuiz();
                return false;
            }
            
            // Generate next question
            this.generateQuestion();
            return true;
        },

        // End the quiz
        endQuiz() {
            const quiz = AppState.quiz;
            
            // Stop timer
            if (quiz.timerInterval) {
                clearInterval(quiz.timerInterval);
                quiz.timerInterval = null;
            }
            
            // Calculate final stats
            const totalAnswered = quiz.answers.length;
            const correctAnswers = quiz.answers.filter(a => a.correct).length;
            const accuracy = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;
            const totalXP = quiz.answers.reduce((sum, a) => sum + a.xpEarned, 0);
            
            // Save to history
            AppState.user.quizHistory.push({
                date: new Date().toISOString(),
                mode: quiz.mode,
                difficulty: quiz.difficulty,
                category: quiz.category,
                moduleId: quiz.moduleId,
                total: totalAnswered,
                correct: correctAnswers,
                accuracy,
                xpEarned: totalXP,
                answers: quiz.answers
            });
            
            // Check for mastered rhythms
            this.updateMasteredRhythms();
            LearningPathEngine.syncState();
            
            // Reset quiz state
            quiz.active = false;
            
            // Save
            Storage.save();
            
            // Show results
            ECGApp.showQuizResults({
                total: totalAnswered,
                correct: correctAnswers,
                accuracy,
                xpEarned: totalXP,
                answers: quiz.answers
            });
        },

        // Update mastered rhythms based on performance
        updateMasteredRhythms() {
            const history = AppState.user.quizHistory;
            const rhythmStats = {};
            
            // Aggregate stats per rhythm from all quiz answers
            history.forEach(quiz => {
                if (quiz.answers) {
                    quiz.answers.forEach(answer => {
                        if (!rhythmStats[answer.rhythmId]) {
                            rhythmStats[answer.rhythmId] = { correct: 0, total: 0 };
                        }
                        rhythmStats[answer.rhythmId].total++;
                        if (answer.correct) {
                            rhythmStats[answer.rhythmId].correct++;
                        }
                    });
                }
            });
            
            // Mark as mastered if >= 3 correct answers with >= 80% accuracy
            for (const [rhythmId, stats] of Object.entries(rhythmStats)) {
                const accuracy = stats.total > 0 ? (stats.correct / stats.total) : 0;
                if (stats.correct >= 3 && accuracy >= 0.8) {
                    if (!AppState.user.masteredRhythms.includes(rhythmId)) {
                        AppState.user.masteredRhythms.push(rhythmId);
                    }
                }
            }
        },

        // Get hint for current question
        getHint() {
            const rhythm = AppState.quiz.currentRhythm;
            if (!rhythm) return null;
            
            const hints = rhythm.quizHints || rhythm.ecgFeatures || [];
            if (hints.length === 0) return 'Geen hint beschikbaar';
            
            return hints[Math.floor(Math.random() * hints.length)];
        },

        // Timer tick (for timed mode)
        tick() {
            const quiz = AppState.quiz;
            
            if (!quiz.active || quiz.showingFeedback) return;
            
            quiz.timeRemaining--;
            
            // Update display
            const timerEl = document.getElementById('quizTimer');
            if (timerEl) {
                timerEl.textContent = `⏱️ ${quiz.timeRemaining}s`;
                if (quiz.timeRemaining <= 10) {
                    timerEl.classList.add('text-danger');
                }
            }
            
            // Time's up
            if (quiz.timeRemaining <= 0) {
                this.checkAnswer('timeout');
                ECGApp.showTimeoutFeedback();
            }
        }
    };

    // ==================== MAIN APP CONTROLLER ====================
    const ECGApp = {
        
        // ========== INITIALIZATION ==========
        init() {
            console.log('🫀 ECG Trainer Pro v2.0 initializing...');
            
            // Load saved data
            Storage.load();
            LearningPathEngine.syncState();
            
            // Initialize navigation
            Navigation.init();
            
            // Update sidebar stats
            this.updateSidebarStats();
            
            // Setup keyboard shortcuts
            this.setupKeyboardShortcuts();
            
            // Setup window events
            window.addEventListener('beforeunload', () => {
                ECGRenderer.destroyAll();
                Storage.save();
            });
            
            // Mark as active today
            AppState.user.lastActive = new Date().toISOString();
            Storage.save();
            
            console.log('✅ ECG Trainer Pro ready!');
        },

        // ========== SIDEBAR ==========
        updateSidebarStats() {
            const user = AppState.user;
            const accuracy = Utils.calcAccuracy(user.totalCorrect, user.totalAnswered);
            
            const streakEl = document.getElementById('sidebarStreak');
            const xpEl = document.getElementById('sidebarXP');
            const accEl = document.getElementById('sidebarAccuracy');
            const profileEl = document.getElementById('sidebarProfile');
            
            if (streakEl) streakEl.textContent = user.streak;
            if (xpEl) xpEl.textContent = user.xp;
            if (accEl) accEl.textContent = `${accuracy}%`;
            if (profileEl) profileEl.textContent = AppState.profile?.name || 'Standaard';
        },

        // ========== NAVIGATION ==========
        navigateTo(section) {
            Navigation.navigateTo(section);
        },

        // ========== QUIZ FUNCTIONS ==========
        startQuiz(mode = 'standard') {
            let difficulty = document.getElementById('quizDifficulty')?.value || 'all';
            let category = document.getElementById('quizCategory')?.value || 'all';
            let count = parseInt(document.getElementById('quizCount')?.value, 10) || AppState.settings?.defaultQuizCount || 10;

            if (mode === 'exam') {
                difficulty = 'all';
                category = 'all';
                count = 20;
            }
            
            QuizEngine.init({
                mode,
                difficulty,
                category,
                totalQuestions: count
            });
            
            // Re-render quiz section
            Sections.renderQuiz(Utils.$('#contentArea'));
        },

        startQuickQuiz() {
            QuizEngine.init({
                mode: 'standard',
                difficulty: 'all',
                category: 'all',
                totalQuestions: AppState.settings?.defaultQuizCount || 10
            });
            
            Navigation.navigateTo('quiz');
        },

        startModulePractice(moduleId) {
            const status = LearningPathEngine.getModuleStatus(moduleId);
            if (!status.unlocked) {
                this.showModal('🔒 Module nog vergrendeld', `
                    <div class="info-box warning">
                        <div class="info-box-icon">🧭</div>
                        <div class="info-box-content">
                            <p>Rond eerst eerdere modules af om deze te ontgrendelen.</p>
                        </div>
                    </div>
                `);
                return;
            }

            QuizEngine.init({
                mode: 'standard',
                difficulty: 'all',
                category: 'all',
                moduleId,
                totalQuestions: AppState.settings?.defaultQuizCount || 10
            });
            Navigation.navigateTo('quiz');
        },

        startCriticalQuiz() {
            // Focus on critical/high urgency rhythms
            AppState.quiz.category = 'critical';
            
            QuizEngine.init({
                mode: 'standard',
                difficulty: 'all',
                totalQuestions: 10
            });
            
            // Override to use critical rhythms only
            const criticalRhythms = ECGDatabase.getCriticalRhythms();
            AppState.quiz.currentRhythm = criticalRhythms[Math.floor(Math.random() * criticalRhythms.length)];
            
            Navigation.navigateTo('quiz');
        },

        openCategoryQuiz(category) {
            QuizEngine.init({
                mode: 'standard',
                difficulty: 'all',
                category,
                totalQuestions: 10
            });
            
            Navigation.navigateTo('quiz');
        },

        selectAnswer(rhythmId) {
            const quiz = AppState.quiz;
            if (quiz.showingFeedback) return;
            
            // Visual selection
            Utils.$$('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.rhythm === rhythmId) {
                    opt.classList.add('selected');
                }
            });
            
            // Check answer
            const result = QuizEngine.checkAnswer(rhythmId);
            if (!result) return;
            
            // Show feedback
            this.showAnswerFeedback(result);
        },

        showAnswerFeedback(result) {
            const { isCorrect, correctRhythm, xpEarned } = result;
            const quiz = AppState.quiz;
            const selectedRhythm = ECGDatabase.getRhythmById(quiz.selectedAnswer);
            
            // Update option styling
            Utils.$$('.quiz-option').forEach(opt => {
                opt.classList.add('disabled');
                
                if (opt.dataset.rhythm === correctRhythm.id) {
                    opt.classList.add('correct');
                } else if (opt.dataset.rhythm === quiz.selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });
            
            // Show feedback panel
            const feedbackPanel = document.getElementById('feedbackPanel');
            if (feedbackPanel) {
                feedbackPanel.className = `feedback-panel show ${isCorrect ? 'correct' : 'incorrect'}`;
                feedbackPanel.innerHTML = `
                    <div class="feedback-header">
                        <div class="feedback-icon">${isCorrect ? '✓' : '✗'}</div>
                        <div>
                            <div class="feedback-title">${isCorrect ? 'Correct!' : 'Helaas, niet juist'}</div>
                            <div class="feedback-subtitle">
                                ${isCorrect ? `+${xpEarned} XP verdiend` : `Het juiste antwoord was: ${correctRhythm.name}`}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">${correctRhythm.name}</h4>
                        <p class="text-muted" style="margin-bottom: 0.75rem;">${correctRhythm.description}</p>
                        <div class="info-box info" style="margin: 0;">
                            <div class="info-box-icon">💡</div>
                            <div class="info-box-content">
                                <h4>Belangrijke kenmerken</h4>
                                <ul class="styled-list" style="margin-top: 0.5rem;">
                                    ${correctRhythm.ecgFeatures.slice(0, 3).map(f => `<li>${f}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ${!isCorrect && selectedRhythm ? `
                            <div class="info-box warning" style="margin-top: 0.75rem;">
                                <div class="info-box-icon">🧭</div>
                                <div class="info-box-content">
                                    <h4>Context Card: verschil met je keuze</h4>
                                    <ul class="styled-list" style="margin-top: 0.5rem;">
                                        <li><strong>Jouw keuze:</strong> ${selectedRhythm.name}</li>
                                        <li><strong>Correct:</strong> ${correctRhythm.name}</li>
                                        <li><strong>Belangrijk verschil:</strong> ${(correctRhythm.ecgFeatures?.[0] || 'Let op ritme, QRS-breedte en P-golven')}</li>
                                        ${correctRhythm.urgency === 'critical' || correctRhythm.urgency === 'high'
                                            ? '<li><strong>Rode vlag:</strong> potentieel urgent/levensbedreigend patroon.</li>'
                                            : ''}
                                    </ul>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Show next button
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.classList.remove('hidden');
                
                // Update button text for last question
                if (quiz.currentQuestion >= quiz.totalQuestions - 1 || 
                    (quiz.mode === 'survival' && !isCorrect)) {
                    nextBtn.textContent = '📊 Bekijk Resultaten';
                }
            }
            
            // Update sidebar stats
            this.updateSidebarStats();
        },

        showTimeoutFeedback() {
            const quiz = AppState.quiz;
            const correctRhythm = quiz.currentRhythm;
            
            // Update option styling
            Utils.$$('.quiz-option').forEach(opt => {
                opt.classList.add('disabled');
                if (opt.dataset.rhythm === correctRhythm.id) {
                    opt.classList.add('correct');
                }
            });
            
            // Show feedback panel
            const feedbackPanel = document.getElementById('feedbackPanel');
            if (feedbackPanel) {
                feedbackPanel.className = 'feedback-panel show incorrect';
                feedbackPanel.innerHTML = `
                    <div class="feedback-header">
                        <div class="feedback-icon">⏱️</div>
                        <div>
                            <div class="feedback-title">Tijd is op!</div>
                            <div class="feedback-subtitle">Het juiste antwoord was: ${correctRhythm.name}</div>
                        </div>
                    </div>
                `;
            }
            
            // Show next button
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) nextBtn.classList.remove('hidden');
        },

        showHint() {
            if (AppState.quiz.mode === 'exam') {
                this.showModal('🧪 Examenmodus', `
                    <div class="info-box warning">
                        <div class="info-box-icon">📚</div>
                        <div class="info-box-content">
                            <p>Hints staan uit in Examenmodus.</p>
                        </div>
                    </div>
                `);
                return;
            }
            const hint = QuizEngine.getHint();
            if (!hint) return;
            
            this.showModal('💡 Hint', `
                <div class="info-box info">
                    <div class="info-box-icon">💡</div>
                    <div class="info-box-content">
                        <p style="font-size: 1.1rem;">${hint}</p>
                    </div>
                </div>
            `);
        },

        nextQuestion() {
            const hasMore = QuizEngine.nextQuestion();
            
            if (hasMore) {
                // Re-render quiz
                Sections.renderActiveQuiz(Utils.$('#contentArea'));
            }
            // If no more questions, QuizEngine.endQuiz() was called which triggers showQuizResults
        },

        startQuizTimer() {
            const quiz = AppState.quiz;
            
            if (quiz.timerInterval) {
                clearInterval(quiz.timerInterval);
            }
            
            quiz.timerInterval = setInterval(() => {
                QuizEngine.tick();
            }, 1000);
        },

        showQuizResults(results) {
            const { total, correct, accuracy, xpEarned, answers } = results;
            const isExam = AppState.quiz.mode === 'exam';
            
            let grade = '🥉';
            let gradeText = 'Goed geprobeerd!';
            if (accuracy >= 90) {
                grade = '🏆';
                gradeText = 'Uitstekend!';
            } else if (accuracy >= 80) {
                grade = '🥇';
                gradeText = 'Zeer goed!';
            } else if (accuracy >= 70) {
                grade = '🥈';
                gradeText = 'Goed gedaan!';
            }
            
            const content = Utils.$('#contentArea');
            const examDomainStats = isExam
                ? Object.entries(
                    answers.reduce((acc, ans) => {
                        const rhythm = ECGDatabase.getRhythmById(ans.rhythmId);
                        const key = rhythm?.category || 'overig';
                        if (!acc[key]) acc[key] = { total: 0, correct: 0 };
                        acc[key].total++;
                        if (ans.correct) acc[key].correct++;
                        return acc;
                    }, {})
                ).map(([cat, stat]) => ({
                    cat,
                    total: stat.total,
                    correct: stat.correct,
                    accuracy: stat.total > 0 ? Math.round((stat.correct / stat.total) * 100) : 0
                }))
                : [];

            content.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="score-display">
                            <div class="score-circle" style="--score: ${accuracy}">
                                <div class="score-inner">
                                    <div class="score-value">${accuracy}%</div>
                                    <div class="score-label">Nauwkeurigheid</div>
                                </div>
                            </div>
                            <h2 style="font-size: 1.75rem; margin-bottom: 0.5rem;">${grade} ${gradeText}</h2>
                            <p class="text-muted" style="margin-bottom: 1.5rem;">
                                Je hebt ${correct} van de ${total} vragen goed beantwoord
                            </p>
                            ${isExam ? '<p class="text-warning" style="margin-bottom: 1rem;">Examenmodus afgerond: hints uit, domeinrapport hieronder.</p>' : ''}
                            
                            <div class="vitals-grid" style="max-width: 400px; margin: 0 auto 2rem;">
                                <div class="vital-card">
                                    <div class="vital-card-label">Score</div>
                                    <div class="vital-card-value text-success">${correct}/${total}</div>
                                </div>
                                <div class="vital-card">
                                    <div class="vital-card-label">XP Verdiend</div>
                                    <div class="vital-card-value text-primary">+${xpEarned}</div>
                                </div>
                                <div class="vital-card">
                                    <div class="vital-card-label">Reeks</div>
                                    <div class="vital-card-value text-warning">${AppState.user.streak}🔥</div>
                                </div>
                            </div>
                            
                            <div class="btn-group" style="justify-content: center;">
                                <button class="btn btn-primary btn-lg" onclick="ECGApp.startQuickQuiz()">
                                    🔄 Nieuwe Quiz
                                </button>
                                <button class="btn btn-outline btn-lg" onclick="Navigation.navigateTo('dashboard')">
                                    🏠 Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                ${isExam ? `
                    <div class="card mt-2">
                        <div class="card-header">
                            <h3 class="card-title">🧪 Domeinrapport</h3>
                        </div>
                        <div class="card-body">
                            <table class="data-table">
                                <thead><tr><th>Domein</th><th>Score</th><th>Nauwkeurigheid</th></tr></thead>
                                <tbody>
                                    ${examDomainStats.map(d => `
                                        <tr>
                                            <td>${ECGDatabase.categories[d.cat]?.name || d.cat}</td>
                                            <td>${d.correct}/${d.total}</td>
                                            <td>${d.accuracy}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Answer Review -->
                <div class="card mt-2">
                    <div class="card-header">
                        <h3 class="card-title">📋 Antwoorden Overzicht</h3>
                    </div>
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ritme</th>
                                    <th>Jouw Antwoord</th>
                                    <th>Resultaat</th>
                                    <th>XP</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${answers.map((answer, index) => {
                                    const selectedRhythm = ECGDatabase.getRhythmById(answer.selectedId);
                                    return `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>
                                                <span style="cursor: pointer; text-decoration: underline;" 
                                                      onclick="ECGApp.showRhythmDetail('${answer.rhythmId}')">
                                                    ${answer.rhythmName}
                                                </span>
                                            </td>
                                            <td>${selectedRhythm ? selectedRhythm.name : 'Tijd op'}</td>
                                            <td>
                                                ${answer.correct 
                                                    ? '<span class="text-success">✓ Correct</span>' 
                                                    : '<span class="text-danger">✗ Fout</span>'}
                                            </td>
                                            <td class="text-primary">+${answer.xpEarned}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        },

        // ========== MONITOR FUNCTIONS ==========
        toggleMonitor() {
            const monitor = AppState.monitor;
            
            if (monitor.isRunning) {
                ECGRenderer.stop('monitorCanvas');
                monitor.isRunning = false;
            } else {
                ECGRenderer.start('monitorCanvas');
                monitor.isRunning = true;
            }
            
            // Update button
            const btn = document.getElementById('monitorToggle');
            if (btn) {
                btn.className = `btn btn-sm ${monitor.isRunning ? 'btn-danger' : 'btn-success'}`;
                btn.innerHTML = monitor.isRunning ? '⏸ Pauze' : '▶ Start';
            }
        },

        setMonitorRhythm(rhythmId) {
            const rhythm = ECGDatabase.getRhythmById(rhythmId);
            if (!rhythm) return;
            
            AppState.monitor.currentRhythm = rhythmId;
            
            // Update heart rate to typical for this rhythm
            if (rhythm.characteristics?.rate?.typical) {
                AppState.monitor.heartRate = rhythm.characteristics.rate.typical;
                const hrValue = document.getElementById('hrValue');
                if (hrValue) hrValue.textContent = AppState.monitor.heartRate;
                
                const hrInput = document.querySelector('input[type="range"]');
                if (hrInput) hrInput.value = AppState.monitor.heartRate;
            }
            
            // Update renderer
            ECGRenderer.setRhythm('monitorCanvas', rhythmId, AppState.monitor.heartRate);
            
            // Update display HR
            const monitorHR = document.getElementById('monitorHR');
            if (monitorHR) {
                monitorHR.textContent = AppState.monitor.heartRate;
                
                // Color code based on rate
                monitorHR.className = 'vital-value';
                if (AppState.monitor.heartRate > 150 || AppState.monitor.heartRate < 40) {
                    monitorHR.classList.add('critical');
                } else if (AppState.monitor.heartRate > 100) {
                    monitorHR.classList.add('yellow');
                } else if (AppState.monitor.heartRate < 60) {
                    monitorHR.classList.add('blue');
                } else {
                    monitorHR.classList.add('green');
                }
            }
            
            // Update active button
            Utils.$$('.rhythm-btn').forEach(btn => {
                btn.classList.toggle('active', btn.onclick.toString().includes(rhythmId));
            });
            
            // Re-render to update info panel
            Sections.renderMonitor(Utils.$('#contentArea'));
            
            // Restart if was running
            if (AppState.monitor.isRunning) {
                setTimeout(() => ECGRenderer.start('monitorCanvas'), 100);
            }
        },

        setMonitorHR(value) {
            AppState.monitor.heartRate = parseInt(value);
            
            const hrValue = document.getElementById('hrValue');
            if (hrValue) hrValue.textContent = value;
            
            const monitorHR = document.getElementById('monitorHR');
            if (monitorHR) monitorHR.textContent = value;
            
            // Update renderer
            const config = ECGRenderer.activeCanvases.get('monitorCanvas');
            if (config) {
                config.heartRate = AppState.monitor.heartRate;
            }
        },

        // ========== LIBRARY FUNCTIONS ==========
        searchLibrary(query) {
            AppState.library.searchQuery = query;
            Sections.renderLibrary(Utils.$('#contentArea'));
        },

        filterLibrary(category) {
            AppState.library.selectedCategory = category;
            AppState.library.searchQuery = ''; // Clear search
            Sections.renderLibrary(Utils.$('#contentArea'));
        },

        showRhythmDetail(rhythmId) {
            const rhythm = ECGDatabase.getRhythmById(rhythmId);
            if (!rhythm) return;
            
            const urgencyInfo = Utils.getUrgencyLabel(rhythm.urgency);
            const category = ECGDatabase.categories[rhythm.category];
            
            const content = `
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <span class="badge ${Utils.getDifficultyBadge(rhythm.difficulty)}">${rhythm.difficulty}</span>
                    <span class="badge badge-info">${category?.icon} ${category?.name}</span>
                    ${rhythm.urgency !== 'none' ? `<span class="badge ${rhythm.urgency === 'critical' ? 'badge-critical' : 'badge-hard'}">${urgencyInfo.text}</span>` : ''}
                </div>
                
                <p style="margin-bottom: 1.5rem; font-size: 1.05rem;">${rhythm.description}</p>
                
                <!-- ECG Strip -->
                <div class="ecg-monitor mb-3">
                    <div class="ecg-monitor-header">
                        <div class="ecg-monitor-title">ECG Voorbeeld</div>
                        <div class="vital-display">
                            <div class="vital-label">HR</div>
                            <div class="vital-value green">${rhythm.characteristics?.rate?.typical || '??'}</div>
                        </div>
                    </div>
                    <div class="ecg-canvas-wrapper">
                        <canvas id="detailECG" class="ecg-canvas" style="height: 150px;"></canvas>
                    </div>
                </div>
                
                <!-- Characteristics -->
                ${rhythm.characteristics ? `
                    <h4 style="margin-bottom: 0.75rem;">📊 Karakteristieken</h4>
                    <table class="data-table mb-3">
                        <tbody>
                            ${rhythm.characteristics.rate ? `
                                <tr>
                                    <td><strong>Frequentie</strong></td>
                                    <td>${rhythm.characteristics.rate.min}-${rhythm.characteristics.rate.max} bpm (typisch: ${rhythm.characteristics.rate.typical})</td>
                                </tr>
                            ` : ''}
                            ${rhythm.characteristics.rhythm ? `
                                <tr><td><strong>Ritme</strong></td><td>${rhythm.characteristics.rhythm}</td></tr>
                            ` : ''}
                            ${rhythm.characteristics.pWave ? `
                                <tr><td><strong>P-golf</strong></td><td>${rhythm.characteristics.pWave}</td></tr>
                            ` : ''}
                            ${rhythm.characteristics.prInterval ? `
                                <tr>
                                    <td><strong>PR-interval</strong></td>
                                    <td>${typeof rhythm.characteristics.prInterval === 'object' 
                                        ? `${rhythm.characteristics.prInterval.min}-${rhythm.characteristics.prInterval.max} ms` 
                                        : rhythm.characteristics.prInterval}</td>
                                </tr>
                            ` : ''}
                            ${rhythm.characteristics.qrsComplex ? `
                                <tr>
                                    <td><strong>QRS-complex</strong></td>
                                    <td>${typeof rhythm.characteristics.qrsComplex === 'object'
                                        ? `${rhythm.characteristics.qrsComplex.min || ''}-${rhythm.characteristics.qrsComplex.max || ''} ${rhythm.characteristics.qrsComplex.unit || 'ms'}`
                                        : rhythm.characteristics.qrsComplex}</td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                ` : ''}
                
                <!-- ECG Features -->
                <h4 style="margin-bottom: 0.75rem;">🔍 ECG Kenmerken</h4>
                <div class="info-box info mb-3">
                    <div class="info-box-icon">📋</div>
                    <div class="info-box-content">
                        <ul class="styled-list">
                            ${rhythm.ecgFeatures.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                <!-- Clinical Significance -->
                ${rhythm.clinicalSignificance ? `
                    <h4 style="margin-bottom: 0.75rem;">⚕️ Klinische Betekenis</h4>
                    <p style="margin-bottom: 1rem;">${rhythm.clinicalSignificance}</p>
                ` : ''}
                
                <!-- Causes -->
                ${rhythm.commonCauses ? `
                    <h4 style="margin-bottom: 0.75rem;">🔬 Oorzaken</h4>
                    <ul class="styled-list mb-3">
                        ${rhythm.commonCauses.map(c => `<li>${c}</li>`).join('')}
                    </ul>
                ` : ''}
                
                <!-- Treatment -->
                ${rhythm.treatment ? `
                    <h4 style="margin-bottom: 0.75rem;">💊 Behandeling</h4>
                    <div class="algorithm-box ${rhythm.urgency === 'critical' ? 'critical' : rhythm.urgency === 'high' ? 'warning' : 'success'}">
                        <p>${rhythm.treatment}</p>
                        ${rhythm.medications ? `
                            <div style="margin-top: 0.75rem;">
                                ${Object.entries(rhythm.medications).map(([key, meds]) => `
                                    <p><strong>${key}:</strong> ${Array.isArray(meds) ? meds.join(', ') : meds}</p>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <!-- Clinical Pearl -->
                ${rhythm.clinicalPearl ? `
                    <div class="info-box warning mt-3">
                        <div class="info-box-icon">💡</div>
                        <div class="info-box-content">
                            <h4>Klinische Parel</h4>
                            <p>${rhythm.clinicalPearl}</p>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Quiz Hints -->
                ${rhythm.quizHints ? `
                    <h4 style="margin: 1.5rem 0 0.75rem;">🎯 Herkenningspunten</h4>
                    <ul class="styled-list">
                        ${rhythm.quizHints.map(h => `<li>${h}</li>`).join('')}
                    </ul>
                ` : ''}
            `;
            
            this.showModal(`${Utils.getCategoryIcon(rhythm.category)} ${rhythm.name}`, content, [
                { text: 'Oefen dit ritme', class: 'btn-primary', action: () => {
                    this.closeModal();
                    this.practiceRhythm(rhythmId);
                }},
                { text: 'Sluiten', class: 'btn-outline', action: () => this.closeModal() }
            ]);
            
            // Draw ECG after modal is shown
            setTimeout(() => {
                const rate = rhythm.characteristics?.rate?.typical || 72;
                ECGRenderer.drawStaticStrip('detailECG', rhythmId, { heartRate: rate });
            }, 100);
        },

        practiceRhythm(rhythmId) {
            // Start a quiz focused on this rhythm's category
            const rhythm = ECGDatabase.getRhythmById(rhythmId);
            if (!rhythm) return;
            
            QuizEngine.init({
                mode: 'standard',
                difficulty: rhythm.difficulty,
                category: rhythm.category,
                totalQuestions: 5
            });
            
            // Make sure this rhythm appears first
            AppState.quiz.currentRhythm = rhythm;
            
            Navigation.navigateTo('quiz');
        },

        // ========== CLINICAL CASES ==========
        startDailyCase(caseId) {
            const daily = LearningPathEngine.getDailyRound();
            if (!daily.caseIds.includes(caseId)) {
                this.showModal('📅 Dagelijkse Ronde', `
                    <div class="info-box warning">
                        <div class="info-box-icon">⚠️</div>
                        <div class="info-box-content">
                            <p>Deze case zit niet in de dagelijkse ronde van vandaag.</p>
                        </div>
                    </div>
                `);
                return;
            }
            this.startCase(caseId);
        },

        startCase(caseId) {
            const caseData = ClinicalCases.getCaseById(caseId);
            if (!caseData) return;
            
            this.currentCase = {
                ...caseData,
                currentQuestion: 0,
                answers: []
            };
            
            this.showCaseQuestion();
        },

        showCaseQuestion() {
            const caseData = this.currentCase;
            if (!caseData) return;
            
            const question = caseData.questions[caseData.currentQuestion];
            const rhythm = ECGDatabase.getRhythmById(caseData.rhythm);
            
            const content = Utils.$('#contentArea');
            content.innerHTML = `
                <div class="emergency-banner" style="background: linear-gradient(90deg, var(--primary), var(--purple));">
                    <span>🏥</span>
                    <span>${caseData.title}</span>
                </div>
                
                <!-- Patient Info -->
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="case-header">
                            <div class="case-avatar">${caseData.patientIcon}</div>
                            <div class="case-info">
                                <h3>${caseData.patientInfo}</h3>
                                <p>${caseData.presentation}</p>
                            </div>
                        </div>
                        
                        <div class="vitals-grid mt-3">
                            <div class="vital-card">
                                <div class="vital-card-label">HR</div>
                                <div class="vital-card-value ${caseData.vitals.hr > 100 || caseData.vitals.hr < 50 ? 'text-danger' : 'text-success'}">${caseData.vitals.hr || '--'}</div>
                            </div>
                            <div class="vital-card">
                                <div class="vital-card-label">BP</div>
                                <div class="vital-card-value text-primary">${caseData.vitals.bp || '--'}</div>
                            </div>
                            <div class="vital-card">
                                <div class="vital-card-label">SpO2</div>
                                <div class="vital-card-value ${caseData.vitals.spo2 < 94 ? 'text-warning' : 'text-info'}">${caseData.vitals.spo2 || '--'}%</div>
                            </div>
                            <div class="vital-card">
                                <div class="vital-card-label">RR</div>
                                <div class="vital-card-value text-warning">${caseData.vitals.rr || '--'}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ECG Monitor -->
                <div class="ecg-monitor mb-2">
                    <div class="ecg-monitor-header">
                        <div class="ecg-monitor-title">
                            <span class="pulse">●</span>
                            Monitor
                        </div>
                    </div>
                    <div class="ecg-canvas-wrapper">
                        <canvas id="caseECG" class="ecg-canvas large"></canvas>
                        <div class="ecg-lead-label">II</div>
                    </div>
                </div>
                
                <!-- Question -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">❓ Vraag ${caseData.currentQuestion + 1} van ${caseData.questions.length}</h3>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 1.1rem; margin-bottom: 1.5rem;"><strong>${question.question}</strong></p>
                        
                        <div class="quiz-options" id="caseOptions">
                            ${question.options.map((opt, index) => `
                                <div class="quiz-option" data-index="${index}" onclick="ECGApp.selectCaseAnswer(${index})">
                                    <span class="quiz-option-key">${String.fromCharCode(65 + index)}</span>
                                    <div class="quiz-option-content">
                                        <div class="quiz-option-title">${opt}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="feedback-panel" id="caseFeedback"></div>
                        
                        <div class="btn-group mt-3" style="justify-content: space-between;">
                            <button class="btn btn-outline" onclick="Navigation.navigateTo('cases')">
                                ← Terug
                            </button>
                            <button class="btn btn-primary hidden" id="caseNextBtn" onclick="ECGApp.nextCaseQuestion()">
                                Volgende →
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Draw ECG
            setTimeout(() => {
                const rate = caseData.vitals.hr || 72;
                ECGRenderer.drawStaticStrip('caseECG', caseData.rhythm, { heartRate: rate });
            }, 100);
        },

        selectCaseAnswer(index) {
            const caseData = this.currentCase;
            if (!caseData) return;
            
            const question = caseData.questions[caseData.currentQuestion];
            const isCorrect = index === question.correct;
            
            // Visual feedback
            Utils.$$('#caseOptions .quiz-option').forEach((opt, i) => {
                opt.classList.add('disabled');
                if (i === question.correct) {
                    opt.classList.add('correct');
                } else if (i === index && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });
            
            // Show explanation
            const feedback = document.getElementById('caseFeedback');
            if (feedback) {
                feedback.className = `feedback-panel show ${isCorrect ? 'correct' : 'incorrect'}`;
                feedback.innerHTML = `
                    <div class="feedback-header">
                        <div class="feedback-icon">${isCorrect ? '✓' : '✗'}</div>
                        <div>
                            <div class="feedback-title">${isCorrect ? 'Correct!' : 'Niet juist'}</div>
                        </div>
                    </div>
                    <p style="margin-top: 1rem;">${question.explanation}</p>
                `;
            }
            
            // Record answer
            caseData.answers.push({
                questionIndex: caseData.currentQuestion,
                selected: index,
                correct: isCorrect
            });
            
            // Show next button
            const nextBtn = document.getElementById('caseNextBtn');
            if (nextBtn) {
                nextBtn.classList.remove('hidden');
                if (caseData.currentQuestion >= caseData.questions.length - 1) {
                    nextBtn.textContent = '📊 Bekijk Resultaten';
                }
            }
            
            // Update stats
            if (isCorrect) {
                AppState.user.totalCorrect++;
                AppState.user.xp += 25;
            }
            AppState.user.totalAnswered++;
            Storage.save();
            this.updateSidebarStats();
        },

        nextCaseQuestion() {
            const caseData = this.currentCase;
            if (!caseData) return;
            
            caseData.currentQuestion++;
            
            if (caseData.currentQuestion >= caseData.questions.length) {
                // Show case results
                this.showCaseResults();
            } else {
                this.showCaseQuestion();
            }
        },

        showCaseResults() {
            const caseData = this.currentCase;
            if (!caseData) return;
            
            const correct = caseData.answers.filter(a => a.correct).length;
            const total = caseData.answers.length;
            const accuracy = Math.round((correct / total) * 100);
            
            const content = Utils.$('#contentArea');
            content.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="score-display">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">
                                ${accuracy >= 80 ? '🏆' : accuracy >= 60 ? '👍' : '📚'}
                            </div>
                            <h2>Case Voltooid!</h2>
                            <p class="text-muted mb-3">${caseData.title}</p>
                            <div class="vitals-grid" style="max-width: 300px; margin: 0 auto 2rem;">
                                <div class="vital-card">
                                    <div class="vital-card-label">Score</div>
                                    <div class="vital-card-value text-success">${correct}/${total}</div>
                                </div>
                                <div class="vital-card">
                                    <div class="vital-card-label">Nauwkeurigheid</div>
                                    <div class="vital-card-value text-primary">${accuracy}%</div>
                                </div>
                            </div>
                            <div class="btn-group" style="justify-content: center;">
                                <button class="btn btn-primary" onclick="Navigation.navigateTo('cases')">
                                    📋 Meer Cases
                                </button>
                                <button class="btn btn-outline" onclick="Navigation.navigateTo('dashboard')">
                                    🏠 Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Clear current case
            if (caseData.id) {
                if (!AppState.learningPath.completedCases.includes(caseData.id)) {
                    AppState.learningPath.completedCases.push(caseData.id);
                }
                LearningPathEngine.completeDailyCase(caseData.id);
                LearningPathEngine.syncState();
                Storage.save();
            }
            this.currentCase = null;
        },

        // ========== TAB SWITCHING ==========
        switchACLSTab(tabId) {
            Utils.$$('.tab-content').forEach(tc => tc.classList.remove('active'));
            Utils.$$('.tab').forEach(t => t.classList.remove('active'));
            
            const tabContent = document.getElementById(`tab-${tabId}`);
            if (tabContent) tabContent.classList.add('active');
            
            // Find and activate the tab button
            Utils.$$('.tab').forEach(t => {
                if (t.textContent.toLowerCase().includes(tabId.substring(0, 5))) {
                    t.classList.add('active');
                }
            });
        },

        switchDrugTab(tabId) {
            Utils.$$('.tab-content').forEach(tc => tc.classList.remove('active'));
            Utils.$$('.tab').forEach(t => t.classList.remove('active'));
            
            const tabContent = document.getElementById(`tab-${tabId}`);
            if (tabContent) tabContent.classList.add('active');
            
            Utils.$$('.tab').forEach(t => {
                if (t.onclick && t.onclick.toString().includes(tabId)) {
                    t.classList.add('active');
                }
            });
        },

        switchCriteriaTab(tabId) {
            Utils.$$('.tab-content').forEach(tc => tc.classList.remove('active'));
            Utils.$$('.tab').forEach(t => t.classList.remove('active'));
            
            const tabContent = document.getElementById(`tab-${tabId}`);
            if (tabContent) tabContent.classList.add('active');
            
            Utils.$$('.tab').forEach(t => {
                if (t.onclick && t.onclick.toString().includes(tabId)) {
                    t.classList.add('active');
                }
            });
        },

        // ========== MODAL ==========
        showModal(title, content, buttons = null) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');
            
            if (modalTitle) modalTitle.textContent = title;
            if (modalBody) modalBody.innerHTML = content;
            
            if (modalFooter) {
                if (buttons) {
                    modalFooter.innerHTML = buttons.map(btn => 
                        `<button class="btn ${btn.class || 'btn-outline'}" onclick="${btn.action ? btn.action.toString().includes('=>') ? btn.action : `ECGApp.${btn.action}()` : 'ECGApp.closeModal()'}">${btn.text}</button>`
                    ).join('');
                    
                    // Re-bind click handlers for complex actions
                    buttons.forEach((btn, index) => {
                        if (btn.action && typeof btn.action === 'function') {
                            modalFooter.children[index].onclick = btn.action;
                        }
                    });
                } else {
                    modalFooter.innerHTML = '<button class="btn btn-outline" onclick="ECGApp.closeModal()">Sluiten</button>';
                }
            }
            
            if (modal) modal.classList.add('show');
        },

        closeModal() {
            const modal = document.getElementById('modal');
            if (modal) modal.classList.remove('show');
        },

        // ========== KEYBOARD SHORTCUTS ==========
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Don't trigger if typing in input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                const quiz = AppState.quiz;
                
                // Quiz answer shortcuts (A, B, C, D)
                if (quiz.active && !quiz.showingFeedback) {
                    const key = e.key.toUpperCase();
                    if (['A', 'B', 'C', 'D'].includes(key)) {
                        const index = key.charCodeAt(0) - 65;
                        const options = Utils.$$('.quiz-option');
                        if (options[index]) {
                            const rhythmId = options[index].dataset.rhythm;
                            if (rhythmId) this.selectAnswer(rhythmId);
                        }
                    }
                }
                
                // Enter/Space for next question
                if ((e.key === 'Enter' || e.key === ' ') && quiz.showingFeedback) {
                    e.preventDefault();
                    this.nextQuestion();
                }
                
                // Escape to close modal
                if (e.key === 'Escape') {
                    this.closeModal();
                }
                
                // Number keys for navigation (1-9)
                if (!quiz.active && e.key >= '1' && e.key <= '9') {
                    const sections = ['dashboard', 'monitor', 'learningPath', 'library', 'systematic', 'quiz', 'cases', 'acls', 'drugs'];
                    const index = parseInt(e.key) - 1;
                    if (sections[index]) {
                        Navigation.navigateTo(sections[index]);
                    }
                }
            });
        },

        // ========== UTILITY ==========
        startChecklistTraining() {
            AppState.learningPath.checklistTraining.activeSince = new Date().toISOString();
            Storage.save();
            if (AppState.currentSection === 'systematic') {
                Sections.renderSystematic(Utils.$('#contentArea'));
            }
        },

        completeChecklistTraining() {
            const checks = Array.from(document.querySelectorAll('.sys-checklist-step'));
            if (checks.length > 0 && checks.some(c => !c.checked)) {
                this.showModal('📝 Checklist niet compleet', `
                    <div class="info-box warning">
                        <div class="info-box-icon">⚠️</div>
                        <div class="info-box-content">
                            <p>Vink eerst alle checkliststappen aan.</p>
                        </div>
                    </div>
                `);
                return;
            }

            AppState.learningPath.checklistTraining.sessions += 1;
            AppState.learningPath.checklistTraining.lastCompleted = new Date().toISOString();
            AppState.learningPath.checklistTraining.activeSince = null;
            AppState.user.xp += 15;
            LearningPathEngine.syncState();
            Storage.save();
            this.updateSidebarStats();
            if (AppState.currentSection === 'systematic') {
                Sections.renderSystematic(Utils.$('#contentArea'));
            }
        },

        resetProgress() {
            if (confirm(`Weet je zeker dat je alle voortgang van profiel "${AppState.profile?.name || 'Standaard'}" wilt wissen? Dit kan niet ongedaan worden gemaakt.`)) {
                Storage.clear();
            }
        },

        createProfile() {
            const name = prompt('Naam voor nieuw profiel:');
            if (!name) return;
            try {
                Storage.createProfile(name);
                location.reload();
            } catch (error) {
                this.showModal('❌ Profiel aanmaken mislukt', `
                    <div class="info-box danger">
                        <div class="info-box-icon">⚠️</div>
                        <div class="info-box-content">
                            <p>${error.message}</p>
                        </div>
                    </div>
                `);
            }
        },

        switchProfile() {
            const profiles = Storage.listProfiles();
            if (!profiles.length) return;

            const list = profiles
                .map((p, i) => `${i + 1}. ${p.name}${p.id === AppState.profile.id ? ' (actief)' : ''}`)
                .join('\n');

            const input = prompt(`Kies profielnummer:\n\n${list}`, '1');
            if (!input) return;

            const index = parseInt(input, 10) - 1;
            if (isNaN(index) || index < 0 || index >= profiles.length) {
                this.showModal('⚠️ Ongeldige keuze', `
                    <div class="info-box warning">
                        <div class="info-box-icon">ℹ️</div>
                        <div class="info-box-content">
                            <p>Kies een geldig profielnummer.</p>
                        </div>
                    </div>
                `);
                return;
            }

            const target = profiles[index];
            if (target.id === AppState.profile.id) return;
            Storage.setActiveProfile(target.id);
            location.reload();
        },

        renameCurrentProfile() {
            const currentName = AppState.profile?.name || 'Standaard';
            const newName = prompt('Nieuwe profielnaam:', currentName);
            if (!newName || newName.trim() === currentName) return;

            try {
                Storage.renameActiveProfile(newName);
                Storage.save();
                this.updateSidebarStats();
                if (AppState.currentSection === 'settings') {
                    Sections.renderSettings(Utils.$('#contentArea'));
                }
            } catch (error) {
                this.showModal('❌ Hernoemen mislukt', `
                    <div class="info-box danger">
                        <div class="info-box-icon">⚠️</div>
                        <div class="info-box-content">
                            <p>${error.message}</p>
                        </div>
                    </div>
                `);
            }
        },

        deleteCurrentProfile() {
            const currentName = AppState.profile?.name || 'Standaard';
            if (!confirm(`Weet je zeker dat je profiel "${currentName}" wilt verwijderen?`)) return;

            try {
                Storage.deleteProfile(AppState.profile.id);
                location.reload();
            } catch (error) {
                this.showModal('❌ Verwijderen mislukt', `
                    <div class="info-box danger">
                        <div class="info-box-icon">⚠️</div>
                        <div class="info-box-content">
                            <p>${error.message}</p>
                        </div>
                    </div>
                `);
            }
        }
    };

    // ==================== DEEL 5 GAAT HIER VERDER ====================

    // ==================== ACHIEVEMENTS SYSTEM ====================
    const Achievements = {
        definitions: [
            // Learning milestones
            {
                id: 'first_quiz',
                name: 'Eerste Stappen',
                description: 'Voltooi je eerste quiz',
                icon: '🎯',
                category: 'learning',
                condition: (user) => user.quizHistory.length >= 1,
                xpReward: 50
            },
            {
                id: 'quiz_master_10',
                name: 'Quiz Veteraan',
                description: 'Voltooi 10 quizzen',
                icon: '📝',
                category: 'learning',
                condition: (user) => user.quizHistory.length >= 10,
                xpReward: 100
            },
            {
                id: 'quiz_master_50',
                name: 'Quiz Meester',
                description: 'Voltooi 50 quizzen',
                icon: '🏅',
                category: 'learning',
                condition: (user) => user.quizHistory.length >= 50,
                xpReward: 250
            },
            {
                id: 'perfect_quiz',
                name: 'Perfect!',
                description: 'Behaal 100% op een quiz',
                icon: '💯',
                category: 'learning',
                condition: (user) => user.quizHistory.some(q => q.accuracy === 100 && q.total >= 5),
                xpReward: 75
            },
            
            // Streak achievements
            {
                id: 'streak_3',
                name: 'Op Dreef',
                description: 'Behaal een reeks van 3',
                icon: '🔥',
                category: 'streak',
                condition: (user) => user.streak >= 3,
                xpReward: 25
            },
            {
                id: 'streak_10',
                name: 'Onstopbaar',
                description: 'Behaal een reeks van 10',
                icon: '🔥🔥',
                category: 'streak',
                condition: (user) => user.streak >= 10,
                xpReward: 75
            },
            {
                id: 'streak_25',
                name: 'Legendarisch',
                description: 'Behaal een reeks van 25',
                icon: '🔥🔥🔥',
                category: 'streak',
                condition: (user) => user.streak >= 25,
                xpReward: 200
            },
            
            // Mastery achievements
            {
                id: 'master_5',
                name: 'Ritme Kenner',
                description: 'Beheers 5 ritmes',
                icon: '⭐',
                category: 'mastery',
                condition: (user) => user.masteredRhythms.length >= 5,
                xpReward: 100
            },
            {
                id: 'master_15',
                name: 'Ritme Expert',
                description: 'Beheers 15 ritmes',
                icon: '🌟',
                category: 'mastery',
                condition: (user) => user.masteredRhythms.length >= 15,
                xpReward: 250
            },
            {
                id: 'master_all',
                name: 'ECG Meester',
                description: 'Beheers alle ritmes',
                icon: '👑',
                category: 'mastery',
                condition: (user) => user.masteredRhythms.length >= ECGDatabase.getAllRhythms().length,
                xpReward: 1000
            },
            
            // Category specialists
            {
                id: 'sinus_expert',
                name: 'Sinus Specialist',
                description: 'Beheers alle sinusritmes',
                icon: '💗',
                category: 'specialist',
                condition: (user) => {
                    const sinusRhythms = ECGDatabase.getRhythmsByCategory('sinus').map(r => r.id);
                    return sinusRhythms.every(id => user.masteredRhythms.includes(id));
                },
                xpReward: 150
            },
            {
                id: 'block_expert',
                name: 'Blok Specialist',
                description: 'Beheers alle AV-blokken',
                icon: '🚧',
                category: 'specialist',
                condition: (user) => {
                    const blockRhythms = ECGDatabase.getRhythmsByCategory('blocks').map(r => r.id);
                    return blockRhythms.every(id => user.masteredRhythms.includes(id));
                },
                xpReward: 200
            },
            {
                id: 'emergency_expert',
                name: 'Spoed Expert',
                description: 'Beheers alle kritieke ritmes',
                icon: '🚨',
                category: 'specialist',
                condition: (user) => {
                    const criticalRhythms = ECGDatabase.getCriticalRhythms().map(r => r.id);
                    return criticalRhythms.every(id => user.masteredRhythms.includes(id));
                },
                xpReward: 300
            },
            
            // XP milestones
            {
                id: 'xp_500',
                name: 'Beginner',
                description: 'Verdien 500 XP',
                icon: '📈',
                category: 'xp',
                condition: (user) => user.xp >= 500,
                xpReward: 50
            },
            {
                id: 'xp_2000',
                name: 'Gevorderde',
                description: 'Verdien 2000 XP',
                icon: '📊',
                category: 'xp',
                condition: (user) => user.xp >= 2000,
                xpReward: 100
            },
            {
                id: 'xp_5000',
                name: 'Expert',
                description: 'Verdien 5000 XP',
                icon: '🏆',
                category: 'xp',
                condition: (user) => user.xp >= 5000,
                xpReward: 250
            },
            {
                id: 'xp_10000',
                name: 'Grootmeester',
                description: 'Verdien 10000 XP',
                icon: '👑',
                category: 'xp',
                condition: (user) => user.xp >= 10000,
                xpReward: 500
            },
            
            // Special achievements
            {
                id: 'speed_demon',
                name: 'Snelheidsduivel',
                description: 'Beantwoord 5 vragen binnen 10 seconden elk',
                icon: '⚡',
                category: 'special',
                condition: (user) => {
                    const recentAnswers = user.quizHistory
                        .flatMap(q => q.answers || [])
                        .filter(a => a.timeSpent && a.timeSpent < 10 && a.correct);
                    return recentAnswers.length >= 5;
                },
                xpReward: 100
            },
            {
                id: 'night_owl',
                name: 'Nachtuil',
                description: 'Oefen na middernacht',
                icon: '🦉',
                category: 'special',
                condition: () => {
                    const hour = new Date().getHours();
                    return hour >= 0 && hour < 5;
                },
                xpReward: 25
            },
            {
                id: 'survivor',
                name: 'Overlever',
                description: 'Behaal 15+ correcte antwoorden in survivalmodus',
                icon: '💀',
                category: 'special',
                condition: (user) => {
                    return user.quizHistory.some(q => q.mode === 'survival' && q.correct >= 15);
                },
                xpReward: 200
            }
        ],

        // Check and award new achievements
        checkAchievements() {
            const user = AppState.user;
            const newAchievements = [];

            this.definitions.forEach(achievement => {
                if (!user.achievements.includes(achievement.id)) {
                    try {
                        if (achievement.condition(user)) {
                            user.achievements.push(achievement.id);
                            user.xp += achievement.xpReward;
                            newAchievements.push(achievement);
                        }
                    } catch (e) {
                        console.warn(`Error checking achievement ${achievement.id}:`, e);
                    }
                }
            });

            if (newAchievements.length > 0) {
                Storage.save();
                this.showAchievementNotification(newAchievements);
            }

            return newAchievements;
        },

        // Show achievement notification
        showAchievementNotification(achievements) {
            achievements.forEach((achievement, index) => {
                setTimeout(() => {
                    const notification = document.createElement('div');
                    notification.className = 'achievement-notification';
                    notification.innerHTML = `
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-content">
                            <div class="achievement-title">🎉 Achievement Unlocked!</div>
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-desc">${achievement.description}</div>
                            <div class="achievement-reward">+${achievement.xpReward} XP</div>
                        </div>
                    `;
                    document.body.appendChild(notification);

                    // Animate in
                    setTimeout(() => notification.classList.add('show'), 10);

                    // Remove after delay
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }, 4000);
                }, index * 1000);
            });
        },

        // Get all achievements with status
        getAllWithStatus() {
            const user = AppState.user;
            return this.definitions.map(achievement => ({
                ...achievement,
                unlocked: user.achievements.includes(achievement.id)
            }));
        },

        // Get unlocked achievements
        getUnlocked() {
            return this.getAllWithStatus().filter(a => a.unlocked);
        },

        // Get locked achievements
        getLocked() {
            return this.getAllWithStatus().filter(a => !a.unlocked);
        },

        // Get achievement by ID
        getById(id) {
            return this.definitions.find(a => a.id === id);
        }
    };

    // ==================== PROGRESS & STATISTICS ====================
    const ProgressTracker = {
        // Get detailed statistics
        getStatistics() {
            const user = AppState.user;
            const history = user.quizHistory;

            // Basic stats
            const totalQuizzes = history.length;
            const totalAnswered = user.totalAnswered;
            const totalCorrect = user.totalCorrect;
            const accuracy = Utils.calcAccuracy(totalCorrect, totalAnswered);

            // Category breakdown
            const categoryStats = {};
            Object.keys(ECGDatabase.categories).forEach(catId => {
                categoryStats[catId] = { correct: 0, total: 0 };
            });

            history.forEach(quiz => {
                if (quiz.answers) {
                    quiz.answers.forEach(answer => {
                        const rhythm = ECGDatabase.getRhythmById(answer.rhythmId);
                        if (rhythm && categoryStats[rhythm.category]) {
                            categoryStats[rhythm.category].total++;
                            if (answer.correct) {
                                categoryStats[rhythm.category].correct++;
                            }
                        }
                    });
                }
            });

            // Difficulty breakdown
            const difficultyStats = { easy: { correct: 0, total: 0 }, medium: { correct: 0, total: 0 }, hard: { correct: 0, total: 0 } };
            history.forEach(quiz => {
                if (quiz.answers) {
                    quiz.answers.forEach(answer => {
                        const rhythm = ECGDatabase.getRhythmById(answer.rhythmId);
                        if (rhythm && difficultyStats[rhythm.difficulty]) {
                            difficultyStats[rhythm.difficulty].total++;
                            if (answer.correct) {
                                difficultyStats[rhythm.difficulty].correct++;
                            }
                        }
                    });
                }
            });

            // Time-based stats
            const lastWeek = history.filter(q => {
                const quizDate = new Date(q.date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return quizDate > weekAgo;
            });

            // Average accuracy trend
            const recentAccuracy = lastWeek.length > 0
                ? Math.round(lastWeek.reduce((sum, q) => sum + q.accuracy, 0) / lastWeek.length)
                : 0;

            return {
                totalQuizzes,
                totalAnswered,
                totalCorrect,
                accuracy,
                xp: user.xp,
                level: Utils.calculateLevel(user.xp),
                streak: user.streak,
                masteredRhythms: user.masteredRhythms.length,
                totalRhythms: ECGDatabase.getAllRhythms().length,
                achievements: user.achievements.length,
                totalAchievements: Achievements.definitions.length,
                categoryStats,
                difficultyStats,
                quizzesThisWeek: lastWeek.length,
                recentAccuracy,
                bestStreak: Math.max(user.streak, ...history.map(q => q.correct || 0))
            };
        },

        // Get rhythm-specific progress
        getRhythmProgress() {
            const rhythms = ECGDatabase.getAllRhythms();
            const user = AppState.user;
            const history = user.quizHistory;

            const rhythmStats = {};

            // Initialize
            rhythms.forEach(r => {
                rhythmStats[r.id] = {
                    rhythm: r,
                    attempts: 0,
                    correct: 0,
                    mastered: user.masteredRhythms.includes(r.id)
                };
            });

            // Aggregate from history
            history.forEach(quiz => {
                if (quiz.answers) {
                    quiz.answers.forEach(answer => {
                        if (rhythmStats[answer.rhythmId]) {
                            rhythmStats[answer.rhythmId].attempts++;
                            if (answer.correct) {
                                rhythmStats[answer.rhythmId].correct++;
                            }
                        }
                    });
                }
            });

            return Object.values(rhythmStats).map(stat => ({
                ...stat,
                accuracy: stat.attempts > 0 ? Math.round((stat.correct / stat.attempts) * 100) : 0
            }));
        },

        // Get weak areas (rhythms with low accuracy)
        getWeakAreas() {
            const progress = this.getRhythmProgress();
            return progress
                .filter(p => p.attempts >= 2 && p.accuracy < 70)
                .sort((a, b) => a.accuracy - b.accuracy)
                .slice(0, 5);
        },

        // Get strong areas
        getStrongAreas() {
            const progress = this.getRhythmProgress();
            return progress
                .filter(p => p.attempts >= 3 && p.accuracy >= 80)
                .sort((a, b) => b.accuracy - a.accuracy)
                .slice(0, 5);
        }
    };

    // ==================== LEARNING PATH ENGINE ====================
    const LearningPathEngine = {
        moduleDefinitions: [
            {
                id: 'module_1',
                icon: '🧱',
                title: 'Module 1: Fundamenten',
                description: 'Kalibratie, frequentie, ritmeregelmaat en assen.',
                categories: ['normal', 'bradycardia'],
                requiredQuestions: 8,
                requiredAccuracy: 80
            },
            {
                id: 'module_2',
                icon: '📋',
                title: 'Module 2: Systematische Analyse',
                description: 'Vast 8-10 stappenmodel + checklist training.',
                categories: ['normal', 'bradycardia', 'tachycardia'],
                requiredQuestions: 10,
                requiredAccuracy: 80,
                requiredChecklistSessions: 1
            },
            {
                id: 'module_3',
                icon: '💓',
                title: 'Module 3: Supraventriculaire Ritmes',
                description: 'Sinusvarianten, AF/AFL/SVT en eerste behandeling.',
                categories: ['atrial', 'tachycardia'],
                requiredQuestions: 12,
                requiredAccuracy: 80
            },
            {
                id: 'module_4',
                icon: '🚧',
                title: 'Module 4: Geleiding',
                description: 'AV-blokken, RBBB/LBBB en fasciculaire patronen.',
                categories: ['blocks'],
                requiredQuestions: 12,
                requiredAccuracy: 80
            },
            {
                id: 'module_5',
                icon: '⚡',
                title: 'Module 5: Ventriculaire & Arrest',
                description: 'VT/VF/asystolie/PEA en ACLS-kernacties.',
                categories: ['ventricular'],
                rhythmIds: ['asystole', 'pea'],
                requiredQuestions: 12,
                requiredAccuracy: 80
            },
            {
                id: 'module_6',
                icon: '🔥',
                title: 'Module 6: Ischemie & Equivalenten',
                description: 'STEMI/NSTEMI, Wellens, de Winter, posterior.',
                categories: ['ischemia'],
                requiredQuestions: 12,
                requiredAccuracy: 80
            },
            {
                id: 'module_7',
                icon: '🧪',
                title: 'Module 7: Elektrolyten & Toxiciteit',
                description: 'K/Calcium, QT, digoxine, pacingproblemen.',
                rhythmIds: ['hyperkalemia', 'hypokalemia', 'hypercalcemia', 'hypocalcemia', 'long_qt', 'digoxin_toxicity', 'pacemaker_malfunction'],
                requiredQuestions: 10,
                requiredAccuracy: 80
            },
            {
                id: 'module_8',
                icon: '🩺',
                title: 'Module 8: Integratie',
                description: 'Klinische cases met prioritering en tijdsdruk.',
                allRhythms: true,
                caseIds: ['case_chest_pain', 'case_syncope', 'case_palpitations', 'case_resuscitation', 'case_potassium', 'case_af_rvr'],
                requiredQuestions: 15,
                requiredAccuracy: 80,
                requiredCases: 4
            }
        ],

        getModuleById(moduleId) {
            return this.moduleDefinitions.find(m => m.id === moduleId) || null;
        },

        getModuleRhythms(moduleId) {
            const module = this.getModuleById(moduleId);
            if (!module) return ECGDatabase.getAllRhythms();
            if (module.allRhythms) return ECGDatabase.getAllRhythms();

            let rhythms = [];
            if (Array.isArray(module.categories)) {
                module.categories.forEach(cat => {
                    rhythms = rhythms.concat(ECGDatabase.getRhythmsByCategory(cat));
                });
            }
            if (Array.isArray(module.rhythmIds)) {
                module.rhythmIds.forEach(id => {
                    const rhythm = ECGDatabase.getRhythmById(id);
                    if (rhythm) rhythms.push(rhythm);
                });
            }

            const unique = [];
            const seen = new Set();
            rhythms.forEach(r => {
                if (!seen.has(r.id)) {
                    seen.add(r.id);
                    unique.push(r);
                }
            });
            return unique;
        },

        getModuleQuestionStats(moduleId) {
            const rhythmIds = new Set(this.getModuleRhythms(moduleId).map(r => r.id));
            let total = 0;
            let correct = 0;

            AppState.user.quizHistory.forEach(quiz => {
                if (!quiz.answers) return;
                quiz.answers.forEach(answer => {
                    if (rhythmIds.has(answer.rhythmId)) {
                        total++;
                        if (answer.correct) correct++;
                    }
                });
            });

            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            return { total, correct, accuracy };
        },

        getModuleCaseProgress(moduleId) {
            const module = this.getModuleById(moduleId);
            const requiredCases = module?.requiredCases || 0;
            const pool = module?.caseIds || [];
            const completed = new Set(AppState.learningPath.completedCases || []);
            const done = pool.filter(id => completed.has(id)).length;
            return { requiredCases, done, totalPool: pool.length };
        },

        calculateStatuses() {
            const statuses = {};
            const checklistSessions = AppState.learningPath.checklistTraining?.sessions || 0;

            this.moduleDefinitions.forEach((module, index) => {
                let unlocked = false;
                if (index === 0) {
                    unlocked = true;
                } else if (index <= 3) {
                    const prev = this.moduleDefinitions[index - 1];
                    unlocked = !!statuses[prev.id]?.completed;
                } else {
                    unlocked = !!statuses['module_4']?.completed;
                }

                const q = this.getModuleQuestionStats(module.id);
                const c = this.getModuleCaseProgress(module.id);
                const qMet = q.total >= module.requiredQuestions && q.accuracy >= module.requiredAccuracy;
                const cMet = !module.requiredCases || c.done >= module.requiredCases;
                const sMet = !module.requiredChecklistSessions || checklistSessions >= module.requiredChecklistSessions;
                const completed = unlocked && qMet && cMet && sMet;

                statuses[module.id] = {
                    ...module,
                    unlocked,
                    completed,
                    questionStats: q,
                    caseStats: c,
                    checklistSessions,
                    requirementsMet: { qMet, cMet, sMet }
                };
            });

            return statuses;
        },

        syncState() {
            const statuses = this.calculateStatuses();
            const completedModules = this.moduleDefinitions
                .filter(m => statuses[m.id]?.completed)
                .map(m => m.id);

            AppState.learningPath.completedModules = completedModules;
            const nextModule = this.moduleDefinitions.find(m => statuses[m.id].unlocked && !statuses[m.id].completed);
            AppState.learningPath.currentModule = nextModule?.id || this.moduleDefinitions[this.moduleDefinitions.length - 1].id;
            AppState.learningPath.weeklyFocus = this.getWeeklyFocus();
            this.ensureDailyRound();
            return statuses;
        },

        getModuleStatus(moduleId) {
            return this.calculateStatuses()[moduleId];
        },

        getCurrentModule() {
            return this.getModuleById(AppState.learningPath.currentModule);
        },

        hashString(input) {
            let hash = 0;
            for (let i = 0; i < input.length; i++) {
                hash = ((hash << 5) - hash) + input.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        },

        ensureDailyRound() {
            const today = new Date().toISOString().slice(0, 10);
            const state = AppState.learningPath.dailyRoundState || {};
            const allCases = ClinicalCases.getAllCases().map(c => c.id);

            if (state.date !== today || !Array.isArray(state.caseIds) || state.caseIds.length === 0) {
                const scored = allCases
                    .map(id => ({ id, score: this.hashString(`${today}:${id}`) }))
                    .sort((a, b) => a.score - b.score)
                    .slice(0, Math.min(3, allCases.length))
                    .map(x => x.id);

                AppState.learningPath.dailyRoundState = {
                    date: today,
                    caseIds: scored,
                    completedCaseIds: []
                };
            }

            return AppState.learningPath.dailyRoundState;
        },

        completeDailyCase(caseId) {
            const state = this.ensureDailyRound();
            if (!state.caseIds.includes(caseId)) return;
            if (!state.completedCaseIds.includes(caseId)) {
                state.completedCaseIds.push(caseId);
            }
        },

        getDailyRound() {
            return this.ensureDailyRound();
        },

        getWeeklyFocus() {
            const weak = ProgressTracker.getWeakAreas().slice(0, 3).map(item => ({
                id: item.rhythm.id,
                name: item.rhythm.name,
                accuracy: item.accuracy
            }));

            if (weak.length > 0) return weak;

            const current = this.getCurrentModule();
            return this.getModuleRhythms(current?.id || 'module_1')
                .slice(0, 3)
                .map(r => ({ id: r.id, name: r.name, accuracy: 0 }));
        },

        getChecklistElapsedMinutes() {
            const activeSince = AppState.learningPath.checklistTraining?.activeSince;
            if (!activeSince) return 0;
            const diffMs = Date.now() - new Date(activeSince).getTime();
            return Math.max(0, Math.floor(diffMs / 60000));
        },

        getOverallProgress() {
            const done = AppState.learningPath.completedModules.length;
            const total = this.moduleDefinitions.length;
            return total > 0 ? Math.round((done / total) * 100) : 0;
        }
    };

    // ==================== ADDITIONAL SECTION RENDERERS ====================
    
    // Add to Sections object
    Sections.renderLearningPath = function(container) {
        const statuses = LearningPathEngine.syncState();
        const progress = LearningPathEngine.getOverallProgress();
        const daily = LearningPathEngine.getDailyRound();
        const focus = LearningPathEngine.getWeeklyFocus();
        const current = LearningPathEngine.getCurrentModule();

        container.innerHTML = `
            <div class="card mb-2">
                <div class="card-header">
                    <h3 class="card-title">🧭 Leerpad (Hybride)</h3>
                </div>
                <div class="card-body">
                    <div class="info-box info mb-2">
                        <div class="info-box-icon">🧪</div>
                        <div class="info-box-content">
                            <h4>Richtlijnmodus: ERC/ESC standaard</h4>
                            <p>Educatieve omgeving. Volg altijd lokale protocollen en supervisie.</p>
                        </div>
                    </div>
                    <p class="text-muted">Huidige focus: <strong>${current?.title || 'Module 1'}</strong></p>
                    <div class="progress-bar mt-1 mb-1">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <p class="text-muted" style="font-size: 0.85rem;">${progress}% voltooid • ${AppState.learningPath.completedModules.length}/${LearningPathEngine.moduleDefinitions.length} modules afgerond</p>
                </div>
            </div>

            <div class="grid-2">
                ${LearningPathEngine.moduleDefinitions.map(module => {
                    const s = statuses[module.id];
                    const badge = s.completed ? '<span class="badge badge-success">Voltooid</span>' : s.unlocked ? '<span class="badge badge-info">Open</span>' : '<span class="badge badge-hard">Vergrendeld</span>';
                    return `
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">${module.icon} ${module.title}</h3>
                                ${badge}
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-2">${module.description}</p>
                                <p style="font-size: 0.85rem;">
                                    Quiz: ${s.questionStats.correct}/${s.questionStats.total} correct (${s.questionStats.accuracy}%) • Doel: ${module.requiredQuestions} vragen op ${module.requiredAccuracy}%+
                                </p>
                                ${module.requiredChecklistSessions ? `<p style="font-size: 0.85rem;">Checklist sessies: ${s.checklistSessions}/${module.requiredChecklistSessions}</p>` : ''}
                                ${module.requiredCases ? `<p style="font-size: 0.85rem;">Cases: ${s.caseStats.done}/${module.requiredCases}</p>` : ''}
                                <button class="btn btn-sm ${s.unlocked ? 'btn-primary' : 'btn-outline'} mt-1" ${s.unlocked ? `onclick="ECGApp.startModulePractice('${module.id}')"` : 'disabled'}>
                                    ${s.completed ? 'Herhalen' : 'Oefen module'}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>

            <div class="card mt-2">
                <div class="card-header">
                    <h3 class="card-title">🏥 Dagelijkse Klinische Ronde</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">Vandaag voltooid: <strong>${daily.completedCaseIds.length}/${daily.caseIds.length}</strong></p>
                    <div class="btn-group mt-1">
                        ${daily.caseIds.map(caseId => {
                            const c = ClinicalCases.getCaseById(caseId);
                            if (!c) return '';
                            const done = daily.completedCaseIds.includes(caseId);
                            return `<button class="btn btn-sm ${done ? 'btn-success' : 'btn-outline'}" onclick="ECGApp.startDailyCase('${caseId}')">${done ? '✓' : '•'} ${c.title}</button>`;
                        }).join('')}
                    </div>
                </div>
            </div>

            <div class="grid-2 mt-2">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">🎯 Focus van de week</h3></div>
                    <div class="card-body">
                        <ul class="styled-list">
                            ${focus.map(f => `<li>${f.name} ${f.accuracy > 0 ? `(${f.accuracy}%)` : '(nieuw)'}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">🧪 Examenmodus</h3></div>
                    <div class="card-body">
                        <p class="text-muted">20 vragen, geen hints, eindrapport per domein.</p>
                        <button class="btn btn-primary" onclick="ECGApp.startQuiz('exam')">Start Examenmodus</button>
                    </div>
                </div>
            </div>
        `;
    };

    Sections.renderProgress = function(container) {
        const stats = ProgressTracker.getStatistics();
        const weakAreas = ProgressTracker.getWeakAreas();
        const strongAreas = ProgressTracker.getStrongAreas();

        container.innerHTML = `
            <div class="card mb-2">
                <div class="card-header">
                    <h3 class="card-title">📊 Voortgang Overzicht</h3>
                </div>
                <div class="card-body">
                    <!-- Level Progress -->
                    <div class="score-display" style="margin-bottom: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 0.5rem;">
                            ${stats.level.level <= 5 ? '🌱' : stats.level.level <= 10 ? '🌿' : stats.level.level <= 20 ? '🌳' : '🏆'}
                        </div>
                        <h2>Niveau ${stats.level.level}</h2>
                        <p class="text-muted">${stats.xp} totaal XP</p>
                        <div class="progress-bar" style="max-width: 300px; margin: 1rem auto;">
                            <div class="progress-fill" style="width: ${(stats.level.currentXP / stats.level.nextLevelXP) * 100}%"></div>
                        </div>
                        <p class="text-muted" style="font-size: 0.85rem;">
                            ${stats.level.currentXP} / ${stats.level.nextLevelXP} XP naar niveau ${stats.level.level + 1}
                        </p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="vitals-grid">
                        <div class="vital-card">
                            <div class="vital-card-label">Quizzen</div>
                            <div class="vital-card-value text-primary">${stats.totalQuizzes}</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-card-label">Vragen</div>
                            <div class="vital-card-value text-info">${stats.totalAnswered}</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-card-label">Correct</div>
                            <div class="vital-card-value text-success">${stats.totalCorrect}</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-card-label">Nauwkeurigheid</div>
                            <div class="vital-card-value ${stats.accuracy >= 80 ? 'text-success' : stats.accuracy >= 60 ? 'text-warning' : 'text-danger'}">${stats.accuracy}%</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-card-label">Reeks</div>
                            <div class="vital-card-value text-warning">${stats.streak}🔥</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-card-label">Beheerst</div>
                            <div class="vital-card-value text-primary">${stats.masteredRhythms}/${stats.totalRhythms}</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-card-label">Prestaties</div>
                            <div class="vital-card-value text-info">${stats.achievements}/${stats.totalAchievements}</div>
                        </div>
                        <div class="vital-card">
                            <div class="vital-card-label">Deze Week</div>
                            <div class="vital-card-value text-success">${stats.quizzesThisWeek} quizzen</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Category Performance -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📂 Prestatie per Categorie</h3>
                    </div>
                    <div class="card-body">
                        ${Object.entries(stats.categoryStats).map(([catId, catStats]) => {
                            const category = ECGDatabase.categories[catId];
                            const accuracy = catStats.total > 0 ? Math.round((catStats.correct / catStats.total) * 100) : 0;
                            return `
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                        <span>${category?.icon || ''} ${category?.name || catId}</span>
                                        <span class="${accuracy >= 80 ? 'text-success' : accuracy >= 60 ? 'text-warning' : 'text-danger'}">
                                            ${accuracy}% (${catStats.correct}/${catStats.total})
                                        </span>
                                    </div>
                                    <div class="progress-bar" style="height: 8px;">
                                        <div class="progress-fill ${accuracy >= 80 ? '' : accuracy >= 60 ? 'warning' : 'danger'}" style="width: ${accuracy}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- Difficulty Performance -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📈 Prestatie per Moeilijkheid</h3>
                    </div>
                    <div class="card-body">
                        ${Object.entries(stats.difficultyStats).map(([diff, diffStats]) => {
                            const accuracy = diffStats.total > 0 ? Math.round((diffStats.correct / diffStats.total) * 100) : 0;
                            const labels = { easy: 'Makkelijk', medium: 'Gemiddeld', hard: 'Moeilijk' };
                            return `
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                        <span class="badge ${Utils.getDifficultyBadge(diff)}">${labels[diff]}</span>
                                        <span>${accuracy}% (${diffStats.correct}/${diffStats.total})</span>
                                    </div>
                                    <div class="progress-bar" style="height: 8px;">
                                        <div class="progress-fill" style="width: ${accuracy}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}

                        ${weakAreas.length > 0 ? `
                            <div class="info-box warning mt-3">
                                <div class="info-box-icon">📚</div>
                                <div class="info-box-content">
                                    <h4>Aandachtspunten</h4>
                                    <p>Deze ritmes verdienen extra oefening:</p>
                                    <ul class="styled-list" style="margin-top: 0.5rem;">
                                        ${weakAreas.map(w => `<li>${w.rhythm.name} (${w.accuracy}%)</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        ` : ''}

                        ${strongAreas.length > 0 ? `
                            <div class="info-box success mt-3">
                                <div class="info-box-icon">⭐</div>
                                <div class="info-box-content">
                                    <h4>Sterke Punten</h4>
                                    <ul class="styled-list" style="margin-top: 0.5rem;">
                                        ${strongAreas.slice(0, 3).map(s => `<li>${s.rhythm.name} (${s.accuracy}%)</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>

            <!-- Mastered Rhythms -->
            <div class="card mt-2">
                <div class="card-header">
                    <h3 class="card-title">🏆 Beheerste Ritmes (${stats.masteredRhythms}/${stats.totalRhythms})</h3>
                </div>
                <div class="card-body">
                    <div class="progress-bar mb-3">
                        <div class="progress-fill" style="width: ${(stats.masteredRhythms / stats.totalRhythms) * 100}%"></div>
                    </div>
                    ${AppState.user.masteredRhythms.length > 0 ? `
                        <div class="rhythm-grid">
                            ${AppState.user.masteredRhythms.map(rhythmId => {
                                const rhythm = ECGDatabase.getRhythmById(rhythmId);
                                if (!rhythm) return '';
                                return `
                                    <button class="rhythm-btn" onclick="ECGApp.showRhythmDetail('${rhythmId}')">
                                        <span class="rhythm-indicator green"></span>
                                        <span>${rhythm.name}</span>
                                        <span>✓</span>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <p class="text-muted text-center">Nog geen ritmes beheerst. Blijf oefenen!</p>
                    `}
                </div>
            </div>
        `;
    };

    Sections.renderAchievements = function(container) {
        const unlocked = Achievements.getUnlocked();
        const locked = Achievements.getLocked();

        container.innerHTML = `
            <div class="card mb-2">
                <div class="card-header">
                    <h3 class="card-title">🏆 Prestaties (${unlocked.length}/${Achievements.definitions.length})</h3>
                </div>
                <div class="card-body">
                    <div class="progress-bar mb-3">
                        <div class="progress-fill" style="width: ${(unlocked.length / Achievements.definitions.length) * 100}%"></div>
                    </div>
                    <p class="text-muted text-center mb-3">
                        Totaal verdiend: ${unlocked.reduce((sum, a) => sum + a.xpReward, 0)} XP via prestaties
                    </p>
                </div>
            </div>

            <!-- Unlocked Achievements -->
            ${unlocked.length > 0 ? `
                <div class="card mb-2">
                    <div class="card-header">
                        <h3 class="card-title">✅ Behaald</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-3">
                            ${unlocked.map(achievement => `
                                <div class="achievement-card unlocked">
                                    <div class="achievement-card-icon">${achievement.icon}</div>
                                    <div class="achievement-card-name">${achievement.name}</div>
                                    <div class="achievement-card-desc">${achievement.description}</div>
                                    <div class="achievement-card-reward">+${achievement.xpReward} XP</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}

            <!-- Locked Achievements -->
            ${locked.length > 0 ? `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🔒 Nog te Behalen</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-3">
                            ${locked.map(achievement => `
                                <div class="achievement-card locked">
                                    <div class="achievement-card-icon">🔒</div>
                                    <div class="achievement-card-name">${achievement.name}</div>
                                    <div class="achievement-card-desc">${achievement.description}</div>
                                    <div class="achievement-card-reward">+${achievement.xpReward} XP</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
    };

    Sections.renderSettings = function(container) {
        container.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">⚙️ Instellingen</h3>
                </div>
                <div class="card-body">
                    <div class="info-box info mb-3">
                        <div class="info-box-icon">🧭</div>
                        <div class="info-box-content">
                            <h4>Richtlijnmodus</h4>
                            <p>ERC/ESC standaard actief. Volg altijd lokale protocollen bij klinische besluitvorming.</p>
                        </div>
                    </div>

                    <!-- Profile Management -->
                    <h4 style="margin-bottom: 1rem;">👤 Profielen</h4>
                    <div class="settings-group">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Actief profiel</div>
                                <div class="setting-desc">Huidig profiel: <strong>${AppState.profile?.name || 'Standaard'}</strong></div>
                            </div>
                            <button class="btn btn-outline btn-sm" onclick="ECGApp.switchProfile()">
                                🔁 Wisselen
                            </button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Nieuw profiel</div>
                                <div class="setting-desc">Maak een extra lokaal profiel met eigen voortgang</div>
                            </div>
                            <button class="btn btn-outline btn-sm" onclick="ECGApp.createProfile()">
                                ➕ Aanmaken
                            </button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Profiel hernoemen</div>
                                <div class="setting-desc">Pas de naam van het actieve profiel aan</div>
                            </div>
                            <button class="btn btn-outline btn-sm" onclick="ECGApp.renameCurrentProfile()">
                                ✏️ Hernoemen
                            </button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Profiel verwijderen</div>
                                <div class="setting-desc">Verwijder alleen het actieve profiel (minimaal 1 profiel blijft bestaan)</div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="ECGApp.deleteCurrentProfile()">
                                🗑️ Verwijderen
                            </button>
                        </div>
                    </div>

                    <!-- Quiz Settings -->
                    <h4 style="margin-bottom: 1rem;">🎯 Quiz Instellingen</h4>
                    <div class="settings-group">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Standaard aantal vragen</div>
                                <div class="setting-desc">Aantal vragen bij een standaard quiz</div>
                            </div>
                            <select onchange="ECGApp.updateSetting('defaultQuizCount', this.value)">
                                <option value="5" ${AppState.settings?.defaultQuizCount === 5 ? 'selected' : ''}>5</option>
                                <option value="10" ${AppState.settings?.defaultQuizCount === 10 || !AppState.settings?.defaultQuizCount ? 'selected' : ''}>10</option>
                                <option value="20" ${AppState.settings?.defaultQuizCount === 20 ? 'selected' : ''}>20</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Timer (tijdsdruk)</div>
                                <div class="setting-desc">Seconden per vraag in tijdsdrukmodus</div>
                            </div>
                            <select onchange="ECGApp.updateSetting('timerSeconds', this.value)">
                                <option value="20" ${AppState.settings?.timerSeconds === 20 ? 'selected' : ''}>20s</option>
                                <option value="30" ${AppState.settings?.timerSeconds === 30 || !AppState.settings?.timerSeconds ? 'selected' : ''}>30s</option>
                                <option value="45" ${AppState.settings?.timerSeconds === 45 ? 'selected' : ''}>45s</option>
                                <option value="60" ${AppState.settings?.timerSeconds === 60 ? 'selected' : ''}>60s</option>
                            </select>
                        </div>
                    </div>

                    <!-- Monitor Settings -->
                    <h4 style="margin: 2rem 0 1rem;">📺 Monitor Instellingen</h4>
                    <div class="settings-group">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">ECG Snelheid</div>
                                <div class="setting-desc">Papiersnelheid in mm/s</div>
                            </div>
                            <select onchange="ECGApp.updateSetting('ecgSpeed', this.value)">
                                <option value="12.5" ${AppState.monitor?.speed === 12.5 ? 'selected' : ''}>12.5 mm/s</option>
                                <option value="25" ${AppState.monitor?.speed === 25 || !AppState.monitor?.speed ? 'selected' : ''}>25 mm/s</option>
                                <option value="50" ${AppState.monitor?.speed === 50 ? 'selected' : ''}>50 mm/s</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">ECG Amplitude</div>
                                <div class="setting-desc">Signaalversterking</div>
                            </div>
                            <select onchange="ECGApp.updateSetting('ecgAmplitude', this.value)">
                                <option value="0.5" ${AppState.monitor?.amplitude === 0.5 ? 'selected' : ''}>0.5x</option>
                                <option value="1" ${AppState.monitor?.amplitude === 1 || !AppState.monitor?.amplitude ? 'selected' : ''}>1x</option>
                                <option value="2" ${AppState.monitor?.amplitude === 2 ? 'selected' : ''}>2x</option>
                            </select>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <h4 style="margin: 2rem 0 1rem;">💾 Data Beheer</h4>
                    <div class="settings-group">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Exporteer Voortgang</div>
                                <div class="setting-desc">Download voortgang van het actieve profiel als JSON bestand</div>
                            </div>
                            <button class="btn btn-outline btn-sm" onclick="ECGApp.exportData()">
                                📤 Exporteren
                            </button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Importeer Voortgang</div>
                                <div class="setting-desc">Herstel back-up in het actieve profiel</div>
                            </div>
                            <button class="btn btn-outline btn-sm" onclick="ECGApp.importData()">
                                📥 Importeren
                            </button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Reset Voortgang</div>
                                <div class="setting-desc">Wis voortgang van het actieve profiel en begin opnieuw</div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="ECGApp.resetProgress()">
                                🗑️ Reset
                            </button>
                        </div>
                    </div>

                    <!-- About -->
                    <h4 style="margin: 2rem 0 1rem;">ℹ️ Over</h4>
                    <div class="info-box info">
                        <div class="info-box-icon">🫀</div>
                        <div class="info-box-content">
                            <h4>ECG Trainer Pro v2.0</h4>
                            <p>Een uitgebreide ECG leerapp voor IC/SEH verpleegkundigen en medisch professionals.</p>
                            <p style="margin-top: 0.5rem;">
                                <strong>Bevat:</strong> ${ECGDatabase.getAllRhythms().length} ECG ritmes, 
                                ${Object.keys(ECGDatabase.categories).length} categorieën, 
                                ${Achievements.definitions.length} prestaties
                            </p>
                            <p style="margin-top: 0.5rem; font-size: 0.85rem;" class="text-muted">
                                ⚠️ Disclaimer: Deze app is bedoeld voor educatieve doeleinden en vervangt geen lokale protocollen, supervisie of klinisch oordeel. 
                                Volg altijd het geldende ziekenhuis-/ambulanceprotocol.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    };

    // ==================== ADDITIONAL APP METHODS ====================
    
    // Add settings methods to ECGApp
    ECGApp.updateSetting = function(key, value) {
        if (!AppState.settings) AppState.settings = {};
        
        // Parse numeric values
        const numValue = parseFloat(value);
        AppState.settings[key] = isNaN(numValue) ? value : numValue;
        
        // Apply certain settings immediately
        if (key === 'ecgSpeed') {
            AppState.monitor.speed = numValue;
        } else if (key === 'ecgAmplitude') {
            AppState.monitor.amplitude = numValue;
        } else if (key === 'defaultQuizCount') {
            AppState.settings.defaultQuizCount = parseInt(value, 10) || 10;
        } else if (key === 'timerSeconds') {
            AppState.settings.timerSeconds = parseInt(value, 10) || 30;
        }
        
        Storage.save();
    };

    ECGApp.exportData = function() {
        const data = {
            version: '2.0',
            exportDate: new Date().toISOString(),
            profile: AppState.profile,
            user: AppState.user,
            settings: AppState.settings,
            learningPath: AppState.learningPath
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        const safeProfileName = (AppState.profile?.name || 'profiel')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        a.href = url;
        a.download = `ecg-trainer-${safeProfileName || 'profiel'}-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        
        this.showModal('✅ Export Voltooid', `
            <div class="info-box success">
                <div class="info-box-icon">📤</div>
                <div class="info-box-content">
                    <p>Je voortgang is gedownload als JSON bestand.</p>
                    <p class="text-muted" style="margin-top: 0.5rem;">Bewaar dit bestand veilig om later te kunnen herstellen.</p>
                </div>
            </div>
        `);
    };

    ECGApp.importData = function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (!data.user) {
                        throw new Error('Ongeldig back-upbestand');
                    }
                    
                    // Merge data
                    if (data.profile?.name) {
                        AppState.profile.name = data.profile.name;
                    }
                    AppState.user = { ...AppState.user, ...data.user };
                    if (data.settings) {
                        AppState.settings = data.settings;
                    }
                    if (data.learningPath) {
                        AppState.learningPath = {
                            ...AppState.learningPath,
                            ...data.learningPath,
                            dailyRoundState: {
                                ...AppState.learningPath.dailyRoundState,
                                ...(data.learningPath.dailyRoundState || {})
                            },
                            checklistTraining: {
                                ...AppState.learningPath.checklistTraining,
                                ...(data.learningPath.checklistTraining || {})
                            }
                        };
                    }
                    LearningPathEngine.syncState();
                    
                    Storage.save();
                    
                    this.showModal('✅ Import Voltooid', `
                        <div class="info-box success">
                            <div class="info-box-icon">📥</div>
                            <div class="info-box-content">
                                <p>Je voortgang is succesvol hersteld!</p>
                                <p class="text-muted" style="margin-top: 0.5rem;">De pagina wordt ververst om de wijzigingen toe te passen.</p>
                            </div>
                        </div>
                    `, [
                        { text: 'Ververs Pagina', class: 'btn-primary', action: () => location.reload() }
                    ]);
                    
                } catch (error) {
                    this.showModal('❌ Import Mislukt', `
                        <div class="info-box danger">
                            <div class="info-box-icon">⚠️</div>
                            <div class="info-box-content">
                                <p>Kon het bestand niet importeren.</p>
                                <p class="text-muted" style="margin-top: 0.5rem;">${error.message}</p>
                            </div>
                        </div>
                    `);
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    };

    // ==================== EXTEND NAVIGATION ====================
    
    // Update navigation items to include new sections
    Navigation.sections = {
        dashboard: { title: 'Dashboard', icon: '🏠', render: Sections.renderDashboard },
        monitor: { title: 'Monitor Simulator', icon: '📺', render: Sections.renderMonitor },
        learningPath: { title: 'Leerpad', icon: '🧭', render: Sections.renderLearningPath },
        library: { title: 'ECG Bibliotheek', icon: '📚', render: Sections.renderLibrary },
        systematic: { title: 'Systematische Analyse', icon: '📋', render: Sections.renderSystematic },
        quiz: { title: 'Quizmodus', icon: '🎯', render: Sections.renderQuiz },
        cases: { title: 'Klinische Cases', icon: '🏥', render: Sections.renderCases },
        acls: { title: 'ACLS Protocollen', icon: '🚨', render: Sections.renderACLS },
        drugs: { title: 'Medicatie', icon: '💊', render: Sections.renderDrugs },
        criteria: { title: 'Criteria', icon: '📏', render: Sections.renderCriteria },
        progress: { title: 'Voortgang', icon: '📊', render: Sections.renderProgress },
        achievements: { title: 'Prestaties', icon: '🏆', render: Sections.renderAchievements },
        settings: { title: 'Instellingen', icon: '⚙️', render: Sections.renderSettings }
    };

    // ==================== PERIODIC CHECKS ====================
    
    // Check achievements periodically
    setInterval(() => {
        if (AppState.user.totalAnswered > 0) {
            Achievements.checkAchievements();
        }
    }, 30000); // Every 30 seconds

    // Auto-save periodically
    setInterval(() => {
        Storage.save();
    }, 60000); // Every minute

    // ==================== FINAL INITIALIZATION ====================
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => ECGApp.init());
    } else {
        ECGApp.init();
    }

    // Expose to global scope for onclick handlers
    window.ECGApp = ECGApp;
    window.Navigation = Navigation;

</script>
</body>
</html>

